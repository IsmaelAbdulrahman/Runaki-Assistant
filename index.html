<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runaki Assistant App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting (kept for potential future use, but not actively used in this version) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--neutral-gray-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        h1 {
            color: var(--primary-blue);
            font-weight: 800;
            margin-bottom: 2.5rem; /* Increased margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--neutral-gray-dark);
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            text-align: left;
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max width for simplified layout */
            background-color: var(--card-background);
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); /* Stronger, diffused shadow */
        }

        .section-card {
            background-color: var(--card-background);
            border: 1px solid var(--neutral-gray-light);
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--neutral-gray-medium);
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--neutral-gray-light);
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: #fcfdff; /* Very light input background */
            color: var(--neutral-gray-dark);
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); /* Soft blue glow on focus */
            outline: none;
        }

        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: 1px solid var(--neutral-gray-medium); /* Added border for definition */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Default text color for buttons */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Default light gray background */
            width: 100%; /* Make buttons wide */
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker gray on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Even darker gray on active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr)); /* Slightly larger min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
        }

        .result-item {
            background-color: #e0f2fe; /* Lighter blue for result items */
            border: 1px solid #bfdbfe;
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: #4b5563; /* Slightly darker gray for result labels */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            color: var(--error-red); /* Consistent strong red for emphasis */
            font-size: 1.25rem; /* Larger font for values */
        }
    </style>
</head>
<body>

    <h1 class="text-3xl lg:text-4xl">Runaki Assistant App</h1>

    <div class="main-container">
        <!-- Manual Calculation -->
        <div class="section-card">
            <h2 class="text-xl">1. Manual Calculation</h2>
            <div class="input-group">
                <label for="categoryDropdown">Category:</label>
                <select id="categoryDropdown" class="p-2 border rounded-md">
                    <option value="Household">Household</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Agriculture">Agriculture</option>
                    <option value="Industrial">Industrial</option>
                    <option value="Large Industry">Large Industry</option>
                    <option value="State">State</option>
                </select>
                <label for="manualInputTypeDropdown">Input:</label>
                <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                    <option value="kWh">kWh</option>
                    <option value="Avg Amperes">Avg Amperes</option>
                    <option value="Given Bill">Given Bill (IQD)</option> <!-- Changed text here -->
                </select>
                <input type="number" id="manualInput" value="1891" class="w-28">
            </div>
            <button id="calculateManualButton" class="btn w-full">Calculate Bill</button>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Consumption</div>
                    <div class="result-value" id="manualKwh">0.00 kWh</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Avg Amperes</div>
                    <div class="result-value" id="manualAmperes">0.00 A</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Bill</div>
                    <div class="result-value" id="manualBill">0 IQD</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Avg Rate</div>
                    <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                </div>
            </div>
            <button id="manualReportButton" class="btn w-full mt-6">Generate Report</button>
        </div>

        <!-- By Meter Calculation -->
        <div class="section-card">
            <h2 class="text-xl">2. By Meter Calculation</h2>
            <div class="input-group">
                <label for="meterPrevReading">Prev Reading:</label>
                <input type="number" id="meterPrevReading" value="31051" class="w-24">
                <label for="meterCurrReading">Curr Reading:</label>
                <input type="number" id="meterCurrReading" value="31910" class="w-24">
                <label for="daysInput">Days:</label>
                <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16">
            </div>
            <button id="calculateMeterButton" class="btn w-full">Calculate Bill</button>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Consumption</div>
                    <div class="result-value" id="meterKwh">0.00 kWh</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Avg Amperes</div>
                    <div class="result-value" id="meterAmperes">0.00 A</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Bill</div>
                    <div class="result-value" id="meterBill">0 IQD</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Avg Rate</div>
                    <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                </div>
            </div>
            <button id="meterReportButton" class="btn w-full mt-6">Generate Report</button>
        </div>
    </div>

    <footer class="mt-8 text-center text-neutral-gray-medium text-sm">
        <p>Created by Dr. Ismael Abdulrahman</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL CONSTANTS ---
            const VOLTAGE = 220;
            const HOURS_PER_DAY = 24;

            // --- UI ELEMENTS ---
            const categoryDropdown = document.getElementById('categoryDropdown');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const manualInput = document.getElementById('manualInput');
            const calculateManualButton = document.getElementById('calculateManualButton');
            const manualReportButton = document.getElementById('manualReportButton');

            const manualKwhElem = document.getElementById('manualKwh');
            const manualAmperesElem = document.getElementById('manualAmperes');
            const manualBillElem = document.getElementById('manualBill');
            const manualAvgRateElem = document.getElementById('manualAvgRate');

            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const meterPrevReading = document.getElementById('meterPrevReading');
            const meterCurrReading = document.getElementById('meterCurrReading');
            const daysInput = document.getElementById('daysInput');

            const meterKwhElem = document.getElementById('meterKwh');
            const meterAmperesElem = document.getElementById('meterAmperes');
            const meterBillElem = document.getElementById('meterBill');
            const meterAvgRateElem = document.getElementById('meterAvgRate');
            const meterReportButton = document.getElementById('meterReportButton');

            // --- UTILITY FUNCTIONS ---
            const formatNumber = (value, decimalPlaces = 2, isCurrency = false, removeTrailingZeroDecimal = false) => {
                try {
                    const num = parseFloat(value);
                    if (isNaN(num)) return String(value);
                    if (isCurrency) return Math.round(num).toLocaleString('en-US');
                    if (removeTrailingZeroDecimal && num === parseInt(num)) return parseInt(num).toLocaleString('en-US');
                    return num.toLocaleString('en-US', {
                        minimumFractionDigits: decimalPlaces,
                        maximumFractionDigits: decimalPlaces,
                    });
                } catch (e) {
                    console.error("Error formatting number:", e);
                    return String(value);
                }
            };

            const validateNumeric = (textInput) => {
                if (typeof textInput !== 'string') textInput = String(textInput);
                const cleanInput = textInput.replace(/,/g, '');
                if (!cleanInput.trim()) return 0.0;
                const value = parseFloat(cleanInput);
                return isNaN(value) ? 0.0 : value;
            };

            const kwhToAmperes = (kwh, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (kwh * 1000) / (VOLTAGE * hoursTotal);
            };

            const amperesToKwh = (amperes, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (amperes * VOLTAGE * hoursTotal) / 1000;
            };

            // --- TARIFF CALCULATION LOGIC (KURDISTAN RUNAKI SYSTEM) ---
            const getRonakiHouseholdTariffDetails = (kWh) => {
                const tiers = [400, 800, 1200, 1600];
                const rates = [72, 108, 175, 265, 350];
                const slabNames = ["1-400 kWh", "401-800 kWh", "801-1200 kWh", "1201-1600 kWh", "1601+ kWh"];

                let totalCost = 0;
                let remainingKwh = kWh;
                const breakdown = [];
                let previousSlabLimit = 0;

                for (let i = 0; i < rates.length; i++) {
                    if (remainingKwh <= 0) break;

                    const slabRate = rates[i];
                    const slabLimit = (i < tiers.length) ? tiers[i] : Infinity;
                    const slabName = slabNames[i];

                    let consumptionInThisSlab = 0;
                    if (i === 0) {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit);
                    } else {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit - previousSlabLimit);
                    }

                    if (consumptionInThisSlab > 0) {
                        const costInThisSlab = consumptionInThisSlab * slabRate;
                        totalCost += costInThisSlab;
                        breakdown.push(`  - Slab ${i + 1} (${slabName}): ${formatNumber(consumptionInThisSlab, 2)} kWh @ ${formatNumber(slabRate, 2)} IQD/kWh = ${formatNumber(costInThisSlab, 0, true)} IQD`);
                    }
                    remainingKwh -= consumptionInThisSlab;
                    previousSlabLimit = slabLimit;
                }
                return { totalCost, breakdown: breakdown.join("\n") };
            };

            const getRonakiFlatTariffDetails = (kWh, rate) => {
                const totalCost = kWh * rate;
                const breakdown = `  - Consumption: ${formatNumber(kWh, 2)} kWh @ ${formatNumber(rate, 2)} IQD/kWh = ${formatNumber(totalCost, 0, true)} IQD`;
                return { totalCost, breakdown };
            };

            const calculateCostForCategory = (consumption, category) => {
                if (category === 'Household') {
                    return getRonakiHouseholdTariffDetails(consumption).totalCost;
                } else if (category === 'Commercial') {
                    return getRonakiFlatTariffDetails(consumption, 185).totalCost;
                } else if (category === 'Agriculture') {
                    return getRonakiFlatTariffDetails(consumption, 60).totalCost;
                } else if (category === 'Industrial') {
                    return getRonakiFlatTariffDetails(consumption, 160).totalCost;
                } else if (category === 'Large Industry') {
                    return getRonakiFlatTariffDetails(consumption, 125).totalCost;
                } else if (category === 'State') {
                    return getRonakiFlatTariffDetails(consumption, 160).totalCost;
                } else {
                    console.error(`Unknown category for cost calculation: ${category}`);
                    return NaN;
                }
            };

            // --- UI UPDATE FUNCTIONS ---
            const updateResultDisplay = (kwh, amperes, bill, avgRate, kwhElem, amperesElem, billElem, avgRateElem) => {
                kwhElem.textContent = `${formatNumber(kwh, 2)} kWh`;
                amperesElem.textContent = `${formatNumber(amperes, 2)} A`;
                billElem.textContent = `${formatNumber(bill, 0, true)} IQD`;
                avgRateElem.textContent = `${formatNumber(avgRate, 2)} IQD/kWh`;
            };

            // --- MAIN CALCULATION HANDLER ---
            const performManualCalculation = () => {
                let inputValue = validateNumeric(manualInput.value);
                if (isNaN(inputValue) || inputValue < 0) {
                    alert("Please enter a valid numeric value for consumption.");
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem);
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;
                let calculatedKwh = 0;
                let calculatedAmperes = 0;
                let totalBill = 0;

                if (manualInputTypeDropdown.value === 'kWh') {
                    calculatedKwh = inputValue;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Avg Amperes') {
                    calculatedAmperes = inputValue;
                    calculatedKwh = amperesToKwh(calculatedAmperes, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Given Bill') {
                    const targetBill = inputValue;
                    let lowKwh = 0;
                    let highKwh = 50000; 
                    let foundKwh = 0;
                    const tolerance = 1.0;

                    for (let i = 0; i < 100; i++) { 
                        const midKwh = (lowKwh + highKwh) / 2;
                        const calculatedBillAtMid = calculateCostForCategory(midKwh, category);

                        if (Math.abs(calculatedBillAtMid - targetBill) < tolerance) {
                            foundKwh = midKwh;
                            break;
                        } else if (calculatedBillAtMid < targetBill) {
                            lowKwh = midKwh;
                        } else {
                            highKwh = midKwh;
                        }
                    }
                    calculatedKwh = foundKwh;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = targetBill; 
                }

                const avgRate = calculatedKwh > 0 ? totalBill / calculatedKwh : 0;

                updateResultDisplay(calculatedKwh, calculatedAmperes, totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem);
            };

            const performMeterCalculation = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0) {
                    alert("Please enter valid numeric values for meter readings.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }
                if (currReading < prevReading) {
                    alert("Current reading cannot be less than previous reading.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }
                if (isNaN(daysVal) || daysVal <= 0) {
                    alert("Please enter a positive integer for days.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;

                updateResultDisplay(consumption, avgAmperes, totalBill, avgRate, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
            };

            // --- REPORT GENERATION FUNCTIONS ---
            const generateManualReport = () => {
                const kwh = validateNumeric(manualKwhElem.textContent);
                const bill = validateNumeric(manualBillElem.textContent);
                const category = categoryDropdown.value;
                if (kwh <= 0) { alert("Please perform a calculation first."); return; }
                const { breakdown } = getRonakiHouseholdTariffDetails(kwh); 
                alert(`Detailed Report (Manual Input)\n---------------------------------\nConsumption: ${manualKwhElem.textContent}\nAverage Amperes: ${manualAmperesElem.textContent}\nTotal Bill: ${manualBillElem.textContent}\nAverage Rate: ${manualAvgRateElem.textContent}\nCategory: ${category}\n\nTariff Breakdown:\n${breakdown}`);
            };

            const generateMeterReport = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0 || currReading < prevReading || isNaN(daysVal) || daysVal <= 0) {
                    alert("Please ensure valid meter readings and days are entered before generating a report.");
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;

                let reportContent = `Detailed Report (Meter Input)\n---------------------------------\n`;
                reportContent += `Previous Reading: ${formatNumber(prevReading, 0, true)} kWh\n`;
                reportContent += `Current Reading: ${formatNumber(currReading, 0, true)} kWh\n`;
                reportContent += `Days: ${formatNumber(daysVal, 0, false, true)}\n`;
                reportContent += `Consumption: ${formatNumber(consumption, 2)} kWh\n`;
                reportContent += `Average Amperes: ${formatNumber(avgAmperes, 2)} A\n`;
                reportContent += `Total Bill: ${formatNumber(totalBill, 0, true)} IQD\n`;
                reportContent += `Average Rate: ${formatNumber(avgRate, 2)} IQD/kWh\n`;
                reportContent += `Category: ${category}\n\n`;

                if (category === 'Household') {
                    const { breakdown } = getRonakiHouseholdTariffDetails(consumption);
                    reportContent += `Tariff Breakdown:\n${breakdown}`;
                } else {
                    const { breakdown } = getRonakiFlatTariffDetails(consumption, totalBill / consumption);
                    reportContent += `Tariff Breakdown:\n${breakdown}`;
                }
                alert(reportContent);
            };

            // --- EVENT LISTENERS ---
            manualInputTypeDropdown.addEventListener('change', (e) => {
                const type = e.target.value;
                if (type === 'kWh') manualInput.value = '1891';
                else if (type === 'Avg Amperes') manualInput.value = '12';
                else if (type === 'Given Bill') manualInput.value = '100000';
                performManualCalculation();
            });

            calculateManualButton.addEventListener('click', performManualCalculation);
            manualInput.addEventListener('change', performManualCalculation); 
            manualInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performManualCalculation(); });
            categoryDropdown.addEventListener('change', performManualCalculation);

            calculateMeterButton.addEventListener('click', performMeterCalculation);
            meterPrevReading.addEventListener('change', performMeterCalculation);
            meterPrevReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            meterCurrReading.addEventListener('change', performMeterCalculation);
            meterCurrReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            daysInput.addEventListener('change', () => {
                performManualCalculation(); 
                performMeterCalculation(); 
            });
            daysInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') {
                performManualCalculation();
                performMeterCalculation();
            }});

            manualReportButton.addEventListener('click', generateManualReport);
            meterReportButton.addEventListener('click', generateMeterReport);

            // --- INITIALIZATION CALLS ---
            performManualCalculation();
            performMeterCalculation();
        });
    </script>
</body>
</html>
