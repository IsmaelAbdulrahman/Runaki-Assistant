<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Runaki Bill Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Reduced base font size */
        html {
            font-size: 16px;
        }
        
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6;
            --secondary-green: #22c55e;
            --accent-orange: #f97316;
            --accent-purple: #8b5cf6;
            --neutral-gray-dark: #374151;
            --neutral-gray-medium: #6b7280;
            --neutral-gray-light: #e5e7eb;
            --background-light: #f9fafb;
            --card-background: #ffffff;
            --highlight-yellow: #facc15;
            --error-red: #ef4444;

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c;
            --card-dark: #2d3748;
            --text-light: #e2e8f0;
            --text-medium-light: #a0aec0;
            --input-dark-bg: #4a5568;
            --input-dark-border: #6b7280;
            --result-item-dark-bg: #3c4a5c;
            --result-item-dark-border: #5a6a7c;
            --primary-blue-darker: #2563eb;
            --highlight-yellow-dark: #fbbf24;
            
            /* Dynamic colors for result displays */
            --manual-result-color: #fef08a;
            --manual-highlight-color: #fbbf24;
            --meter-result-color: #bbf7d0;
            --meter-highlight-color: #86efac;
            --device-result-color: #a7f3d0;
            --device-highlight-color: #5eead4;
            --optimization-result-color: #bfdbfe;
            --optimization-highlight-color: #93c5fd;
        }

        /* Custom styles for better aesthetics and responsiveness */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            margin: 0;
            padding: 0;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            touch-action: pan-x pan-y;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            /* Reduced font size */
            font-size: clamp(0.8rem, 3.2vw, 1rem);
        }

        /* RTL specific styles */
        body.rtl {
            direction: rtl;
        }
        body.rtl h1,
        body.rtl h2,
        body.rtl .section-card,
        body.rtl footer {
            text-align: right;
        }
        body.rtl .text-left {
            text-align: right;
        }
        body.rtl .items-start {
            align-items: flex-end;
        }
        body.rtl .modal-close-button {
            right: unset;
            left: 1rem;
        }
        
        /* Language selector styling - made more compact */
        .lang-btn {
            transition: background-color 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            width: 3.2rem; /* Reduced width */
            height: 2.5rem; /* Reduced height */
            font-weight: bold;
            font-size: 0.9rem; /* Reduced font size */
        }
        .lang-btn.active {
            border-color: var(--primary-blue);
            background-color: var(--input-dark-bg);
            color: white;
        }
        .lang-btn:not(.active) {
            background-color: var(--card-dark);
            color: var(--text-medium-light);
        }

        /* Reduced heading sizes */
        h1 {
            color: white;
            font-weight: 800;
            margin: 1rem 0; /* Reduced margin */
            text-align: center;
            font-size: clamp(1.5rem, 5.5vw, 2.5rem); /* Smaller font */
            padding: 0.5rem 0;
        }

        h2 {
            color: var(--text-light);
            font-weight: 700;
            margin-bottom: 0.5rem; /* Reduced margin */
            font-size: clamp(1.2rem, 4.5vw, 1.6rem); /* Smaller font */
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Reduced gap */
            width: 100%;
            max-width: 100%;
            background-color: var(--card-dark);
            padding: 0.75rem; /* Reduced padding */
            flex: 1;
            box-sizing: border-box;
        }

        .section-card {
            background-color: var(--card-dark);
            border: 1px solid var(--input-dark-border);
            border-radius: 0.75rem;
            padding: 0.75rem; /* Reduced padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem; /* Reduced gap */
            margin-bottom: 0.8rem; /* Reduced margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light);
            flex-shrink: 0;
            font-size: clamp(0.85rem, 3.2vw, 1rem); /* Smaller font */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.4rem; /* Reduced padding */
            border: 1px solid var(--input-dark-border);
            border-radius: 0.5rem;
            font-size: clamp(0.85rem, 3.2vw, 1rem); /* Smaller font */
            text-align: center;
            background-color: var(--input-dark-bg);
            color: var(--text-light);
            flex-grow: 1;
            min-width: 4.5rem; /* Reduced min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            outline: none;
        }

        /* General button styling - made more compact */
        button {
            padding: 0.4rem 0.8rem; /* Reduced padding */
            border-radius: 0.5rem;
            border: none;
            font-size: clamp(0.85rem, 3.2vw, 1rem); /* Smaller font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            color: var(--button-dark-text);
            margin: 0.2rem; /* Reduced margin */
            background-color: var(--button-light-gray);
            width: 100%;
        }

        button.btn-action {
            color: var(--highlight-yellow-dark);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0.95;
            background-color: var(--button-hover-gray);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray);
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(6.5rem, 1fr)); /* Wider items */
            gap: 0.4rem; /* Reduced gap */
            font-size: clamp(0.85rem, 3.2vw, 1rem); /* Smaller font */
            margin-top: 0.4rem; /* Reduced margin */
            width: 100%;
        }

        .result-item {
            background-color: var(--result-item-dark-bg);
            border: 1px solid var(--result-item-dark-border);
            border-radius: 0.5rem;
            padding: 0.6rem; /* Reduced padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07);
        }

        .result-label {
            color: var(--text-medium-light);
            margin-bottom: 0.2rem;
            font-weight: 500;
            font-size: clamp(0.75rem, 3.2vw, 0.9rem); /* Smaller font */
        }

        .result-value {
            font-weight: 800;
            color: var(--current-result-color); 
            font-size: clamp(0.9rem, 3.2vw, 1.2rem); /* Smaller font */
            transition: color 0.2s ease-in-out;
            /* Alignment adjustments */
            text-align: left;
        }
        
        /* RTL alignment for values */
        body.rtl .result-value {
            text-align: right;
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { color: var(--current-result-color); }
            16.6% { color: var(--current-highlight-color); }
            33.3% { color: var(--current-result-color); }
            50% { color: var(--current-highlight-color); }
            66.6% { color: var(--current-result-color); }
            83.3% { color: var(--current-highlight-color); }
            100% { color: var(--current-result-color); }
        }

        .flash-animation {
            animation: flashEffect 1.8s ease-out;
        }

        /* Chart container styling */
        .chart-container {
            width: 100%;
            height: 220px; /* Reduced height */
            margin-top: 0.8rem; /* Reduced margin */
            background-color: var(--card-dark); 
            border-radius: 0.75rem;
            padding: 0.8rem; /* Reduced padding */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 350px; /* Reduced max-height */
            border: 1px solid var(--input-dark-border);
            border-radius: 0.75rem;
            margin-bottom: 0.8rem; /* Reduced margin */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .device-table th, .device-table td {
            padding: 0.4rem; /* Reduced padding */
            border-bottom: 1px solid var(--input-dark-border);
            text-align: center;
            font-size: clamp(0.75rem, 2.8vw, 0.9rem); /* Smaller font */
        }

        .device-table th {
            background-color: var(--input-dark-bg);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light);
        }

        .device-table tbody tr:hover {
            background-color: #3a475c;
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640;
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker);
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.25rem; /* Reduced padding */
            border: 1px solid var(--input-dark-border);
            border-radius: 0.3rem;
            text-align: center;
            font-size: clamp(0.75rem, 2.8vw, 0.9rem); /* Smaller font */
            background-color: var(--input-dark-bg);
            color: var(--text-light);
        }

        .device-table input[type="checkbox"] {
            width: 1.1rem; /* Slightly smaller */
            height: 1.1rem;
            cursor: pointer;
            border-radius: 0.2rem;
            accent-color: var(--primary-blue-darker);
        }

        .device-table .output-cell {
            background-color: #2a3a4c;
            font-weight: 600;
            color: var(--primary-blue-darker);
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
            
            .input-group {
                gap: 0.25rem; /* Smaller gap */
            }
            
            .section-card {
                padding: 0.6rem; /* Smaller padding */
            }
        }

        /* Toggle buttons container */
        .toggle-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 0.4rem; /* Smaller gap */
            margin-top: 0.4rem; /* Smaller margin */
            padding: 0.4rem; /* Smaller padding */
            border: 1px solid var(--input-dark-border);
            border-radius: 0.5rem;
            width: 100%;
        }
        
        /* Responsive adjustments for very small screens */
        @media (max-width: 480px) {
            .result-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                width: 100%;
            }
            
            .modal-content {
                padding: 0.6rem; /* Smaller padding */
            }
            
            .lang-btn {
                width: 2.8rem; /* Smaller */
                height: 2.3rem;
                font-size: 0.85rem;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            body {
                /* Fix for iOS address bar */
                min-height: -webkit-fill-available;
            }
        }

        /* NEW: Language selector positioning */
        #languageSelectorTop {
            position: relative;
            margin: 0 auto 1rem auto; /* Reduced bottom margin */
            width: fit-content;
        }
    </style>
</head>
<body>

    <h1 class="text-3xl lg:text-4xl">Runaki Bill Assistant</h1>

    <div id="languageSelectorTop" class="mb-4 flex justify-center gap-2">
        <button id="lang-en" class="lang-btn">En</button>
        <button id="lang-ar" class="lang-btn">عربي</button>
        <button id="lang-ku" class="lang-btn">کوردی</button>
    </div>

    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-3">

            <!-- 1. Manual Calculation -->
            <div class="section-card" id="manualCalculationSection">
                <h2 class="text-xl">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household">Household</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Government">Government</option>
                    </select>
                    <label for="manualInputTypeDropdown">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh">kWh</option>
                        <option value="Avg Amperes">Avg Amperes</option>
                        <option value="Given Bill">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn btn-action">Calculate Bill</button>
                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="manualAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="manualReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>

            <!-- 2. By Meter Calculation -->
            <div class="section-card" id="meterCalculationSection" style="display: none;">
                <h2 class="text-xl">2. By Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterPrevReading">Prev Reading:</label>
                    <input type="number" id="meterPrevReading" value="31051" class="w-24">
                    <label for="meterCurrReading">Curr Reading:</label>
                    <input type="number" id="meterCurrReading" value="31910" class="w-24">
                    <label for="daysInput">Days:</label>
                    <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16" readonly>
                </div>
                <button id="calculateMeterButton" class="btn btn-action">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Equivalent</div>
                        <div class="result-value" id="meterMonthlyEquivalent">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="meterAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="meterReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>
            
            <!-- New buttons for showing/hiding sections -->
            <div class="toggle-buttons-container">
                <button id="toggleManualCalculationButton" class="btn">Hide Manual Calculation</button>
                <button id="toggleMeterCalculationButton" class="btn">Show By Meter Calculation</button>
                <button id="toggleTableButton" class="btn">Show Device Table</button>
                <button id="toggleBudgetOptimizationButton" class="btn">Show Budget Optimization</button>
                <button id="showTariffDetailsButton" class="btn">Show Tariff Details</button>
            </div>

            <!-- 3. Budget Optimization -->
            <div class="section-card" id="budgetOptimizationSection" style="display: none;">
                <h2 class="text-xl">3. Budget Optimization</h2>
                <div class="input-group">
                    <select id="optimizationTargetDropdown" class="p-2 border rounded-md">
                        <option value="Target Cost">Target Cost</option>
                        <option value="Target Amperes">Target Amperes</option>
                        <option value="Target kWh">Target kWh</option>
                    </select>
                    <input type="number" id="budgetLimitInput" value="100000" class="w-32">
                </div>
                <button id="optimizeBudgetButton" class="btn btn-action">Optimize Target</button>
                <div class="result-grid" id="budgetOptimizationResultGrid">
                    <div class="result-item col-span-full">
                        <div class="result-label">Optimization Result</div>
                        <div class="result-value" id="budgetResultLabel">Not Optimized</div>
                    </div>
                </div>
            </div>

            <!-- 4. Device Consumption Table -->
            <div class="section-card flex-grow" id="deviceTableSection" style="display: none;">
                <h2 class="text-xl">4. Device Consumption Table</h2>
                <div class="device-table-container">
                    <table id="deviceTable" class="device-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Watt</th>
                                <th>Hours</th>
                                <th>Day</th>
                                <th>Count</th>
                                <th>kWh</th>
                                <th>IQD</th>
                                <th>On</th>
                                <th>Fixed</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap items-start gap-2 mt-4">
                    <button id="addRowButton" class="btn">Add Row</button>
                    <button id="deleteRowButton" class="btn">Delete Selected</button>
                    <button id="saveTableButton" class="btn">Save Data (CSV)</button>
                    <label for="loadFileInput" class="btn cursor-pointer">Load Data (CSV)<input type="file" id="loadFileInput" accept=".csv" class="hidden"></label>
                    <button id="clearAllButton" class="btn">Clear All</button>
                </div>
                <button id="deviceReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>

        </div>
    </div>

    <footer class="mt-4 text-center text-neutral-gray-medium text-sm">
        <button id="aboutButton" class="btn">About</button>
    </footer>

    <!-- Custom Modal for Tariff Details -->
    <div id="tariffDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeTariffDetailsModal">&times;</button>
            <h3 id="tariffDetailsModalTitle">Tariff Details</h3>
            <div id="householdTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="householdTariffChart"></canvas>
            </div>
            <div id="commercialTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="commercialTariffChart"></canvas>
            </div>
            <div id="otherCategoriesTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="otherCategoriesTariffChart"></canvas>
            </div>
            <pre id="tariffDetailsModalContent"></pre>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeAboutModal">&times;</button>
            <h3>About</h3>
            <p>Created by Dr. Ismael Abdulrahman</p>
            <p class="text-sm">ismael.abdulrahman@epu.edu.iq</p>
        </div>
    </div>

    <!-- Custom Modal for Reports -->
    <div id="reportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeReportModal">&times;</button>
            <h3 id="reportModalTitle">Report</h3>
            <div id="reportModalContent" class="prose"></div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="appMessage" class=""></div>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- LANGUAGE TRANSLATION ---
            const translations = {
                en: {
                    appTitle: "Runaki Bill Assistant",
                    mainTitle: "Runaki Bill Assistant",
                    manualCalculationTitle: "1. Manual Calculation",
                    categoryLabel: "Category:",
                    householdOption: "Household",
                    commercialOption: "Commercial",
                    agricultureOption: "Agriculture",
                    industrialOption: "Industrial",
                    governmentOption: "Government",
                    inputLabel: "Input:",
                    kwhOption: "kWh",
                    avgAmperesOption: "Avg Amperes",
                    givenBillOption: "Given Bill (IQD)",
                    calculateBillButton: "Calculate Bill",
                    billLabel: "Bill",
                    consumptionLabel: "Consumption",
                    monthlyEquivalentLabel: "Monthly Equivalent",
                    avgAmperesLabel: "Avg Amperes",
                    avgRateLabel: "Avg Rate",
                    generateReportButton: "Generate Report",
                    meterCalculationTitle: "2. By Meter Calculation",
                    prevReadingLabel: "Prev Reading:",
                    currReadingLabel: "Curr Reading:",
                    daysLabel: "Days:",
                    hideManualCalculation: "Hide Manual Calculation",
                    showManualCalculation: "Show Manual Calculation",
                    showMeterCalculation: "Show By Meter Calculation",
                    hideMeterCalculation: "Hide By Meter Calculation",
                    showDeviceTable: "Show Device Table",
                    hideDeviceTable: "Hide Device Table",
                    showBudgetOptimization: "Show Budget Optimization",
                    hideBudgetOptimization: "Hide Budget Optimization",
                    showTariffDetails: "Show Tariff Details",
                    deviceConsumptionTableTitle: "4. Device Consumption Table",
                    deviceHeader: "Device",
                    wattHeader: "Watt",
                    hoursHeader: "Hours",
                    dayHeader: "Day",
                    countHeader: "Count",
                    kwhHeader: "kWh",
                    iqdHeader: "IQD",
                    onHeader: "On",
                    fixedHeader: "Fixed",
                    addRowButton: "Add Row",
                    deleteSelectedButton: "Delete Selected",
                    saveDataCSVButton: "Save Data (CSV)",
                    loadDataCSVButton: "Load Data (CSV)",
                    clearAllButton: "Clear All",
                    budgetOptimizationTitle: "3. Budget Optimization",
                    targetCostOption: "Target Cost",
                    targetAmperesOption: "Target Amperes",
                    targetKwhOption: "Target kWh",
                    optimizeTargetButton: "Optimize Target",
                    optimizationResultLabel: "Optimization Result",
                    notOptimized: "Not Optimized",
                    aboutButton: "About",
                    aboutModalTitle: "About",
                    createdBy: "Created by Dr. Ismael Abdulrahman",
                    // Messages
                    enterValidNumeric: "Please enter a valid numeric value for consumption.",
                    currentReadingLessThanPrevious: "Current reading cannot be less than previous reading.",
                    enterPositiveDays: "Please enter a positive integer for days.",
                    performCalculationFirst: "Please perform a calculation first.",
                    ensureValidMeterReadings: "Please ensure valid meter readings and days are entered before generating a report.",
                    addAndCalculateDeviceConsumption: "Please add and calculate device consumption before generating a report.",
                    csvEmpty: "CSV file is empty or corrupted.",
                    deviceDataSaved: "Device data saved to CSV successfully!",
                    deviceDataLoaded: "Device data loaded from CSV successfully!",
                    errorLoadingData: "Error loading data: {error}. Please ensure it's a valid CSV file.",
                    selectRowToDelete: "Please select a row to delete.",
                    allDeviceDataCleared: "All device data has been cleared and reset to default.",
                    invalidTarget: "Invalid Target",
                    withinTarget: "Result: Within Target!",
                    currentStatusWithinTarget: "Your current status is already within the specified target!",
                    optimizationCompleted: "Optimization completed successfully!",
                    unreachable: "Result: Unreachable",
                    couldNotReachTarget: "Could not reach the target by only reducing hours of variable devices.",
                    // Report specific labels
                    manualCalculationSummary: "Manual Calculation Summary",
                    meterCalculationSummary: "Meter Calculation Summary",
                    overallConsumptionSummary: "Overall Consumption Summary",
                    tariffBreakdown: "Tariff Breakdown",
                    deviceBreakdown: "Device Breakdown",
                    device: "Device",
                    watt: "Watt",
                    hoursPerDay: "Hours/Day",
                    daysPerMonth: "Days/Month",
                    count: "Count",
                    kwhPerMonth: "kWh/Month",
                    iqdPerMonth: "IQD/Month",
                    onQuestion: "On?",
                    fixedQuestion: "Fixed?",
                    category: "Category",
                    previousReading: "Previous Reading",
                    currentReading: "Current Reading",
                    days: "Days",
                    totalBill: "Total Bill",
                    totalConsumption: "Total Consumption",
                    averageAmperes: "Average Amperes",
                    averageRate: "Average Rate",
                    // Tariff details
                    householdTariffRates: "Household Tariff Rates (IQD/kWh)",
                    commercialTariffRates: "Commercial Tariff Rates (IQD/kWh)",
                    otherCategoriesTariffRates: "Other Categories Tariff Rates (IQD/kWh)",
                    rate: "Rate (IQD/kWh)",
                    consumptionTiers: "Consumption Tiers",
                    consumption: "Consumption",
                    iqdPerKwh: "IQD/kWh",
                    slab: "Slab",
                    // Units
                    unitIQD: "IQD",
                    unitKWH: "kWh",
                    unitA: "A",
                    yes: "Yes",
                    no: "No",
                    // Device Names
                    deviceNames: {
                        ledTv: "LED TV",
                        refrigerator: "Refrigerator",
                        washingMachine: "Washing Machine",
                        ledLighting: "LED Lighting",
                        freezer: "Freezer",
                        waterPump: "Water Pump",
                        waterHeater: "Water Heater",
                        airCooler: "Air Cooler",
                        fan: "Fan",
                        dishwasher: "Dishwasher",
                        waterDispenser: "Water Dispenser",
                        splitAc1Ton: "Split AC (1 ton)",
                        splitAc1_5Ton: "Split AC (1.5 ton)",
                        splitAc2Ton: "Split AC (2 ton)",
                        towerAc: "Tower AC",
                        electricHeater: "Electric Heater",
                        iron: "Iron",
                        microwave: "Microwave",
                        electricKettle: "Electric Kettle",
                        hairDryer: "Hair Dryer",
                        vacuumCleaner: "Vacuum Cleaner",
                        electricOven: "Electric Oven",
                        phoneCharger: "Phone Charger",
                        desktopPc: "Desktop PC",
                        pcMonitor: "PC Monitor",
                        newDevice: "New Device"
                    }
                },
                ar: {
                    appTitle: "مساعد فواتير روناكي",
                    mainTitle: "مساعد فواتير روناكي",
                    manualCalculationTitle: "1. الحساب اليدوي",
                    categoryLabel: "الفئة:",
                    householdOption: "منزلي",
                    commercialOption: "تجاري",
                    agricultureOption: "زراعي",
                    industrialOption: "صناعي",
                    governmentOption: "حكومي",
                    inputLabel: "الإدخال:",
                    kwhOption: "كيلوواط ساعة",
                    avgAmperesOption: "متوسط الأمبير",
                    givenBillOption: "الفاتورة المعطاة (دينار عراقي)",
                    calculateBillButton: "حساب الفاتورة",
                    billLabel: "الفاتورة",
                    consumptionLabel: "الاستهلاك",
                    monthlyEquivalentLabel: "المعادل الشهري",
                    avgAmperesLabel: "متوسط الأمبير",
                    avgRateLabel: "متوسط السعر",
                    generateReportButton: "إنشاء تقرير",
                    meterCalculationTitle: "2. الحساب بالعداد",
                    prevReadingLabel: "القراءة السابقة:",
                    currReadingLabel: "القراءة الحالية:",
                    daysLabel: "الأيام:",
                    hideManualCalculation: "إخفاء الحساب اليدوي",
                    showManualCalculation: "إظهار الحساب اليدوي",
                    showMeterCalculation: "إظهار الحساب بالعداد",
                    hideMeterCalculation: "إخفاء الحساب بالعداد",
                    showDeviceTable: "إظهار جدول الأجهزة",
                    hideDeviceTable: "إخفاء جدول الأجهزة",
                    showBudgetOptimization: "إظهار تحسين الميزانية",
                    hideBudgetOptimization: "إخفاء تحسين الميزانية",
                    showTariffDetails: "إظهار تفاصيل التعرفة",
                    deviceConsumptionTableTitle: "4. جدول استهلاك الأجهزة",
                    deviceHeader: "الجهاز",
                    wattHeader: "واط",
                    hoursHeader: "الساعات",
                    dayHeader: "اليوم",
                    countHeader: "العدد",
                    kwhHeader: "كيلوواط ساعة",
                    iqdHeader: "دينار عراقي",
                    onHeader: "تشغيل",
                    fixedHeader: "ثابت",
                    addRowButton: "إضافة صف",
                    deleteSelectedButton: "حذف المحدد",
                    saveDataCSVButton: "حفظ البيانات (CSV)",
                    loadDataCSVButton: "تحميل البيانات (CSV)",
                    clearAllButton: "مسح الكل",
                    budgetOptimizationTitle: "3. تحسين الميزانية",
                    targetCostOption: "التكلفة المستهدفة",
                    targetAmperesOption: "الأمبير المستهدف",
                    targetKwhOption: "كيلوواط ساعة المستهدفة",
                    optimizeTargetButton: "تحسين الهدف",
                    optimizationResultLabel: "نتيجة التحسين",
                    notOptimized: "لم يتم التحسين",
                    aboutButton: "حول",
                    aboutModalTitle: "حول",
                    createdBy: "تم الإنشاء بواسطة د. إسماعيل خورشيد عبدالرحمن",
                    // Messages
                    enterValidNumeric: "الرجاء إدخال قيمة رقمية صالحة للاستهلاك.",
                    currentReadingLessThanPrevious: "لا يمكن أن تكون القراءة الحالية أقل من القراءة السابقة.",
                    enterPositiveDays: "الرجاء إدخال عدد صحيح موجب للأيام.",
                    performCalculationFirst: "الرجاء إجراء عملية حساب أولاً.",
                    ensureValidMeterReadings: "الرجاء التأكد من إدخال قراءات عداد وأيام صالحة قبل إنشاء التقرير.",
                    addAndCalculateDeviceConsumption: "الرجاء إضافة وحساب استهلاك الجهاز قبل إنشاء التقرير.",
                    csvEmpty: "ملف CSV فارغ أو تالف.",
                    deviceDataSaved: "تم حفظ بيانات الجهاز إلى CSV بنجاح!",
                    deviceDataLoaded: "تم تحميل بيانات الجهاز من CSV بنجاح!",
                    errorLoadingData: "خطأ في تحميل البيانات: {error}. يرجى التأكد من أنه ملف CSV صالح.",
                    selectRowToDelete: "الرجاء تحديد صف لحذفه.",
                    allDeviceDataCleared: "تم مسح جميع بيانات الجهاز وإعادة تعيينها إلى الافتراضي.",
                    invalidTarget: "هدف غير صالح",
                    withinTarget: "النتيجة: ضمن الهدف!",
                    currentStatusWithinTarget: "وضعك الحالي ضمن الهدف المحدد بالفعل!",
                    optimizationCompleted: "اكتمل التحسين بنجاح!",
                    unreachable: "النتيجة: لا يمكن الوصول إليه",
                    couldNotReachTarget: "تعذر الوصول إلى الهدف عن طريق تقليل ساعات الأجهزة المتغيرة فقط.",
                    // Report specific labels
                    manualCalculationSummary: "ملخص الحساب اليدوي",
                    meterCalculationSummary: "ملخص الحساب بالعداد",
                    overallConsumptionSummary: "ملخص الاستهلاك الكلي",
                    tariffBreakdown: "تفاصيل التعرفة",
                    deviceBreakdown: "تفاصيل الجهاز",
                    device: "الجهاز",
                    watt: "واط",
                    hoursPerDay: "ساعات/يوم",
                    daysPerMonth: "أيام/شهر",
                    count: "العدد",
                    kwhPerMonth: "كيلوواط ساعة",
                    iqdPerMonth: "دينار عراقي",
                    onQuestion: "تشغيل؟",
                    fixedQuestion: "ثابت؟",
                    category: "الفئة",
                    previousReading: "القراءة السابقة",
                    currentReading: "القراءة الحالية",
                    days: "الأيام",
                    totalBill: "إجمالي الفاتورة",
                    totalConsumption: "إجمالي الاستهلاك",
                    averageAmperes: "متوسط الأمبير",
                    averageRate: "متوسط السعر",
                    // Tariff details
                    householdTariffRates: "أسعار تعرفة المنازل (دينار عراقي/كيلوواط ساعة)",
                    commercialTariffRates: "أسعار التعرفة التجارية (دينار عراقي/كيلوواط ساعة)",
                    otherCategoriesTariffRates: "أسعار تعرفة الفئات الأخرى (دينار عراقي/كيلوواط ساعة)",
                    rate: "السعر (دينار عراقي/كيلوواط ساعة)",
                    consumptionTiers: "شرائح الاستهلاك",
                    consumption: "الاستهلاك",
                    iqdPerKwh: "دينار عراقي/كيلوواط ساعة",
                    slab: "شريحة",
                    // Units
                    unitIQD: "دينار عراقي",
                    unitKWH: "كيلوواط ساعة",
                    unitA: "أمبير",
                    yes: "نعم",
                    no: "لا",
                    // Device Names
                    deviceNames: {
                        ledTv: "تلفزيون LED",
                        refrigerator: "ثلاجة",
                        washingMachine: "غسالة",
                        ledLighting: "إضاءة LED",
                        freezer: "فريزر",
                        waterPump: "مضخة مياه",
                        waterHeater: "سخان مياه",
                        airCooler: "مبرد هواء",
                        fan: "مروحة",
                        dishwasher: "غسالة صحون",
                        waterDispenser: "موزع مياه",
                        splitAc1Ton: "مكيف سبليت (1 طن)",
                        splitAc1_5Ton: "مكيف سبليت (1.5 طن)",
                        splitAc2Ton: "مكيف سبليت (2 طن)",
                        towerAc: "مكيف برج",
                        electricHeater: "سخان كهربائي",
                        iron: "مكواة",
                        microwave: "ميكروويف",
                        electricKettle: "غلاية كهربائية",
                        hairDryer: "مجفف شعر",
                        vacuumCleaner: "مكنسة كهربائية",
                        electricOven: "فرن كهربائي",
                        phoneCharger: "شاحن هاتف",
                        desktopPc: "كمبيوتر مكتبي",
                        pcMonitor: "شاشة كمبيوتر",
                        newDevice: "جهاز جديد"
                    }
                },
                ku: {
                    appTitle: "یارمەتیدەری بیلی روناکی",
                    mainTitle: "یارمەتیدەری بیلی روناکی",
                    manualCalculationTitle: "1. ژماردنی دەستی",
                    categoryLabel: "پۆلێن:",
                    householdOption: "ماڵان",
                    commercialOption: "بازرگانی",
                    agricultureOption: "کشتوکاڵ",
                    industrialOption: "پیشەسازی",
                    governmentOption: "حکومی",
                    inputLabel: "دانان:",
                    kwhOption: "کیلۆوات کاتژمێر",
                    avgAmperesOption: "تێکڕای ئەمپێر",
                    givenBillOption: "بیلی دراو (دينار عراقي)",
                    calculateBillButton: "ژماردنی بیل",
                    billLabel: "بیل",
                    consumptionLabel: "بەکارهێنان",
                    monthlyEquivalentLabel: "هاوتای مانگانە",
                    avgAmperesLabel: "تێکڕای ئەمپێر",
                    avgRateLabel: "تێکڕای نرخ",
                    generateReportButton: "دروستکردنی ڕاپۆرت",
                    meterCalculationTitle: "2. ژماردن بە پێوەری کارەبا",
                    prevReadingLabel: "خوێندنەوەی پێشوو:",
                    currReadingLabel: "خوێندنەوەی ئێستا:",
                    daysLabel: "ڕۆژەکان:",
                    hideManualCalculation: "شاردنەوەی ژماردنی دەستی",
                    showManualCalculation: "پیشاندانی ژماردنی دەستی",
                    showMeterCalculation: "پیشاندانی ژماردن بە پێوەری کارەبا",
                    hideMeterCalculation: "شاردنەوەی ژماردن بە پێوەر",
                    showDeviceTable: "پیشاندانی خشتەی ئامێرەکان",
                    hideDeviceTable: "شاردنەوەی خشتەی ئامێرەکان",
                    showBudgetOptimization: "پیشاندانی باشترکردنی بودجە",
                    hideBudgetOptimization: "شاردنەوەی باشترکردنی بودجە",
                    showTariffDetails: "پیشاندانی وردەکارییەکانی تاریف",
                    deviceConsumptionTableTitle: "4. خشتەی بەکارهێنانی ئامێر",
                    deviceHeader: "ئامێر",
                    wattHeader: "وات",
                    hoursHeader: "کاتژمێر",
                    dayHeader: "ڕۆژ",
                    countHeader: "ژمارە",
                    kwhHeader: "کیلۆوات کاتژمێر",
                    iqdHeader: "دينار عراقي",
                    onHeader: "کارا",
                    fixedHeader: "جێگیر",
                    addRowButton: "زیادکردنی ڕیز",
                    deleteSelectedButton: "سڕینەوەی هەڵبژێردراو",
                    saveDataCSVButton: "پاشەکەوتکردنی داتا (CSV)",
                    loadDataCSVButton: "بارکردنی داتا (CSV)",
                    clearAllButton: "پاککردنەوەی هەموو",
                    budgetOptimizationTitle: "3. باشترکردنی بودجە",
                    targetCostOption: "تێچووی ئامانج",
                    targetAmperesOption: "ئەمپێری ئامانج",
                    targetKwhOption: "کیلۆوات کاتژمێری ئامانج",
                    optimizeTargetButton: "باشترکردنی ئامانج",
                    optimizationResultLabel: "ئەنجامی باشترکردن",
                    notOptimized: "باشتر نەکراوە",
                    aboutButton: "زیاتر",
                    aboutModalTitle: "زیاتر",
                    createdBy: "دروستکراوە لەلایەن د. إسماعیل خورشيد عبدالرحمن",
                    // Messages
                    enterValidNumeric: "تکایە بەهایەکی ژمارەیی دروست بۆ بەکارهێنان بنووسە.",
                    currentReadingLessThanPrevious: "خوێندنەوەی ئێستا ناتوانێت کەمتر بێت لە خوێندنەوەی پێشوو.",
                    enterPositiveDays: "تکایە ژمارەیەکی تەواوی پۆزەتیڤ بۆ ڕۆژەکان بنووسە.",
                    performCalculationFirst: "تکایە سەرەتا ژماردنێک ئەنجام بدە.",
                    ensureValidMeterReadings: "تکایە دڵنیا بە لەوەی خوێندنەوەی پێوەر و ڕۆژەکان دروستن پێش دروستکردنی ڕاپۆرت.",
                    addAndCalculateDeviceConsumption: "تکایە ئامێر زیاد بکە و بەکارهێنانەکەی بژمێرە پێش دروستکردنی ڕاپۆرت.",
                    csvEmpty: "فایلی CSV بەتاڵە یان تێکچووە.",
                    deviceDataSaved: "داتای ئامێر بە سەرکەوتوویی پاشەکەوت کرا بۆ CSV!",
                    deviceDataLoaded: "تم تحميل بيانات الجهاز من CSV بنجاح!",
                    errorLoadingData: "هەڵە لە بارکردنی داتا: {error}. تکایە دڵنیا بە لەوەی فایلی CSV دروستە.",
                    selectRowToDelete: "تکایە ڕیزێک هەڵبژێرە بۆ سڕینەوە.",
                    allDeviceDataCleared: "هەموو داتای ئامێر پاککرایەوە و گەڕێنرایەوە بۆ باری بنەڕەتی.",
                    invalidTarget: "ئامانجی نادروست",
                    withinTarget: "ئەنجام: لەناو ئامانجدا!",
                    currentStatusWithinTarget: "دۆخی ئێستات لەناو ئامانجی دیاریکراودا پاشەکەوت کراوە!",
                    optimizationCompleted: "باشترکردن بە سەرکەوتوویی تەواو بوو!",
                    unreachable: "ئەنجام: ناتوانرێت پێی بگات",
                    couldNotReachTarget: "نەتوانرا بگاتە ئامانج تەنها بە کەمکردنەوەی کاتژمێرەکانی ئامێرە گۆڕاوەکان.",
                    // Report specific labels
                    manualCalculationSummary: "کورتەی ژماردنی دەستی",
                    meterCalculationSummary: "کورتەی ژماردن بە پێوەر",
                    overallConsumptionSummary: "کورتەی گشتیی بەکارهێنان",
                    tariffBreakdown: "وردەکارییەکانی تاریف",
                    deviceBreakdown: "وردەکارییەکانی ئامێر",
                    device: "ئامێر",
                    watt: "وات",
                    hoursPerDay: "کاتژمێر/ڕۆژ",
                    daysPerMonth: "ڕۆژ/مانگ",
                    count: "ژمارە",
                    kwhPerMonth: "کیلۆوات کاتژمێر",
                    iqdPerMonth: "دينار عراقي",
                    onQuestion: "کارا؟",
                    fixedQuestion: "جێگیر؟",
                    category: "پۆلێن",
                    previousReading: "خوێندنەوەی پێشوو",
                    currentReading: "خوێندنەوەی ئێستا",
                    days: "ڕۆژەکان",
                    totalBill: "کۆی بیل",
                    totalConsumption: "کۆی بەکارهێنان",
                    averageAmperes: "تێکڕای ئەمپێر",
                    averageRate: "تێکڕای نرخ",
                    // Tariff details
                    householdTariffRates: "نرخی تاریفی ماڵان (دينار عراقي/کیلۆوات کاتژمێر)",
                    commercialTariffRates: "نرخی تاریفی بازرگانی (دينار عراقي/کیلۆوات کاتژمێر)",
                    otherCategoriesTariffRates: "نرخی تاریفی پۆلێنەکانی تر (دينار عراقي/کیلۆوات کاتژمێر)",
                    rate: "نرخ (دينار عراقي/کیلۆوات کاتژمێر)",
                    consumptionTiers: "پلەکانی بەکارهێنان",
                    consumption: "بەکارهێنان",
                    iqdPerKwh: "دينار عراقي/کیلۆوات کاتژمێر",
                    slab: "شریحه",
                    // Units
                    unitIQD: "دينار عراقي",
                    unitKWH: "کیلۆوات کاتژمێر",
                    unitA: "ئەمپێر",
                    yes: "بەڵێ",
                    no: "نەخێر",
                    // Device Names
                    deviceNames: {
                        ledTv: "تەلەفزیۆنی LED",
                        refrigerator: "ساردکەرەوە",
                        washingMachine: "جلشۆر",
                        ledLighting: "ڕووناککەرەوەی LED",
                        freezer: "فریزەر",
                        waterPump: "پەمپی ئاو",
                        waterHeater: "گەرمکەرەوەی ئاو",
                        airCooler: "فێنککەرەوەی هەوا",
                        fan: "پانکە",
                        dishwasher: "قاپشۆر",
                        waterDispenser: "دابەشکردنی ئاو",
                        splitAc1Ton: "ئەی سی سپلیت (1 تۆن)",
                        splitAc1_5Ton: "ئەی سی سپلیت (1.5 تۆن)",
                        splitAc2Ton: "ئەی سی سپلیت (2 تۆن)",
                        towerAc: "ئەی سی تاوەر",
                        electricHeater: "گەرمکەرەوەی کارەبایی",
                        iron: "ئوتوو",
                        microwave: "مایکرۆوەیڤ",
                        electricKettle: "گۆزەڵەی کارەبایی",
                        hairDryer: "وشککەرەوەی قژ",
                        vacuumCleaner: "پاککەرەوەی کارەبایی",
                        electricOven: "فڕنی کارەبایی",
                        phoneCharger: "شاحنی مۆبایل",
                        desktopPc: "کۆمپیوتەری مێز",
                        pcMonitor: "شاشەی کۆمپیوتەر",
                        newDevice: "ئامێری نوێ"
                    }
                }
            };

            const langEnBtn = document.getElementById('lang-en');
            const langArBtn = document.getElementById('lang-ar');
            const langKuBtn = document.getElementById('lang-ku');
            const langBtns = [langEnBtn, langArBtn, langKuBtn];
            let currentLang = 'en';

            const translatePage = (lang) => {
                currentLang = lang;
                const elements = document.querySelectorAll('[data-lang-key]');
                const body = document.body;

                // Set direction and text alignment
                if (lang === 'ar' || lang === 'ku') {
                    body.classList.add('rtl');
                } else {
                    body.classList.remove('rtl');
                }

                // Translate static text content
                elements.forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });

                // Translate options in dropdowns
                document.querySelectorAll('select').forEach(selectElement => {
                    Array.from(selectElement.options).forEach(option => {
                        const key = option.getAttribute('data-lang-key');
                        if (key && translations[lang] && translations[lang][key]) {
                            option.textContent = translations[lang][key];
                        }
                    });
                });

                // Update device table names
                Array.from(deviceTableBody.children).forEach(row => {
                    const nameInput = row.querySelector('.device-input[type="text"]');
                    const nameKey = nameInput.getAttribute('data-name-key');
                    if (nameKey && translations[lang].deviceNames[nameKey]) {
                        nameInput.value = translations[lang].deviceNames[nameKey];
                    }
                });

                // Update report modal content if it's open (re-generate it)
                if (reportModal.style.display === 'flex') {
                    const currentReportTitle = reportModalTitle.textContent;
                    // Check against all possible translated titles to determine which report to regenerate
                    if (currentReportTitle === translations.en.manualCalculationSummary ||
                        currentReportTitle === translations.ar.manualCalculationSummary ||
                        currentReportTitle === translations.ku.manualCalculationSummary) {
                        generateManualReport();
                    } else if (currentReportTitle === translations.en.meterCalculationSummary ||
                               currentReportTitle === translations.ar.meterCalculationSummary ||
                               currentReportTitle === translations.ku.meterCalculationSummary) {
                        generateMeterReport();
                    } else if (currentReportTitle === translations.en.overallConsumptionSummary ||
                               currentReportTitle === translations.ar.overallConsumptionSummary ||
                               currentReportTitle === translations.ku.overallConsumptionSummary) {
                        generateDeviceReport();
                    }
                }

                // Update tariff modal content if it's open (re-generate it)
                if (tariffDetailsModal.style.display === 'flex') {
                    showTariffDetails();
                }

                // Update button texts that toggle visibility
                const isManualVisible = manualCalculationSection.style.display === 'block';
                toggleManualCalculationButton.textContent = isManualVisible ? translations[lang].hideManualCalculation : translations[lang].showManualCalculation;
                
                const isMeterVisible = meterCalculationSection.style.display === 'block';
                toggleMeterCalculationButton.textContent = isMeterVisible ? translations[lang].hideMeterCalculation : translations[lang].showMeterCalculation;

                const isDeviceTableVisible = deviceTableSection.style.display === 'block';
                toggleTableButton.textContent = isDeviceTableVisible ? translations[lang].hideDeviceTable : translations[lang].showDeviceTable;

                const isBudgetOptimizationVisible = budgetOptimizationSection.style.display === 'block';
                toggleBudgetOptimizationButton.textContent = isBudgetOptimizationVisible ? translations[lang].hideBudgetOptimization : translations[lang].showBudgetOptimization;
            };

            const setActiveLanguage = (lang) => {
                langBtns.forEach(btn => btn.classList.remove('active'));
                if (lang === 'en') langEnBtn.classList.add('active');
                else if (lang === 'ar') langArBtn.classList.add('active');
                else if (lang === 'ku') langKuBtn.classList.add('active');
                translatePage(lang);
            };

            // --- GLOBAL CONSTANTS ---
            const VOLTAGE = 220;
            const HOURS_PER_DAY = 24;

            // --- UI ELEMENTS ---
            const categoryDropdown = document.getElementById('categoryDropdown');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const manualInput = document.getElementById('manualInput');
            const calculateManualButton = document.getElementById('calculateManualButton');
            const manualReportButton = document.getElementById('manualReportButton');

            const manualKwhElem = document.getElementById('manualKwh');
            const manualAmperesElem = document.getElementById('manualAmperes');
            const manualBillElem = document.getElementById('manualBill');
            const manualAvgRateElem = document.getElementById('manualAvgRate');
            const manualResultGrid = document.getElementById('manualResultGrid');

            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const meterPrevReading = document.getElementById('meterPrevReading');
            const meterCurrReading = document.getElementById('meterCurrReading');
            const daysInput = document.getElementById('daysInput');

            const meterKwhElem = document.getElementById('meterKwh');
            const meterMonthlyEquivalentElem = document.getElementById('meterMonthlyEquivalent');
            const meterAmperesElem = document.getElementById('meterAmperes');
            const meterBillElem = document.getElementById('meterBill');
            const meterAvgRateElem = document.getElementById('meterAvgRate');
            const meterReportButton = document.getElementById('meterReportButton');
            const meterResultGrid = document.getElementById('meterResultGrid');

            const optimizeBudgetButton = document.getElementById('optimizeBudgetButton');
            const optimizationTargetDropdown = document.getElementById('optimizationTargetDropdown');
            const budgetLimitInput = document.getElementById('budgetLimitInput');
            const budgetResultLabel = document.getElementById('budgetResultLabel');
            const budgetOptimizationResultGrid = document.getElementById('budgetOptimizationResultGrid');

            const deviceTableBody = document.querySelector("#deviceTable tbody");
            const addRowButton = document.getElementById('addRowButton');
            const deleteRowButton = document.getElementById('deleteRowButton');
            const saveTableButton = document.getElementById('saveTableButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const clearAllButton = document.getElementById('clearAllButton');
            const deviceReportButton = document.getElementById('deviceReportButton');
            const deviceTableSection = document.getElementById('deviceTableSection');

            // New UI element references for toggling visibility
            const toggleBudgetOptimizationButton = document.getElementById('toggleBudgetOptimizationButton'); 
            const toggleTableButton = document.getElementById('toggleTableButton');
            const showTariffDetailsButton = document.getElementById('showTariffDetailsButton'); 

            // Section elements
            const manualCalculationSection = document.getElementById('manualCalculationSection');
            const meterCalculationSection = document.getElementById('meterCalculationSection');
            const budgetOptimizationSection = document.getElementById('budgetOptimizationSection'); 
            
            // New toggle buttons for manual and meter sections
            const toggleManualCalculationButton = document.getElementById('toggleManualCalculationButton');
            const toggleMeterCalculationButton = document.getElementById('toggleMeterCalculationButton');

            // Modal elements (Tariff)
            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffDetailsModal = document.getElementById('closeTariffDetailsModal');
            const tariffDetailsModalTitle = document.getElementById('tariffDetailsModalTitle');
            const tariffDetailsModalContent = document.getElementById('tariffDetailsModalContent');
            const householdTariffChartContainer = document.getElementById('householdTariffChartContainer');
            const householdTariffChartCanvas = document.getElementById('householdTariffChart');
            const commercialTariffChartContainer = document.getElementById('commercialTariffChartContainer');
            const commercialTariffChartCanvas = document.getElementById('commercialTariffChart');
            const otherCategoriesTariffChartContainer = document.getElementById('otherCategoriesTariffChartContainer');
            const otherCategoriesTariffChartCanvas = document.getElementById('otherCategoriesTariffChart');
            let householdTariffChartInstance = null;
            let commercialTariffChartInstance = null;
            let otherCategoriesTariffChartInstance = null;

            // Modal elements (Report)
            const reportModal = document.getElementById('reportModal');
            const closeReportModal = document.getElementById('closeReportModal');
            const reportModalTitle = document.getElementById('reportModalTitle');
            const reportModalContent = document.getElementById('reportModalContent');

            // About modal elements
            const aboutModal = document.getElementById('aboutModal');
            const closeAboutModal = document.getElementById('closeAboutModal');
            const aboutButton = document.getElementById('aboutButton');

            // Message box element
            const appMessage = document.getElementById('appMessage');

            let selectedTableRow = null; 

            // Event listener for language selection change
            langEnBtn.addEventListener('click', () => setActiveLanguage('en'));
            langArBtn.addEventListener('click', () => setActiveLanguage('ar'));
            langKuBtn.addEventListener('click', () => setActiveLanguage('ku'));

            // --- UTILITY FUNCTIONS ---
            const formatNumber = (value, decimalPlaces = 2, isCurrency = false, removeTrailingZeroDecimal = false) => {
                try {
                    const num = parseFloat(value);
                    if (isNaN(num)) return String(value);
                    const lang = currentLang;
                    // UPDATED: Use 'ar-IQ' for both Arabic and Kurdish
                    const locale = (lang === 'ar' || lang === 'ku') ? 'ar-IQ' : 'en-US'; 

                    const options = {
                        minimumFractionDigits: decimalPlaces,
                        maximumFractionDigits: decimalPlaces,
                        useGrouping: false // Disable thousands separators (commas)
                    };

                    if (isCurrency) {
                        // For currency, we want no decimals, and no grouping
                        return Math.round(num).toLocaleString(locale, { useGrouping: false, minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    }
                    if (removeTrailingZeroDecimal && num === parseInt(num)) {
                        // For integers that should be displayed without decimals, and no grouping
                        return parseInt(num).toLocaleString(locale, { useGrouping: false, minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    }
                    return num.toLocaleString(locale, options);
                } catch (e) {
                    console.error("Error formatting number:", e);
                    return String(value);
                }
            };

            const convertArabicNumeralsToWestern = (input) => {
                if (typeof input !== 'string') return input;
                const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                const westernNumerals = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

                let output = input;
                for (let i = 0; i < arabicNumerals.length; i++) {
                    output = output.replace(new RegExp(arabicNumerals[i], 'g'), westernNumerals[i]);
                }
                return output;
            };

            const validateNumeric = (textInput) => {
                if (typeof textInput !== 'string') textInput = String(textInput);

                // Convert Arabic numerals to Western numerals first
                let cleanInput = convertArabicNumeralsToWestern(textInput);

                // Replace Arabic thousands separator (٬) and decimal separator (٫)
                cleanInput = cleanInput.replace(/٬/g, '').replace(/٫/g, '.'); // Arabic thousands comma, Arabic decimal point

                // Replace English thousands comma (,) 
                cleanInput = cleanInput.replace(/,/g, '');

                if (!cleanInput.trim()) return 0.0;
                const value = parseFloat(cleanInput);
                return isNaN(value) ? 0.0 : value;
            };

            const kwhToAmperes = (kwh, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (kwh * 1000) / (VOLTAGE * hoursTotal);
            };

            const amperesToKwh = (amperes, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (amperes * VOLTAGE * hoursTotal) / 1000;
            };

            // --- MESSAGE DISPLAY FUNCTION ---
            const showMessage = (messageKey, type = 'info', replacements = {}) => {
                const lang = currentLang;
                let message = translations[lang] && translations[lang][messageKey] ? translations[lang][messageKey] : messageKey;
                
                // Apply replacements
                for (const key in replacements) {
                    message = message.replace(`{${key}}`, replacements[key]);
                }

                appMessage.textContent = message;
                appMessage.className = ``; // Clear existing classes
                appMessage.classList.add(type, 'show');
                setTimeout(() => {
                    appMessage.classList.remove('show');
                }, 3000); // Message disappears after 3 seconds
            };

            // --- TARIFF CALCULATION LOGIC (IRAQI SYSTEM) ---
            const getIraqiTariffDetails = (kWh, category) => {
                const lang = currentLang;
                let totalCost = 0;
                let breakdown = [];
                let remainingKwh = kWh;
                
                let tiers, rates, slabNames;

                if (category === 'Household') {
                    // Updated household rates
                    tiers = [400, 800, 1200, 1600];
                    rates = [72, 108, 175, 265, 350];
                    slabNames = ["0-400 kWh", "401-800 kWh", "801-1200 kWh", "1201-1600 kWh", "1601+ kWh"];
                } else if (category === 'Commercial') {
                    // Updated business rate (flat)
                    tiers = [];
                    rates = [185];
                    slabNames = ["All consumption"];
                } else {
                    // Handle other categories with flat rates
                    let rate = 0;
                    if (category === 'Agriculture') rate = 60;
                    else if (category === 'Industrial') rate = 160;
                    else if (category === 'Government') rate = 160;
                    // Add Heavy Industry if needed (you may need to add it to your category dropdown)

                    totalCost = kWh * rate;
                    breakdown.push(`  - ${translations[lang].consumption}: ${formatNumber(kWh, 2)} ${translations[lang].unitKWH} @ ${formatNumber(rate, 2)} ${translations[lang].iqdPerKwh} = ${formatNumber(totalCost, 0, true)} ${translations[lang].unitIQD}`);
                    return { totalCost, breakdown: breakdown.join("\n") };
                }

                // Progressive calculation for tiered rates (household)
                let previousSlabLimit = 0;
                for (let i = 0; i < rates.length; i++) {
                    if (remainingKwh <= 0) break;

                    const slabRate = rates[i];
                    const slabLimit = (i < tiers.length) ? tiers[i] : Infinity;
                    const slabName = slabNames[i];

                    let consumptionInThisSlab = 0;
                    if (i === 0) {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit);
                    } else {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit - previousSlabLimit);
                    }

                    if (consumptionInThisSlab > 0) {
                        const costInThisSlab = consumptionInThisSlab * slabRate;
                        totalCost += costInThisSlab;
                        breakdown.push(`  - ${translations[lang].slab} ${i + 1} (${slabName}): ${formatNumber(consumptionInThisSlab, 2)} ${translations[lang].unitKWH} @ ${formatNumber(slabRate, 0)} ${translations[lang].iqdPerKwh} = ${formatNumber(costInThisSlab, 0, true)} ${translations[lang].unitIQD}`);
                    }
                    remainingKwh -= consumptionInThisSlab;
                    previousSlabLimit = slabLimit;
                }
                
                return { totalCost, breakdown: breakdown.join("\n") };
            };

            const calculateCostForCategory = (consumption, category) => {
                return getIraqiTariffDetails(consumption, category).totalCost;
            };

            // --- UI UPDATE FUNCTIONS ---

            const updateResultDisplay = (kwh, amperes, bill, avgRate, kwhElem, amperesElem, billElem, avgRateElem, resultGridElement, sectionType) => {
                // Set dynamic CSS variables for colors
                let resultColorVar, highlightColorVar;
                if (sectionType === 'manual') {
                    resultColorVar = 'var(--manual-result-color)';
                    highlightColorVar = 'var(--manual-highlight-color)';
                } else if (sectionType === 'meter') {
                    resultColorVar = 'var(--meter-result-color)';
                    highlightColorVar = 'var(--meter-highlight-color)';
                } else if (sectionType === 'device') {
                    resultColorVar = 'var(--device-result-color)';
                    highlightColorVar = 'var(--device-highlight-color)';
                } else if (sectionType === 'optimization') {
                    resultColorVar = 'var(--optimization-result-color)';
                    highlightColorVar = 'var(--optimization-highlight-color)';
                }

                resultGridElement.style.setProperty('--current-result-color', resultColorVar);
                resultGridElement.style.setProperty('--current-highlight-color', highlightColorVar);

                // Apply flashing animation
                [kwhElem, amperesElem, billElem, avgRateElem].forEach(elem => {
                    elem.classList.remove('flash-animation'); // Remove existing animation
                    void elem.offsetWidth; // Trigger reflow to restart animation
                    elem.classList.add('flash-animation'); // Add animation
                });
                const lang = currentLang;
                billElem.textContent = `${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}`; // Bill first
                kwhElem.textContent = `${formatNumber(kwh, 2)} ${translations[lang].unitKWH}`;
                amperesElem.textContent = `${formatNumber(amperes, 2)} ${translations[lang].unitA}`;
                avgRateElem.textContent = `${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}`;
            };

            // --- MAIN CALCULATION HANDLER ---
            const performManualCalculation = () => {
                let inputValue = validateNumeric(manualInput.value);
                if (isNaN(inputValue) || inputValue < 0) {
                    showMessage("enterValidNumeric", 'error');
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'manual');
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;
                let calculatedKwh = 0;
                let calculatedAmperes = 0;
                let totalBill = 0;

                if (manualInputTypeDropdown.value === 'kWh') {
                    calculatedKwh = inputValue;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Avg Amperes') {
                    calculatedAmperes = inputValue;
                    calculatedKwh = amperesToKwh(calculatedAmperes, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Given Bill') {
                    const targetBill = inputValue;
                    let lowKwh = 0;
                    let highKwh = 50000; 
                    let foundKwh = 0;
                    const tolerance = 1.0;

                    for (let i = 0; i < 100; i++) { 
                        const midKwh = (lowKwh + highKwh) / 2;
                        const calculatedBillAtMid = calculateCostForCategory(midKwh, category);

                        if (Math.abs(calculatedBillAtMid - targetBill) < tolerance) {
                            foundKwh = midKwh;
                            break;
                        } else if (calculatedBillAtMid < targetBill) {
                            lowKwh = midKwh;
                        } else {
                            highKwh = midKwh;
                        }
                    }
                    calculatedKwh = foundKwh;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = targetBill; 
                }

                const avgRate = calculatedKwh > 0 ? totalBill / calculatedKwh : 0;

                updateResultDisplay(calculatedKwh, calculatedAmperes, totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'manual');
            };

            const performMeterCalculation = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0) {
                    showMessage("ensureValidMeterReadings", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }
                if (currReading < prevReading) {
                    showMessage("currentReadingLessThanPrevious", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }
                if (isNaN(daysVal) || daysVal <= 0) {
                    showMessage("enterPositiveDays", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;
                
                // NEW: Monthly equivalent calculation
                const dailyAverage = consumption / daysVal;
                const monthlyEquivalent = dailyAverage * 30;

                // Update display with all values
                const lang = currentLang;
                meterBillElem.textContent = `${formatNumber(totalBill, 0, true)} ${translations[lang].unitIQD}`;
                meterKwhElem.textContent = `${formatNumber(consumption, 2)} ${translations[lang].unitKWH}`;
                meterMonthlyEquivalentElem.textContent = `${formatNumber(monthlyEquivalent, 2)} ${translations[lang].unitKWH}`;
                meterAmperesElem.textContent = `${formatNumber(avgAmperes, 2)} ${translations[lang].unitA}`;
                meterAvgRateElem.textContent = `${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}`;

                // Apply flashing animation
                [meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterMonthlyEquivalentElem].forEach(elem => {
                    elem.classList.remove('flash-animation');
                    void elem.offsetWidth;
                    elem.classList.add('flash-animation');
                });
            };

            const calculateDeviceConsumption = () => {
                let totalKwh = 0;
                const deviceDetails = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;
                const lang = currentLang;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const kwhOutputCell = row.querySelector('.output-kwh');
                    const iqdOutputCell = row.querySelector('.output-iqd');

                    if (!isOn) {
                        kwhOutputCell.textContent = '0.00';
                        iqdOutputCell.textContent = '0';
                        return;
                    }

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);

                    const kwh = (watt / 1000) * hours * day * count;
                    kwhOutputCell.textContent = formatNumber(kwh, 2);
                    totalKwh += kwh;
                    deviceDetails.push({ name: deviceName, kwh: kwh, row: row }); 
                });

                const totalBill = calculateCostForCategory(totalKwh, category);
                const avgRate = totalKwh > 0 ? totalBill / totalKwh : 0;

                deviceDetails.forEach(device => {
                    const iqd = device.kwh * avgRate;
                    device.row.querySelector('.output-iqd').textContent = formatNumber(iqd, 0, true);
                    device.iqd = iqd; 
                });
                // Update a dummy result grid for device consumption to trigger color change
                // We'll use the manualResultGrid for this as it's always visible and we need a target for the color change.
                updateResultDisplay(totalKwh, kwhToAmperes(totalKwh, daysVal), totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'device');
            };

            const optimizeForBudget = () => {
                let targetValue = validateNumeric(budgetLimitInput.value);
                if (isNaN(targetValue) || targetValue < 0) {
                    showMessage("enterValidNumeric", 'error');
                    budgetResultLabel.textContent = translations[currentLang].invalidTarget;
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization'); // Use dummy values for color update
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                let currentTotalKwh = 0;
                const variableDevicesData = [];
                const category = categoryDropdown.value;

                Array.from(deviceTableBody.children).forEach((row, idx) => {
                    const isOn = row.querySelector('.device-on').checked;
                    if (!isOn) return;

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;

                    const currentKwhDevice = (watt / 1000) * hours * day * count;
                    currentTotalKwh += currentKwhDevice;

                    if (!isFixed) { // Only consider variable devices for optimization
                        variableDevicesData.push({
                            index: idx,
                            name: deviceName,
                            initialKwh: currentKwhDevice,
                            watt, hours, day, count,
                            row: row 
                        });
                    }
                });

                const currentBill = calculateCostForCategory(currentTotalKwh, category);
                const currentAmperes = kwhToAmperes(currentTotalKwh, daysVal);
                const lang = currentLang;

                let targetKwhForOptimization = 0;
                if (optimizationTargetDropdown.value === 'Target Cost') {
                    if (currentBill > 0) {
                        targetKwhForOptimization = (targetValue / currentBill) * currentTotalKwh;
                    } else {
                        targetKwhForOptimization = targetValue / 100; 
                    }
                } else if (optimizationTargetDropdown.value === 'Target Amperes') {
                    targetKwhForOptimization = amperesToKwh(targetValue, daysVal);
                } else if (optimizationTargetDropdown.value === 'Target kWh') {
                    targetKwhForOptimization = targetValue;
                }

                if ((optimizationTargetDropdown.value === 'Target Cost' && currentBill <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target Amperes' && currentAmperes <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target kWh' && currentTotalKwh <= targetValue)) {
                    budgetResultLabel.textContent = translations[lang].withinTarget;
                    showMessage('currentStatusWithinTarget', 'info');
                    updateResultDisplay(currentTotalKwh, currentAmperes, currentBill, currentTotalKwh > 0 ? currentBill / currentTotalKwh : 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization');
                    return;
                }

                variableDevicesData.sort((a, b) => b.initialKwh - a.initialKwh);

                let optimizedConsumptionKwh = currentTotalKwh;
                let changesMade = false;

                for (const device of variableDevicesData) {
                    if (optimizedConsumptionKwh <= targetKwhForOptimization) break; 

                    const kwhPerHour = (device.watt / 1000) * device.day * device.count;
                    if (kwhPerHour <= 0) continue;

                    let currentDeviceHours = validateNumeric(device.row.querySelector('input[type="number"]').value);

                    while (currentDeviceHours > 0) {
                        const testHours = Math.max(0, currentDeviceHours - 1); 
                        const kwhReducedByHour = (currentDeviceHours - testHours) * kwhPerHour;
                        const potentialNewTotalConsumption = optimizedConsumptionKwh - kwhReducedByHour;

                        let potentialNewBill = calculateCostForCategory(potentialNewTotalConsumption, category);
                        let potentialNewAmperes = kwhToAmperes(potentialNewTotalConsumption, daysVal);

                        let canReduceFurther = false;
                        if ((optimizationTargetDropdown.value === 'Target Cost' && potentialNewBill <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target Amperes' && potentialNewAmperes <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target kWh' && potentialNewTotalConsumption <= targetValue)) {
                            canReduceFurther = true;
                        }

                        if (canReduceFurther || testHours === 0) { 
                            const hoursReduced = currentDeviceHours - testHours;
                            if (hoursReduced > 0) {
                                device.row.querySelector('input[type="number"]').value = formatNumber(testHours, 1, false, true); 
                                optimizedConsumptionKwh = potentialNewTotalConsumption;
                                changesMade = true;
                            }
                            break; 
                        } else {
                            currentDeviceHours = testHours; 
                        }
                    }
                }

                if (changesMade) {
                    budgetResultLabel.textContent = translations[lang].optimizationCompleted;
                    calculateDeviceConsumption(); // Recalculate device consumption to update table outputs
                    showMessage('optimizationCompleted', 'success');
                } else {
                    budgetResultLabel.textContent = translations[lang].unreachable;
                    showMessage('couldNotReachTarget', 'error');
                }
                // Update the optimization result display with the final (or current) values
                updateResultDisplay(optimizedConsumptionKwh, kwhToAmperes(optimizedConsumptionKwh, daysVal), calculateCostForCategory(optimizedConsumptionKwh, category), optimizedConsumptionKwh > 0 ? calculateCostForCategory(optimizedConsumptionKwh, category) / optimizedConsumptionKwh : 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization');
            };

            // --- DEVICE TABLE LOGIC ---
            const addTableRow = (deviceData = {}) => {
                const lang = currentLang;
                const defaultNameKey = deviceData.nameKey || 'newDevice';
                const data = {
                    nameKey: defaultNameKey,
                    name: translations[lang].deviceNames[defaultNameKey], 
                    watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false, ...deviceData
                };

                const row = deviceTableBody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${data.name}" class="device-input" data-name-key="${data.nameKey}"></td>
                    <td><input type="number" value="${data.watt}" class="device-input"></td>
                    <td><input type="number" value="${data.hours}" class="device-input" min="0" max="24"></td>
                    <td><input type="number" value="${data.day}" class="device-input" min="0" max="31"></td>
                    <td><input type="number" value="${data.count}" class="device-input" min="0"></td>
                    <td class="output-kwh output-cell">0.00</td>
                    <td class="output-iqd output-cell">0</td>
                    <td><input type="checkbox" class="device-on" ${data.on ? 'checked' : ''}></td>
                    <td><input type="checkbox" class="device-fixed" ${data.fixed ? 'checked' : ''}></td>
                `;

                row.querySelector('.device-on').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelector('.device-fixed').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelectorAll('.device-input').forEach(input => {
                    // Store the nameKey on the input itself for translation updates
                    if (input.type === 'text') {
                        input.setAttribute('data-name-key', data.nameKey);
                    }
                    input.addEventListener('change', () => calculateDeviceConsumption());
                });

                row.addEventListener('click', () => handleTableRowClick(row, Array.from(deviceTableBody.children).indexOf(row)));

                if (!data.on) row.classList.add('inactive'); 
            };

            const handleTableRowClick = (row, index) => {
                if (selectedTableRow) {
                    selectedTableRow.classList.remove('selected-row');
                }
                selectedTableRow = row;
                selectedTableRow.classList.add('selected-row');
            };

            const startupPopulateDeviceTable = () => {
                const sampleDevices = [
                    { nameKey: 'ledTv', watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'refrigerator', watt: '175', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { nameKey: 'washingMachine', watt: '2000', hours: '2', day: '4', count: '1', on: true, fixed: false },
                    { nameKey: 'ledLighting', watt: '12', hours: '12', day: '30', count: '20', on: true, fixed: false },
                    { nameKey: 'freezer', watt: '150', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { nameKey: 'waterPump', watt: '500', hours: '1', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'waterHeater', watt: '2500', hours: '1', day: '15', count: '1', on: false, fixed: false },
                    { nameKey: 'airCooler', watt: '250', hours: '18', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'fan', watt: '75', hours: '18', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'dishwasher', watt: '1800', hours: '2', day: '15', count: '1', on: true, fixed: false },
                    { nameKey: 'waterDispenser', watt: '175', hours: '2', day: '15', count: '1', on: true, fixed: false },
                    { nameKey: 'splitAc1Ton', watt: '1000', hours: '4', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'splitAc1_5Ton', watt: '1500', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'splitAc2Ton', watt: '2000', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'towerAc', watt: '3000', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'electricHeater', watt: '2000', hours: '6', day: '20', count: '1', on: false, fixed: false },
                    { nameKey: 'iron', watt: '1500', hours: '1', day: '8', count: '1', on: false, fixed: false },
                    { nameKey: 'microwave', watt: '1000', hours: '0.5', day: '15', count: '1', on: false, fixed: false },
                    { nameKey: 'electricKettle', watt: '1800', hours: '0.2', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'hairDryer', watt: '1600', hours: '0.2', day: '10', count: '1', on: false, fixed: false },
                    { nameKey: 'vacuumCleaner', watt: '1400', hours: '0.5', day: '4', count: '1', on: false, fixed: false },
                    { nameKey: 'electricOven', watt: '2500', hours: '1', day: '10', count: '1', on: false, fixed: false },
                    { nameKey: 'phoneCharger', watt: '10', hours: '8', day: '30', count: '2', on: false, fixed: true },
                    { nameKey: 'desktopPc', watt: '150', hours: '6', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'pcMonitor', watt: '40', hours: '6', day: '30', count: '1', on: false, fixed: false },
                ];
                
                deviceTableBody.innerHTML = ''; // Clear existing rows before populating
                sampleDevices.forEach(device => {
                    addTableRow(device);
                });
            };

            // --- REPORT GENERATION FUNCTIONS ---
            const generateReport = (calculationType) => {
                const lang = currentLang;
                let reportHtml = '';
                let kwh, bill, amperes, avgRate, category, breakdown;

                if (calculationType === 'manual') {
                    kwh = validateNumeric(manualKwhElem.textContent.replace(translations[lang].unitKWH, '').trim());
                    bill = validateNumeric(manualBillElem.textContent.replace(translations[lang].unitIQD, '').trim());
                    amperes = validateNumeric(manualAmperesElem.textContent.replace(translations[lang].unitA, '').trim());
                    avgRate = validateNumeric(manualAvgRateElem.textContent.replace(translations[lang].iqdPerKwh, '').trim());
                    category = categoryDropdown.value;
                    
                    reportHtml += `<div class="report-section-title">${translations[lang].manualCalculationSummary}</div>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].billLabel}:</span> <span class="report-item-value">${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].consumptionLabel}:</span> <span class="report-item-value">${formatNumber(kwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgAmperesLabel}:</span> <span class="report-item-value">${formatNumber(amperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgRateLabel}:</span> <span class="report-item-value">${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;
                
                } else if (calculationType === 'meter') {
                    const prevReading = validateNumeric(meterPrevReading.value);
                    const currReading = validateNumeric(meterCurrReading.value);
                    const daysVal = validateNumeric(daysInput.value) || 30;
                    category = categoryDropdown.value;
                    kwh = currReading - prevReading;
                    bill = calculateCostForCategory(kwh, category);
                    amperes = kwhToAmperes(kwh, daysVal);
                    avgRate = kwh > 0 ? bill / kwh : 0;
                    // NEW: Monthly equivalent calculation
                    const dailyAverage = kwh / daysVal;
                    const monthlyEquivalent = dailyAverage * 30;

                    reportHtml += `<div class="report-section-title">${translations[lang].meterCalculationSummary}</div>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].previousReading}:</span> <span class="report-item-value">${formatNumber(prevReading, 0, true)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].currentReading}:</span> <span class="report-item-value">${formatNumber(currReading, 0, true)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].days}:</span> <span class="report-item-value">${formatNumber(daysVal, 0, false, true)}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].billLabel}:</span> <span class="report-item-value">${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].consumptionLabel}:</span> <span class="report-item-value">${formatNumber(kwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].monthlyEquivalentLabel}:</span> <span class="report-item-value">${formatNumber(monthlyEquivalent, 2)} ${translations[lang].unitKWH}</span></p>`; // NEW
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgAmperesLabel}:</span> <span class="report-item-value">${formatNumber(amperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgRateLabel}:</span> <span class="report-item-value">${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;
                }
                
                ({ breakdown } = getIraqiTariffDetails(kwh, category));
                reportHtml += `<div class="report-section-title">${translations[lang].tariffBreakdown}</div><pre>${breakdown}</pre>`;

                reportModalTitle.textContent = translations[lang].reportModalTitle;
                reportModalContent.innerHTML = reportHtml;
                reportModal.style.display = 'flex';
            };

            const generateDeviceReport = () => {
                const lang = currentLang;
                let totalKwh = 0;
                const deviceDetailsForReport = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;
                    const kwh = (watt / 1000) * hours * day * count;
                    
                    if (isOn) {
                        totalKwh += kwh; 
                    }

                    deviceDetailsForReport.push({
                        name: deviceName,
                        watt: formatNumber(watt, 0, false, true),
                        hours: formatNumber(hours, 1, false, true),
                        day: formatNumber(day, 0, false, true),
                        count: formatNumber(count, 0, false, true),
                        kwh: formatNumber(kwh, 2),
                        on: isOn ? translations[lang].yes : translations[lang].no, // Translate Yes/No
                        fixed: isFixed ? translations[lang].yes : translations[lang].no // Translate Yes/No
                    });
                });

                if (deviceTableBody.children.length === 0) {
                    showMessage("addAndCalculateDeviceConsumption", 'info');
                    return;
                }
                
                const finalTotalBill = calculateCostForCategory(totalKwh, category);
                const finalAvgRate = totalKwh > 0 ? finalTotalBill / totalKwh : 0;
                const finalAvgAmperes = kwhToAmperes(totalKwh, daysVal);

                let reportHtml = `
                    <div class="report-section-title">${translations[lang].overallConsumptionSummary}</div>
                    <p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`; // UPDATED
                    reportHtml += `<p><span class="report-item-label">${translations[lang].totalBill}:</span> <span class="report-item-value">${formatNumber(finalTotalBill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].totalConsumption}:</span> <span class="report-item-value">${formatNumber(totalKwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].averageAmperes}:</span> <span class="report-item-value">${formatNumber(finalAvgAmperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].averageRate}:</span> <span class="report-item-value">${formatNumber(finalAvgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;

                    reportHtml += `<div class="report-section-title">${translations[lang].deviceBreakdown}</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>${translations[lang].device}</th>
                                <th>${translations[lang].watt}</th>
                                <th>${translations[lang].hoursPerDay}</th>
                                <th>${translations[lang].daysPerMonth}</th>
                                <th>${translations[lang].count}</th>
                                <th>${translations[lang].kwhPerMonth}</th>
                                <th>${translations[lang].iqdPerMonth}</th>
                                <th>${translations[lang].onQuestion}</th>
                                <th>${translations[lang].fixedQuestion}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                deviceDetailsForReport.forEach(device => {
                    const iqd = validateNumeric(device.kwh) * finalAvgRate;
                    reportHtml += `
                            <tr>
                                <td>${device.name}</td>
                                <td>${device.watt}</td>
                                <td>${device.hours}</td>
                                <td>${device.day}</td>
                                <td>${device.count}</td>
                                <td>${device.kwh}</td>
                                <td>${formatNumber(iqd, 0, true)}</td>
                                <td>${device.on}</td>
                                <td>${device.fixed}</td>
                            </tr>
                    `;
                });

                reportHtml += `
                        </tbody>
                    </table>
                `;

                reportModalTitle.textContent = translations[lang].reportModalTitle; // Update title
                reportModalContent.innerHTML = reportHtml;
                reportModal.style.display = 'flex';
            };

            // --- CSV HANDLING FUNCTIONS ---
            const exportTableToCsv = () => {
                const table = document.getElementById('deviceTable');
                let csv = [];

                // Get headers
                let headers = [];
                table.querySelectorAll('th').forEach(th => {
                    headers.push(th.innerText);
                });
                csv.push(headers.join(','));

                // Get rows
                table.querySelectorAll('tbody tr').forEach(row => {
                    let rowData = [];
                    row.querySelectorAll('td').forEach((td, index) => {
                        let cellValue;
                        if (index === 0) { // Device Name input
                            cellValue = td.querySelector('input').getAttribute('data-name-key'); // Store the key, not the translated value
                        } else if (index < 5) { // Other input fields
                            cellValue = td.querySelector('input').value;
                        } else if (index >= 7) { // Checkboxes
                            cellValue = td.querySelector('input').checked ? 'TRUE' : 'FALSE';
                        } else { // Output cells
                            cellValue = td.innerText.replace(/,/g, ''); // Remove commas for numeric values
                        }
                        // Escape commas and double quotes for CSV
                        if (String(cellValue).includes(',') || String(cellValue).includes('"')) {
                            cellValue = `"${String(cellValue).replace(/"/g, '""')}"`;
                        }
                        rowData.push(cellValue);
                    });
                    csv.push(rowData.join(','));
                });

                const csvString = csv.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'devices_runaki.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("deviceDataSaved", 'success');
            };

            const importTableFromCsv = (csvString) => {
                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 1) {
                    showMessage("csvEmpty", 'error');
                    return;
                }

                // Assuming the first line is headers, we skip it for data parsing
                const dataRows = lines.slice(1); 
                
                deviceTableBody.innerHTML = ''; // Clear existing rows

                dataRows.forEach(row => {
                    const columns = row.split(',').map(col => {
                        // Handle quoted values that might contain commas
                        if (col.startsWith('"') && col.endsWith('"')) {
                            return col.slice(1, -1).replace(/""/g, '"');
                        }
                        return col;
                    });

                    if (columns.length >= 9) { // Ensure we have enough columns
                        const deviceData = {
                            nameKey: columns[0], // First column is the device name key
                            name: translations[currentLang].deviceNames[columns[0]] || columns[0],
                            watt: columns[1],
                            hours: columns[2],
                            day: columns[3],
                            count: columns[4],
                            on: columns[7] === 'TRUE',
                            fixed: columns[8] === 'TRUE'
                        };
                        addTableRow(deviceData);
                    }
                });

                calculateDeviceConsumption();
                showMessage("deviceDataLoaded", 'success');
            };

            // --- EVENT LISTENERS ---
            calculateManualButton.addEventListener('click', performManualCalculation);
            calculateMeterButton.addEventListener('click', performMeterCalculation);
            optimizeBudgetButton.addEventListener('click', optimizeForBudget);
            manualReportButton.addEventListener('click', () => generateReport('manual'));
            meterReportButton.addEventListener('click', () => generateReport('meter'));
            deviceReportButton.addEventListener('click', generateDeviceReport);

            addRowButton.addEventListener('click', () => {
                addTableRow();
                calculateDeviceConsumption();
            });

            deleteRowButton.addEventListener('click', () => {
                if (selectedTableRow) {
                    deviceTableBody.removeChild(selectedTableRow);
                    selectedTableRow = null;
                    calculateDeviceConsumption();
                } else {
                    showMessage("selectRowToDelete", 'info');
                }
            });

            saveTableButton.addEventListener('click', exportTableToCsv);

            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        importTableFromCsv(event.target.result);
                    } catch (error) {
                        showMessage("errorLoadingData", 'error', { error: error.message });
                    }
                };
                reader.onerror = () => {
                    showMessage("errorLoadingData", 'error', { error: 'File read error' });
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset file input
            });

            clearAllButton.addEventListener('click', () => {
                deviceTableBody.innerHTML = '';
                selectedTableRow = null;
                startupPopulateDeviceTable();
                calculateDeviceConsumption();
                showMessage("allDeviceDataCleared", 'info');
            });

            // Modal close buttons
            closeTariffDetailsModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none';
            });

            closeReportModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });
            
            // About modal
            aboutButton.addEventListener('click', () => {
                aboutModal.style.display = 'flex';
            });
            
            closeAboutModal.addEventListener('click', () => {
                aboutModal.style.display = 'none';
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                }
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
                if (e.target === aboutModal) {
                    aboutModal.style.display = 'none';
                }
            });

            // Toggle section visibility
            toggleManualCalculationButton.addEventListener('click', () => {
                const isVisible = manualCalculationSection.style.display === 'block';
                manualCalculationSection.style.display = isVisible ? 'none' : 'block';
                toggleManualCalculationButton.textContent = 
                    isVisible ? translations[currentLang].showManualCalculation : translations[currentLang].hideManualCalculation;
            });

            toggleMeterCalculationButton.addEventListener('click', () => {
                const isVisible = meterCalculationSection.style.display === 'block';
                meterCalculationSection.style.display = isVisible ? 'none' : 'block';
                toggleMeterCalculationButton.textContent = 
                    isVisible ? translations[currentLang].showMeterCalculation : translations[currentLang].hideMeterCalculation;
            });

            toggleTableButton.addEventListener('click', () => {
                const isVisible = deviceTableSection.style.display === 'block';
                deviceTableSection.style.display = isVisible ? 'none' : 'block';
                toggleTableButton.textContent = 
                    isVisible ? translations[currentLang].hideDeviceTable : translations[currentLang].showDeviceTable;
            });

            toggleBudgetOptimizationButton.addEventListener('click', () => {
                const isVisible = budgetOptimizationSection.style.display === 'block';
                budgetOptimizationSection.style.display = isVisible ? 'none' : 'block';
                toggleBudgetOptimizationButton.textContent = 
                    isVisible ? translations[currentLang].hideBudgetOptimization : translations[currentLang].showBudgetOptimization;
            });

            const showTariffDetails = () => {
                const category = categoryDropdown.value;
                tariffDetailsModalTitle.textContent = translations[currentLang].tariffDetailsModalTitle;
                
                // Clear previous charts
                if (householdTariffChartInstance) householdTariffChartInstance.destroy();
                if (commercialTariffChartInstance) commercialTariffChartInstance.destroy();
                if (otherCategoriesTariffChartInstance) otherCategoriesTariffChartInstance.destroy();
                
                // Hide all chart containers initially
                householdTariffChartContainer.style.display = 'none';
                commercialTariffChartContainer.style.display = 'none';
                otherCategoriesTariffChartContainer.style.display = 'none';
                
                let tariffDetailsText = '';
                
                if (category === 'Household') {
                    householdTariffChartContainer.style.display = 'block';
                    const tiers = [400, 800, 1200, 1600];
                    const rates = [72, 108, 175, 265, 350];
                    
                    householdTariffChartInstance = new Chart(householdTariffChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: ['0-400', '401-800', '801-1200', '1201-1600', '1601+'],
                            datasets: [{
                                label: translations[currentLang].iqdPerKwh,
                                data: rates,
                                backgroundColor: '#3b82f6'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].householdTariffRates
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: translations[currentLang].iqdPerKwh
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: translations[currentLang].consumptionTiers + ' (kWh)'
                                    }
                                }
                            }
                        }
                    });
                    
                    tariffDetailsText = translations[currentLang].householdTariffRates + '\n';
                    for (let i = 0; i < rates.length; i++) {
                        const slab = i < tiers.length ? 
                            `${i === 0 ? 0 : tiers[i-1]+1}-${tiers[i]} kWh` : 
                            `${tiers[tiers.length-1]+1}+ kWh`;
                        tariffDetailsText += `  - ${slab}: ${rates[i]} ${translations[currentLang].iqdPerKwh}\n`;
                    }
                } else if (category === 'Commercial') {
                    commercialTariffChartContainer.style.display = 'block';
                    const rate = 185;
                    
                    commercialTariffChartInstance = new Chart(commercialTariffChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: [translations[currentLang].commercialOption],
                            datasets: [{
                                label: translations[currentLang].iqdPerKwh,
                                data: [rate],
                                backgroundColor: '#22c55e'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].commercialTariffRates
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: translations[currentLang].iqdPerKwh
                                    }
                                }
                            }
                        }
                    });
                    
                    tariffDetailsText = `${translations[currentLang].commercialTariffRates}\n  - ${rate} ${translations[currentLang].iqdPerKwh}`;
                } else {
                    otherCategoriesTariffChartContainer.style.display = 'block';
                    let rate = 0;
                    if (category === 'Agriculture') rate = 60;
                    else if (category === 'Industrial') rate = 160;
                    else if (category === 'Government') rate = 160;
                    
                    otherCategoriesTariffChartInstance = new Chart(otherCategoriesTariffChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: [translations[currentLang][category.toLowerCase() + 'Option'] || category],
                            datasets: [{
                                label: translations[currentLang].iqdPerKwh,
                                data: [rate],
                                backgroundColor: '#f97316'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].otherCategoriesTariffRates
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: translations[currentLang].iqdPerKwh
                                    }
                                }
                            }
                        }
                    });
                    
                    tariffDetailsText = `${translations[currentLang].otherCategoriesTariffRates}\n  - ${translations[currentLang][category.toLowerCase() + 'Option'] || category}: ${rate} ${translations[currentLang].iqdPerKwh}`;
                }
                
                tariffDetailsModalContent.textContent = tariffDetailsText;
                tariffDetailsModal.style.display = 'flex';
            };

            showTariffDetailsButton.addEventListener('click', showTariffDetails);

            // Initialize the app
            setActiveLanguage('en');
            startupPopulateDeviceTable();
            calculateDeviceConsumption();
        });
    </script>
</body>
</html>
