<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Runaki Bill Assistant</title>
    <link rel="manifest" href="/Runaki-Assistant/manifest.json">
    <meta name="theme-color" content="#3b82f6"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        :root {
            --primary-blue: #3b82f6;--secondary-green: #22c55e;--accent-orange: #f97316;--accent-purple: #8b5cf6;--neutral-gray-dark: #000000;--neutral-gray-medium: #6b7280;--neutral-gray-light: #e5e7eb;--background-light: #f9fafb;--card-background: #ffffff;--highlight-yellow: #facc15;--error-red: #ef4444;--button-light-gray: #e0e0e0;--button-hover-gray: #d1d1d1;--button-active-gray: #c0c0c0;--button-dark-text: #000000;--background-dark: #1a202c;--card-dark: #2d3748;--text-light: #e2e8f0;--text-medium-light: #a0aec0;--input-dark-bg: #4a5568;--input-dark-border: #6b7280;--result-item-dark-bg: #3c4a5c;--result-item-dark-border: #5a6a7c;--primary-blue-darker: #2563eb;--highlight-yellow-dark: #fbbf24;--manual-result-color: #fef08a;--manual-highlight-color: #fbbf24;--meter-result-color: #d9f99d;--meter-highlight-color: #a3e635;--device-result-color: #a7f3d0;--device-highlight-color: #5eead4;--menu-section-color: #e6c200;--device-name-color: #4f46e5;--device-name-color-night: #818cf8;--action-button-text-day: #000000;--action-button-text-night: #22c55e;--action-button-text-hover-day: #333333;--action-button-text-hover-night: #16a34a;--action-button-text-active-day: #555555;--action-button-text-active-night: #15803d;
        }

        * {box-sizing: border-box;margin: 0;padding: 0;}
        html, body {height: 100%;width: 100%;overflow-x: hidden;font-size: 18px;}
        body {font-family: 'Inter', sans-serif;background-color: var(--background-light);margin: 0;padding: 0;color: var(--neutral-gray-dark);display: flex;flex-direction: column;min-height: 100vh;touch-action: pan-x pan-y;padding-top: env(safe-area-inset-top);padding-bottom: env(safe-area-inset-bottom);transition: background-color 0.3s, color 0.3s;overscroll-behavior: none;}
        body.night-mode {background-color: var(--background-dark);color: var(--text-light);}
        .header-bar {position: relative;display: flex;justify-content: space-between;align-items: center;padding: 10px;width: 100%;z-index: 40;}
        .main-title {color: var(--highlight-yellow);font-weight: normal;font-size: clamp(1.4rem, 5.5vw, 2.4rem);text-align: center;flex-grow: 1;transition: color 0.3s;}
        body.night-mode .main-title {color: var(--highlight-yellow-dark);}
        .menu-toggle {width: 40px;height: 40px;border-radius: 8px;background-color: var(--button-light-gray);display: flex;flex-direction: column;justify-content: center;align-items: center;cursor: pointer;transition: all 0.3s ease;}
        body.night-mode .menu-toggle {background-color: var(--input-dark-bg);}
        .menu-toggle span {display: block;width: 20px;height: 2px;background-color: var(--button-dark-text);margin: 2px 0;transition: all 0.3s ease;}
        body.night-mode .menu-toggle span {background-color: var(--text-light);}
        .night-mode-toggle {width: 40px;height: 40px;border-radius: 8px;background-color: var(--button-light-gray);display: flex;justify-content: center;align-items: center;cursor: pointer;transition: all 0.3s ease;}
        body.night-mode .night-mode-toggle {background-color: var(--input-dark-bg);}
        .night-mode-toggle svg {width: 20px;height: 20px;fill: var(--button-dark-text);transition: fill 0.3s ease;}
        body.night-mode .night-mode-toggle svg {fill: var(--highlight-yellow-dark);}
        .menu-overlay {position: fixed;top: 0;left: 0;width: 75%;max-width: 75%;height: 100%;background-color: var(--card-background);display: none;flex-direction: column;z-index: 100;padding: 1rem;box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);transition: background-color 0.3s ease;}
        body.night-mode .menu-overlay {background-color: var(--card-dark);}
        .menu-overlay.open {display: flex;}
        .menu-title {font-size: 1.3rem;font-weight: 700;color: var(--neutral-gray-dark);padding: 1rem;text-align: left;border-bottom: 1px solid var(--neutral-gray-light);margin-bottom: 0.5rem;}
        body.night-mode .menu-title {color: var(--text-light);border-bottom-color: var(--input-dark-border);}
        .menu-items {flex: 1;display: flex;flex-direction: column;}
        .menu-item {font-size: 1.1rem;color: var(--neutral-gray-dark);padding: 1rem;text-align: left;cursor: pointer;transition: all 0.3s ease;border-radius: 8px;margin-bottom: 0.5rem;background-color: transparent;border-bottom: 1px solid var(--neutral-gray-light);}
        body.night-mode .menu-item {color: var(--highlight-yellow-dark);border-bottom-color: var(--input-dark-border);}
        .menu-item:last-child {border-bottom: none;}
        .menu-item:hover, .menu-item.active {background-color: var(--primary-blue);color: white;}
        .main-container {display: flex;flex-direction: column;gap: 1rem;width: 100%;max-width: 100%;background-color: var(--card-background);padding: 1rem;flex: 1;box-sizing: border-box;}
        body.night-mode .main-container {background-color: var(--card-dark);}
        .section-card {background-color: var(--card-background);border: 1px solid var(--neutral-gray-light);border-radius: 0.75rem;padding: 1rem;box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);width: 100%;box-sizing: border-box;display: none;}
        body.night-mode .section-card {background-color: var(--card-dark);border-color: var(--input-dark-border);}
        .section-card.active {display: block;}
        h2 {color: var(--neutral-gray-dark);font-weight: 700;margin-bottom: 0.75rem;font-size: clamp(1.4rem, 5vw, 1.8rem);text-align: center;}
        body.night-mode h2 {color: var(--text-light);}
        .input-group {display: flex;flex-wrap: wrap;align-items: center;gap: 0.5rem;margin-bottom: 1rem;justify-content: center;}
        label {font-weight: 600;color: var(--neutral-gray-medium);flex-shrink: 0;font-size: clamp(1rem, 3vw, 1.2rem);}
        body.night-mode label {color: var(--text-medium-light);}
        input[type="text"], input[type="number"], select {padding: 0.5rem;border: 1px solid var(--neutral-gray-light);border-radius: 0.5rem;font-size: clamp(1rem, 3vw, 1.2rem);text-align: center;background-color: var(--card-background);color: var(--neutral-gray-dark);flex-grow: 1;min-width: 5rem;transition: all 0.2s ease-in-out;box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);height: 42px;}
        body.night-mode input[type="text"], body.night-mode input[type="number"], body.night-mode select {background-color: var(--input-dark-bg);color: var(--text-light);border-color: var(--input-dark-border);}
        input[type="text"]:focus, input[type="number"]:focus, select:focus {border-color: var(--primary-blue);box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);outline: none;}
        button {padding: 0.5rem 1rem;border-radius: 0.5rem;border: none;font-size: clamp(1rem, 3vw, 1.2rem);font-weight: 700;cursor: pointer;transition: all 0.2s ease-in-out;box-shadow: 0 2px 4px rgba(0,0,0,0.1);white-space: nowrap;color: var(--button-dark-text);margin: 0.25rem;background-color: var(--button-light-gray);width: 100%;height: 42px;}
        body.night-mode button {background-color: var(--input-dark-bg);color: var(--text-light);}
        button.btn-action {color: var(--button-dark-text);}
        body.night-mode button.btn-action {color: var(--highlight-yellow-dark);}
        button.device-action {background-color: var(--button-light-gray);color: var(--action-button-text-day);font-weight: 600;}
        body.night-mode button.device-action {background-color: var(--input-dark-bg);color: var(--action-button-text-night);}
        button.device-action:hover {background-color: var(--button-hover-gray);color: var(--action-button-text-hover-day);}
        body.night-mode button.device-action:hover {background-color: var(--neutral-gray-medium);color: var(--action-button-text-hover-night);}
        button.device-action:active {background-color: var(--button-active-gray);color: var(--action-button-text-active-day);}
        body.night-mode button.device-action:active {background-color: var(--neutral-gray-dark);color: var(--action-button-text-active-night);}
        button:hover {transform: translateY(-2px);box-shadow: 0 4px 8px rgba(0,0,0,0.2);opacity: 0.95;background-color: var(--button-hover-gray);}
        body.night-mode button:hover {background-color: var(--neutral-gray-medium);}
        button:active {transform: translateY(0);box-shadow: 0 2px 4px rgba(0,0,0,0.1);background-color: var(--button-active-gray);}
        body.night-mode button:active {background-color: var(--neutral-gray-dark);}
        .result-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));gap: 0.5rem;font-size: clamp(1rem, 3vw, 1.2rem);margin-top: 0.5rem;width: 100%;}
        .result-item {background-color: var(--card-background);border: 1px solid var(--neutral-gray-light);border-radius: 0.5rem;padding: 0.75rem;text-align: center;box-shadow: inset 0 1px 4px rgba(0,0,0,0.07);}
        body.night-mode .result-item {background-color: var(--result-item-dark-bg);border-color: var(--result-item-dark-border);}
        .result-label {color: var(--neutral-gray-medium);margin-bottom: 0.2rem;font-weight: 500;font-size: clamp(0.8rem, 3vw, 1rem);}
        body.night-mode .result-label {color: var(--text-medium-light);}
        .result-value {font-weight: 800;color: var(--neutral-gray-dark);font-size: clamp(1.1rem, 4vw, 1.4rem);transition: color 0.2s ease-in-out;}
        body.night-mode .result-value {color: var(--text-light);}
        @keyframes flashEffect {0% {color: var(--current-result-color);}16.6% {color: var(--current-highlight-color);}33.3% {color: var(--current-result-color);}50% {color: var(--current-highlight-color);}66.6% {color: var(--current-result-color);}83.3% {color: var(--current-highlight-color);}100% {color: var(--current-result-color);}}
        .flash-animation {animation: flashEffect 1.8s ease-out;}
        .chart-container {width: 100%;height: 250px;margin-top: 1rem;background-color: var(--card-background);border-radius: 0.75rem;padding: 1rem;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
        body.night-mode .chart-container {background-color: var(--card-dark);}
        .device-table-container {overflow-x: auto;max-height: 400px;border: 1px solid var(--neutral-gray-light);border-radius: 0.75rem;margin-bottom: 1rem;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);width: 100%;-webkit-overflow-scrolling: touch;}
        body.night-mode .device-table-container {border-color: var(--input-dark-border);}
        .device-table {width: 100%;border-collapse: collapse;min-width: 600px;}
        .device-table th, .device-table td {padding: 0.5rem;border-bottom: 1px solid var(--neutral-gray-light);text-align: center;font-size: clamp(0.9rem, 2.5vw, 1.1rem);}
        body.night-mode .device-table th, body.night-mode .device-table td {border-bottom-color: var(--input-dark-border);}
        .device-table th {background-color: var(--button-light-gray);font-weight: 700;position: sticky;top: 0;z-index: 10;color: var(--neutral-gray-dark);}
        body.night-mode .device-table th {background-color: var(--input-dark-bg);color: var(--text-light);}
        .device-table tbody tr:hover {background-color: rgba(59, 130, 246, 0.1);}
        body.night-mode .device-table tbody tr:hover {background-color: rgba(59, 130, 246, 0.2);}
        .device-table tbody tr.selected-row {background-color: rgba(59, 130, 246, 0.2);box-shadow: inset 0 0 0 3px var(--primary-blue);}
        .device-table input[type="text"], .device-table input[type="number"] {width: 100%;padding: 0.3rem;border: 1px solid var(--neutral-gray-light);border-radius: 0.3rem;text-align: center;font-size: clamp(0.9rem, 2.5vw, 1.1rem);background-color: var(--card-background);color: var(--neutral-gray-dark);}
        body.night-mode .device-table input[type="text"], body.night-mode .device-table input[type="number"] {background-color: var(--input-dark-bg);color: var(--text-light);border-color: var(--input-dark-border);}
        .device-table input[type="checkbox"] {width: 1.2rem;height: 1.2rem;cursor: pointer;border-radius: 0.2rem;accent-color: var(--primary-blue);}
        .device-table .output-cell {background-color: rgba(59, 130, 246, 0.1);font-weight: 600;color: var(--primary-blue);}
        body.night-mode .device-table .output-cell {background-color: rgba(59, 130, 246, 0.2);color: var(--primary-blue-darker);}
        .device-name {color: var(--device-name-color);font-weight: 600;}
        body.night-mode .device-name {color: var(--device-name-color-night);}
        .modal-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.7);display: flex;justify-content: center;align-items: center;z-index: 1000;padding: 1rem;box-sizing: border-box;overflow-y: auto;}
        .modal-content {background-color: var(--card-background);padding: 1rem;border-radius: 0.75rem;box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);max-width: 100%;max-height: 90vh;overflow-y: auto;color: var(--neutral-gray-dark);position: relative;width: 100%;}
        body.night-mode .modal-content {background-color: var(--card-dark);color: var(--text-light);}
        .modal-close-button {position: absolute;top: 0.5rem;right: 0.5rem;background: none;border: none;font-size: 1.5rem;color: var(--neutral-gray-dark);cursor: pointer;z-index: 10;}
        body.night-mode .modal-close-button {color: var(--text-light);}
        .modal-close-button:hover {color: var(--primary-blue);}
        .modal-content h3 {font-size: 1.5rem;font-weight: 700;color: var(--primary-blue);margin-bottom: 0.75rem;}
        body.night-mode .modal-content h3 {color: var(--primary-blue-darker);}
        .modal-content pre {background-color: var(--button-light-gray);padding: 0.75rem;border-radius: 0.5rem;overflow-x: auto;font-family: 'Cascadia Code', 'Fira Code', monospace;font-size: 0.9rem;}
        body.night-mode .modal-content pre {background-color: var(--input-dark-bg);}
        footer {color: var(--neutral-gray-medium);margin-top: auto;width: 100%;display: flex;flex-direction: column;align-items: center;gap: 0.25rem;padding: 0.5rem;font-size: clamp(0.8rem, 3vw, 1rem);}
        body.night-mode footer {color: var(--text-medium-light);}
        #appMessage {position: fixed;top: env(safe-area-inset-top);right: 0.5rem;padding: 0.5rem 1rem;border-radius: 0.5rem;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);z-index: 1100;opacity: 0;transform: translateY(-20px);transition: opacity 0.3s ease-out, transform 0.3s ease-out;color: white;max-width: 90%;font-size: clamp(0.9rem, 3vw, 1.1rem);}
        #appMessage.show {opacity: 1;transform: translateY(0);}
        #appMessage.info {background-color: var(--primary-blue);}
        #appMessage.success {background-color: var(--secondary-green);}
        #appMessage.error {background-color: var(--error-red);}
        .report-section-title {font-size: 1.3rem;font-weight: 700;color: var(--primary-blue);margin-top: 1rem;margin-bottom: 0.5rem;border-bottom: 2px solid var(--primary-blue);padding-bottom: 0.25rem;}
        body.night-mode .report-section-title {color: var(--primary-blue-darker);border-bottom-color: var(--primary-blue-darker);}
        .report-item-label {font-weight: 600;color: var(--neutral-gray-medium);margin-right: 0.25rem;font-size: clamp(1rem, 3vw, 1.2rem);}
        body.night-mode .report-item-label {color: var(--text-medium-light);}
        .report-item-value {font-weight: 700;color: var(--neutral-gray-dark);font-size: clamp(1rem, 3vw, 1.2rem);}
        body.night-mode .report-item-value {color: var(--text-light);}
        .report-breakdown-item {margin-left: 0.5rem;font-size: clamp(0.8rem, 3vw, 1rem);color: var(--neutral-gray-medium);}
        body.night-mode .report-breakdown-item {color: var(--text-medium-light);}
        .report-table-container {overflow-x: auto;margin-top: 0.5rem;border-radius: 0.5rem;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);max-width: 100%;}
        .report-table {width: 100%;border-collapse: collapse;background-color: var(--button-light-gray);border-radius: 0.5rem;overflow: hidden;font-size: clamp(0.7rem, 2vw, 0.85rem);table-layout: fixed;}
        body.night-mode .report-table {background-color: var(--input-dark-bg);}
        .report-table th, .report-table td {padding: 0.3rem;border: 1px solid var(--neutral-gray-light);text-align: left;color: var(--neutral-gray-dark);white-space: normal;word-wrap: break-word;overflow: hidden;text-overflow: ellipsis;}
        body.night-mode .report-table th, body.night-mode .report-table td {border-color: var(--input-dark-border);color: var(--text-light);}
        .report-table th {background-color: var(--primary-blue);color: white;font-weight: 700;position: sticky;top: 0;white-space: normal;word-wrap: break-word;padding: 0.4rem;}
        .report-table tbody tr:nth-child(even) {background-color: rgba(59, 130, 246, 0.1);}
        body.night-mode .report-table tbody tr:nth-child(even) {background-color: rgba(59, 130, 246, 0.2);}
        .tariff-card {background-color: var(--card-background);border-radius: 0.75rem;padding: 1rem;margin-bottom: 1rem;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);border-left: 4px solid var(--primary-blue);}
        body.night-mode .tariff-card {background-color: var(--card-dark);}
        .tariff-card h4 {color: var(--primary-blue);font-size: 1.2rem;margin-bottom: 0.75rem;display: flex;align-items: center;}
        body.night-mode .tariff-card h4 {color: var(--primary-blue-darker);}
        .tariff-icon {width: 24px;height: 24px;margin-right: 0.5rem;fill: var(--primary-blue);}
        body.night-mode .tariff-icon {fill: var(--primary-blue-darker);}
        .tariff-tier {display: flex;justify-content: space-between;padding: 0.5rem 0;border-bottom: 1px dashed var(--neutral-gray-light);}
        .tariff-tier:last-child {border-bottom: none;}
        .tier-range {font-weight: 600;color: var(--neutral-gray-dark);}
        body.night-mode .tier-range {color: var(--text-light);}
        .tier-price {font-weight: normal;color: var(--secondary-green);font-size: 1.1rem;}
        .disclaimer {margin-top: 1.5rem;padding: 1rem;background-color: rgba(59, 130, 246, 0.1);border-radius: 0.5rem;border-left: 3px solid var(--primary-blue);font-size: clamp(0.9rem, 2.5vw, 1rem);color: var(--neutral-gray-medium);text-align: left;}
        body.night-mode .disclaimer {background-color: rgba(59, 130, 246, 0.2);color: var(--text-medium-light);}
        @media (max-width: 480px) {
            .result-grid {grid-template-columns: repeat(2, 1fr);}
            .input-group {flex-direction: column;align-items: stretch;}
            input[type="text"], input[type="number"], select {width: 100%;}
            .modal-content {padding: 0.75rem;}
            .report-table {font-size: 0.65rem;}
            .report-table th, .report-table td {padding: 0.25rem;}
        }
        @supports (-webkit-touch-callout: none) {
            body {min-height: -webkit-fill-available;}
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button id="menuToggle" class="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <h1 class="main-title">Runaki Bill Assistant</h1>
        
        <button id="nightModeToggle" class="night-mode-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </div>
    
    <div id="menuOverlay" class="menu-overlay">
        <div class="menu-title">Menu</div>
        <div class="menu-items">
            <div class="menu-item active" data-section="manualCalculationSection">Manual Calculation</div>
            <div class="menu-item" data-section="meterCalculationSection">By Meter Calculation</div>
            <div class="menu-item" data-section="deviceTableSection">Device Table</div>
            <div class="menu-item" data-section="tariffDetailsModal">Tariff Details</div>
            <div class="menu-item" data-section="aboutSection">About</div>
        </div>
    </div>

    <div class="main-container">
        <div class="flex flex-col w-full space-y-4">
            <div class="section-card active" id="manualCalculationSection">
                <h2 class="text-xl">Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household">Household</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Government">Government</option>
                        <option value="Heavy industries">Heavy industries</option>
                    </select>
                    <label for="manualInputTypeDropdown">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh">kWh</option>
                        <option value="Avg Amperes">Avg Amperes</option>
                        <option value="Given Bill">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn btn-action">Calculate Bill</button>
                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="manualAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="manualReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>

            <div class="section-card" id="meterCalculationSection">
                <h2 class="text-xl">By Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterPrevReading">Prev Reading:</label>
                    <input type="number" id="meterPrevReading" value="31051" class="w-24">
                    <label for="meterCurrReading">Curr Reading:</label>
                    <input type="number" id="meterCurrReading" value="31910" class="w-24">
                    <label for="daysInput">Days:</label>
                    <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16" disabled>
                </div>
                <button id="calculateMeterButton" class="btn btn-action">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="meterAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="meterReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>

            <div class="section-card flex-grow" id="deviceTableSection">
                <h2 class="text-xl">Device Consumption Table</h2>
                <div class="device-table-container">
                    <table id="deviceTable" class="device-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Watt</th>
                                <th>Hours</th>
                                <th>Day</th>
                                <th>Count</th>
                                <th>kWh</th>
                                <th>IQD</th>
                                <th>On</th>
                                <th>Fixed</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap items-start gap-2 mt-4">
                    <button id="addRowButton" class="btn device-action">Add Row</button>
                    <button id="deleteRowButton" class="btn device-action">Delete Selected</button>
                    <button id="saveTableButton" class="btn device-action">Save Data (Text)</button>
                    <label for="loadFileInput" class="btn device-action cursor-pointer">Load Data (Text)<input type="file" id="loadFileInput" accept=".txt,.csv" class="hidden"></label>
                    <button id="clearAllButton" class="btn device-action">Clear All</button>
                </div>
                <button id="deviceReportButton" class="btn btn-action mt-4">Generate Report</button>
            </div>
            
            <div class="section-card" id="aboutSection">
                <h2 class="text-xl">About</h2>
                <div style="margin-top: 1rem;">
                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem; text-align: center;">Created by: Dr. Ismael Abdulrahman</p>
                    <p style="font-size: 1rem; text-align: center; margin-bottom: 1.5rem;">ismael.abdulrahman@epu.edu.iq</p>
                    
                    <div class="disclaimer">
                        <p>This application was developed to assist users in calculating and understanding their estimated electricity costs under the new Runaki system. It is an independent, personal app and is not connected to the Runaki system. All efforts have been made to provide this app accurately, with the goal of supporting and assisting the community.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tariffDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeTariffDetailsModal">&times;</button>
            <h3 id="tariffDetailsModalTitle">Electricity Tariffs</h3>
            
            <div style="margin-top: 1.5rem;">
                <div class="tariff-card">
                    <h4>
                        <svg class="tariff-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        Residential Tariffs
                    </h4>
                    <div class="tariff-tier">
                        <span class="tier-range">1–400 kWh</span>
                        <span class="tier-price">72 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">401–800 kWh</span>
                        <span class="tier-price">108 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">801–1200 kWh</span>
                        <span class="tier-price">175 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">1201–1600 kWh</span>
                        <span class="tier-price">265 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">1600+ kWh</span>
                        <span class="tier-price">350 IQD</span>
                    </div>
                </div>
                
                <div class="tariff-card">
                    <h4>
                        <svg class="tariff-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                        Other Segments
                    </h4>
                    <div class="tariff-tier">
                        <span class="tier-range">Commercial</span>
                        <span class="tier-price">185 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">Heavy industries</span>
                        <span class="tier-price">125 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">Industrials</span>
                        <span class="tier-price">160 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">State</span>
                        <span class="tier-price">160 IQD</span>
                    </div>
                    <div class="tariff-tier">
                        <span class="tier-range">Agricultural</span>
                        <span class="tier-price">60 IQD</span>
                    </div>
                </div>
            </div>
            
            <div id="householdTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="householdTariffChart"></canvas>
            </div>
            <div id="commercialTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="commercialTariffChart"></canvas>
            </div>
            <div id="otherCategoriesTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="otherCategoriesTariffChart"></canvas>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeReportModal">&times;</button>
            <h3 id="reportModalTitle">Report</h3>
            <div id="reportModalContent" class="prose"></div>
        </div>
    </div>

    <div id="appMessage" class=""></div>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        // Pre-cache DOM elements for better performance
        const domElements = {
            menuToggle: document.getElementById('menuToggle'),
            menuOverlay: document.getElementById('menuOverlay'),
            menuItems: document.querySelectorAll('.menu-item[data-section]'),
            sections: document.querySelectorAll('.section-card'),
            nightModeToggle: document.getElementById('nightModeToggle'),
            body: document.body,
            tariffDetailsModal: document.getElementById('tariffDetailsModal'),
            closeTariffDetailsModal: document.getElementById('closeTariffDetailsModal'),
            reportModal: document.getElementById('reportModal'),
            closeReportModal: document.getElementById('closeReportModal'),
            appMessage: document.getElementById('appMessage'),
            manualCategoryDropdown: document.getElementById('categoryDropdown'),
            manualInputTypeDropdown: document.getElementById('manualInputTypeDropdown'),
            manualInput: document.getElementById('manualInput'),
            manualBill: document.getElementById('manualBill'),
            manualKwh: document.getElementById('manualKwh'),
            manualAmperes: document.getElementById('manualAmperes'),
            manualAvgRate: document.getElementById('manualAvgRate'),
            calculateManualButton: document.getElementById('calculateManualButton'),
            manualReportButton: document.getElementById('manualReportButton'),
            meterPrevReading: document.getElementById('meterPrevReading'),
            meterCurrReading: document.getElementById('meterCurrReading'),
            daysInput: document.getElementById('daysInput'),
            meterBill: document.getElementById('meterBill'),
            meterKwh: document.getElementById('meterKwh'),
            meterAmperes: document.getElementById('meterAmperes'),
            meterAvgRate: document.getElementById('meterAvgRate'),
            calculateMeterButton: document.getElementById('calculateMeterButton'),
            meterReportButton: document.getElementById('meterReportButton'),
            deviceTable: document.getElementById('deviceTable'),
            deviceTableBody: document.querySelector('#deviceTable tbody'),
            addRowButton: document.getElementById('addRowButton'),
            deleteRowButton: document.getElementById('deleteRowButton'),
            saveTableButton: document.getElementById('saveTableButton'),
            loadFileInput: document.getElementById('loadFileInput'),
            clearAllButton: document.getElementById('clearAllButton'),
            deviceReportButton: document.getElementById('deviceReportButton'),
            reportModalTitle: document.getElementById('reportModalTitle'),
            reportModalContent: document.getElementById('reportModalContent')
        };

        // Tariff data - precomputed for faster access
        const tariffData = {
            Household: [
                { min: 1, max: 400, rate: 72 },
                { min: 401, max: 800, rate: 108 },
                { min: 801, max: 1200, rate: 175 },
                { min: 1201, max: 1600, rate: 265 },
                { min: 1601, max: Infinity, rate: 350 }
            ],
            Commercial: [{ min: 1, max: Infinity, rate: 185 }],
            Agriculture: [{ min: 1, max: Infinity, rate: 60 }],
            Industrial: [{ min: 1, max: Infinity, rate: 160 }],
            Government: [{ min: 1, max: Infinity, rate: 160 }],
            'Heavy industries': [{ min: 1, max: Infinity, rate: 125 }]
        };

        // Device name mapping for proper display
        const deviceNameMap = {
            'ledTv': 'LED TV',
            'refrigerator': 'Refrigerator',
            'washingMachine': 'Washing Machine',
            'ledLighting': 'LED Lighting',
            'freezer': 'Freezer',
            'waterPump': 'Water Pump',
            'waterHeater': 'Water Heater',
            'airCooler': 'Air Cooler',
            'fan': 'Fan',
            'dishwasher': 'Dishwasher',
            'waterDispenser': 'Water Dispenser',
            'splitAc1Ton': 'Split AC 1 Ton',
            'splitAc1_5Ton': 'Split AC 1.5 Ton',
            'splitAc2Ton': 'Split AC 2 Ton',
            'towerAc': 'Tower AC',
            'electricHeater': 'Electric Heater',
            'iron': 'Iron',
            'microwave': 'Microwave',
            'electricKettle': 'Electric Kettle',
            'hairDryer': 'Hair Dryer',
            'vacuumCleaner': 'Vacuum Cleaner',
            'electricOven': 'Electric Oven',
            'phoneCharger': 'Phone Charger',
            'desktopPc': 'Desktop PC',
            'pcMonitor': 'PC Monitor'
        };

        // Sample devices for initialization
        const sampleDevices = [
            { nameKey: 'ledTv', watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'refrigerator', watt: '175', hours: '24', day: '30', count: '1', on: true, fixed: true },
            { nameKey: 'washingMachine', watt: '2000', hours: '2', day: '4', count: '1', on: true, fixed: false },
            { nameKey: 'ledLighting', watt: '12', hours: '12', day: '30', count: '20', on: true, fixed: false },
            { nameKey: 'freezer', watt: '150', hours: '24', day: '30', count: '1', on: true, fixed: true },
            { nameKey: 'waterPump', watt: '500', hours: '1', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'waterHeater', watt: '2500', hours: '1', day: '15', count: '1', on: false, fixed: false },
            { nameKey: 'airCooler', watt: '250', hours: '18', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'fan', watt: '75', hours: '18', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'dishwasher', watt: '1800', hours: '2', day: '15', count: '1', on: true, fixed: false },
            { nameKey: 'waterDispenser', watt: '175', hours: '2', day: '15', count: '1', on: true, fixed: false },
            { nameKey: 'splitAc1Ton', watt: '1000', hours: '4', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'splitAc1_5Ton', watt: '1500', hours: '4', day: '30', count: '1', on: false, fixed: false },
            { nameKey: 'splitAc2Ton', watt: '2000', hours: '4', day: '30', count: '1', on: false, fixed: false },
            { nameKey: 'towerAc', watt: '3000', hours: '4', day: '30', count: '1', on: false, fixed: false },
            { nameKey: 'electricHeater', watt: '2000', hours: '6', day: '20', count: '1', on: false, fixed: false },
            { nameKey: 'iron', watt: '1500', hours: '1', day: '8', count: '1', on: false, fixed: false },
            { nameKey: 'microwave', watt: '1000', hours: '0.5', day: '15', count: '1', on: false, fixed: false },
            { nameKey: 'electricKettle', watt: '1800', hours: '0.2', day: '30', count: '1', on: false, fixed: false },
            { nameKey: 'hairDryer', watt: '1600', hours: '0.2', day: '10', count: '1', on: false, fixed: false },
            { nameKey: 'vacuumCleaner', watt: '1400', hours: '0.5', day: '4', count: '1', on: false, fixed: false },
            { nameKey: 'electricOven', watt: '2500', hours: '1', day: '10', count: '1', on: false, fixed: false },
            { nameKey: 'phoneCharger', watt: '10', hours: '8', day: '30', count: '2', on: false, fixed: true },
            { nameKey: 'desktopPc', watt: '150', hours: '6', day: '30', count: '1', on: true, fixed: false },
            { nameKey: 'pcMonitor', watt: '40', hours: '6', day: '30', count: '1', on: false, fixed: false },
        ];

        // Optimized calculation function
        function calculateBill(category, inputValue, inputType) {
            let kWh = 0, bill = 0, avgAmperes = 0;
            
            if (inputType === 'kWh') {
                kWh = parseFloat(inputValue);
            } else if (inputType === 'Avg Amperes') {
                avgAmperes = parseFloat(inputValue);
                kWh = avgAmperes * 220 * 24 * 30 / 1000;
            } else if (inputType === 'Given Bill') {
                bill = parseFloat(inputValue);
                const rates = tariffData[category];
                let totalKWh = 0, remainingBill = bill;
                
                for (const tier of rates) {
                    const tierRange = tier.max - tier.min + 1;
                    const maxTierBill = tierRange * tier.rate;
                    
                    if (remainingBill >= maxTierBill) {
                        totalKWh += tierRange;
                        remainingBill -= maxTierBill;
                    } else {
                        totalKWh += remainingBill / tier.rate;
                        break;
                    }
                }
                
                kWh = totalKWh;
            }
            
            if (inputType !== 'Given Bill') {
                const rates = tariffData[category];
                let remainingKWh = kWh;
                
                for (const tier of rates) {
                    if (remainingKWh <= 0) break;
                    
                    const tierRange = Math.min(remainingKWh, tier.max - tier.min + 1);
                    bill += tierRange * tier.rate;
                    remainingKWh -= tierRange;
                }
            }
            
            if (inputType !== 'Avg Amperes') {
                avgAmperes = kWh * 1000 / (220 * 24 * 30);
            }
            
            const avgRate = kWh > 0 ? bill / kWh : 0;
            
            return {
                bill: Math.round(bill),
                kWh: parseFloat(kWh.toFixed(2)),
                avgAmperes: parseFloat(avgAmperes.toFixed(2)),
                avgRate: parseFloat(avgRate.toFixed(2))
            };
        }

        // Optimized device consumption calculation
        function calculateDeviceConsumption(device) {
            if (!device.on) return { kWh: 0, cost: 0 };
            
            const kWh = (device.watt * device.hours * device.day * device.count) / 1000;
            const category = domElements.manualCategoryDropdown.value;
            const result = calculateBill(category, kWh, 'kWh');
            
            return {
                kWh: parseFloat(kWh.toFixed(2)),
                cost: result.bill
            };
        }

        // Create device row with event delegation
        function createDeviceRow(device = {}) {
            const row = document.createElement('tr');
            
            device.nameKey = device.nameKey || '';
            device.watt = device.watt || 0;
            device.hours = device.hours || 0;
            device.day = device.day || 30;
            device.count = device.count || 1;
            device.on = device.on !== undefined ? device.on : true;
            device.fixed = device.fixed !== undefined ? device.fixed : false;
            
            const consumption = calculateDeviceConsumption(device);
            const displayName = deviceNameMap[device.nameKey] || device.nameKey;
            
            row.innerHTML = `
                <td><input type="text" class="device-name" value="${displayName}" data-namekey="${device.nameKey}" placeholder="Device name"></td>
                <td><input type="number" class="device-watt" value="${device.watt}" min="0"></td>
                <td><input type="number" class="device-hours" value="${device.hours}" min="0" max="24"></td>
                <td><input type="number" class="device-day" value="${device.day}" min="1" max="365"></td>
                <td><input type="number" class="device-count" value="${device.count}" min="1"></td>
                <td class="output-cell">${consumption.kWh}</td>
                <td class="output-cell">${consumption.cost} IQD</td>
                <td><input type="checkbox" class="device-on" ${device.on ? 'checked' : ''}></td>
                <td><input type="checkbox" class="device-fixed" ${device.fixed ? 'checked' : ''}></td>
            `;
            
            // Use event delegation instead of individual event listeners
            row.addEventListener('input', updateDeviceRow);
            row.addEventListener('change', updateDeviceRow);
            
            row.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox' && e.target.type !== 'text' && e.target.type !== 'number') {
                    row.classList.toggle('selected-row');
                }
            });
            
            return row;
        }

        // Update device row with throttling
        let updateTimeout;
        function updateDeviceRow() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                const row = this.closest('tr');
                const nameInput = row.querySelector('.device-name');
                const nameKey = nameInput.getAttribute('data-namekey') || nameInput.value;
                const watt = parseFloat(row.querySelector('.device-watt').value) || 0;
                const hours = parseFloat(row.querySelector('.device-hours').value) || 0;
                const day = parseFloat(row.querySelector('.device-day').value) || 30;
                const count = parseFloat(row.querySelector('.device-count').value) || 1;
                const on = row.querySelector('.device-on').checked;
                
                const device = { nameKey, watt, hours, day, count, on };
                const consumption = calculateDeviceConsumption(device);
                
                row.querySelectorAll('.output-cell')[0].textContent = consumption.kWh;
                row.querySelectorAll('.output-cell')[1].textContent = `${consumption.cost} IQD`;
                
                updateDeviceTotals();
            }, 100);
        }

        // Update device totals with optimization
        function updateDeviceTotals() {
            const rows = domElements.deviceTableBody.querySelectorAll('tr:not(.totals-row)');
            let totalKWh = 0, totalCost = 0;
            
            rows.forEach(row => {
                const kWhCell = row.querySelectorAll('.output-cell')[0];
                const costCell = row.querySelectorAll('.output-cell')[1];
                
                if (kWhCell && costCell) {
                    totalKWh += parseFloat(kWhCell.textContent) || 0;
                    totalCost += parseFloat(costCell.textContent) || 0;
                }
            });
            
            let totalsRow = domElements.deviceTableBody.querySelector('.totals-row');
            
            if (!totalsRow) {
                totalsRow = document.createElement('tr');
                totalsRow.className = 'totals-row';
                totalsRow.innerHTML = `
                    <td colspan="5" style="text-align: right; font-weight: 700;">Total:</td>
                    <td class="output-cell" style="font-weight: 700;">0</td>
                    <td class="output-cell" style="font-weight: 700;">0 IQD</td>
                    <td colspan="2"></td>
                `;
                domElements.deviceTableBody.appendChild(totalsRow);
            }
            
            totalsRow.querySelectorAll('.output-cell')[0].textContent = totalKWh.toFixed(2);
            totalsRow.querySelectorAll('.output-cell')[1].textContent = `${Math.round(totalCost)} IQD`;
        }

        // Show message with optimization
        function showMessage(message, type = 'info') {
            domElements.appMessage.textContent = message;
            domElements.appMessage.className = 'show ' + type;
            
            setTimeout(() => {
                domElements.appMessage.classList.remove('show');
            }, 3000);
        }

        // Generate report with optimized DOM manipulation
        function generateReport(title, category, inputType, inputValue, result) {
            domElements.reportModalTitle.textContent = title;
            
            const currentDate = new Date().toLocaleDateString();
            const rates = tariffData[category];
            let remainingKWh = parseFloat(result.kWh);
            
            let content = `
                <div class="report-section-title">Calculation Details</div>
                <p><span class="report-item-label">Date:</span> <span class="report-item-value">${currentDate}</span></p>
                <p><span class="report-item-label">Category:</span> <span class="report-item-value">${category}</span></p>
                <p><span class="report-item-label">Input Type:</span> <span class="report-item-value">${inputType}</span></p>
                <p><span class="report-item-label">Input Value:</span> <span class="report-item-value">${inputValue}</span></p>
                
                <div class="report-section-title">Results</div>
                <p><span class="report-item-label">Bill Amount:</span> <span class="report-item-value">${result.bill}</span></p>
                <p><span class="report-item-label">Consumption:</span> <span class="report-item-value">${result.kWh}</span></p>
                <p><span class="report-item-label">Average Amperes:</span> <span class="report-item-value">${result.avgAmperes}</span></p>
                <p><span class="report-item-label">Average Rate:</span> <span class="report-item-value">${result.avgRate}</span></p>
                
                <div class="report-section-title">Tariff Breakdown</div>
                <div class="report-table-container"><table class="report-table"><thead><tr><th>Tier (kWh)</th><th>Rate (IQD)</th><th>Consumption (kWh)</th><th>Cost (IQD)</th></tr></thead><tbody>
            `;
            
            for (const tier of rates) {
                if (remainingKWh <= 0) break;
                
                const tierRange = Math.min(remainingKWh, tier.max - tier.min + 1);
                const tierCost = tierRange * tier.rate;
                
                content += `<tr><td>${tier.min}-${tier.max === Infinity ? '∞' : tier.max}</td><td>${tier.rate}</td><td>${tierRange.toFixed(2)}</td><td>${Math.round(tierCost)}</td></tr>`;
                
                remainingKWh -= tierRange;
            }
            
            content += '</tbody></table></div>';
            domElements.reportModalContent.innerHTML = content;
            domElements.reportModal.style.display = 'flex';
        }

        // Generate device report with optimized DOM manipulation
        function generateDeviceReport(title, devices, result) {
            domElements.reportModalTitle.textContent = title;
            
            const currentDate = new Date().toLocaleDateString();
            
            let content = `
                <div class="report-section-title">Calculation Details</div>
                <p><span class="report-item-label">Date:</span> <span class="report-item-value">${currentDate}</span></p>
                <p><span class="report-item-label">Category:</span> <span class="report-item-value">${domElements.manualCategoryDropdown.value}</span></p>
                
                <div class="report-section-title">Results</div>
                <p><span class="report-item-label">Total Bill:</span> <span class="report-item-value">${result.bill}</span></p>
                <p><span class="report-item-label">Total Consumption:</span> <span class="report-item-value">${result.kWh}</span></p>
                <p><span class="report-item-label">Average Amperes:</span> <span class="report-item-value">${result.avgAmperes}</span></p>
                <p><span class="report-item-label">Average Rate:</span> <span class="report-item-value">${result.avgRate}</span></p>
                
                <div class="report-section-title">Device Breakdown</div>
                <div class="report-table-container"><table class="report-table"><thead><tr><th>Device</th><th>Watt</th><th>Hours/Day</th><th>Days</th><th>Count</th><th>kWh</th><th>Cost (IQD)</th></tr></thead><tbody>
            `;
            
            devices.forEach(device => {
                content += `<tr>
                    <td>${device.name}</td>
                    <td>${device.watt}</td>
                    <td>${device.hours}</td>
                    <td>${device.day}</td>
                    <td>${device.count}</td>
                    <td>${device.kWh.toFixed(2)}</td>
                    <td>${Math.round(device.cost)}</td>
                </tr>`;
            });
            
            content += '</tbody></table></div>';
            domElements.reportModalContent.innerHTML = content;
            domElements.reportModal.style.display = 'flex';
        }

        // Initialize the application
        function initApp() {
            // Menu functionality
            domElements.menuToggle.addEventListener('click', () => {
                domElements.menuOverlay.classList.toggle('open');
            });
            
            document.addEventListener('click', (e) => {
                if (!domElements.menuOverlay.contains(e.target) && !domElements.menuToggle.contains(e.target)) {
                    domElements.menuOverlay.classList.remove('open');
                }
            });
            
            domElements.menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section');
                    
                    if (sectionId === 'tariffDetailsModal') {
                        domElements.tariffDetailsModal.style.display = 'flex';
                        domElements.menuOverlay.classList.remove('open');
                        return;
                    }
                    
                    domElements.sections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    const selectedSection = document.getElementById(sectionId);
                    if (selectedSection) {
                        selectedSection.classList.add('active');
                    }
                    
                    domElements.menuItems.forEach(mi => {
                        mi.classList.remove('active');
                    });
                    item.classList.add('active');
                    
                    domElements.menuOverlay.classList.remove('open');
                });
            });
            
            // Night mode toggle
            const isNightMode = localStorage.getItem('nightMode') === 'true';
            if (isNightMode) {
                domElements.body.classList.add('night-mode');
                domElements.nightModeToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                `;
            }
            
            domElements.nightModeToggle.addEventListener('click', () => {
                if (domElements.body.classList.contains('night-mode')) {
                    domElements.body.classList.remove('night-mode');
                    localStorage.setItem('nightMode', 'false');
                    domElements.nightModeToggle.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    `;
                } else {
                    domElements.body.classList.add('night-mode');
                    localStorage.setItem('nightMode', 'true');
                    domElements.nightModeToggle.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2='18.36'></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    `;
                }
            });
            
            // Modal functionality
            domElements.closeTariffDetailsModal.addEventListener('click', () => {
                domElements.tariffDetailsModal.style.display = 'none';
            });
            
            domElements.closeReportModal.addEventListener('click', () => {
                domElements.reportModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === domElements.tariffDetailsModal) {
                    domElements.tariffDetailsModal.style.display = 'none';
                }
                if (e.target === domElements.reportModal) {
                    domElements.reportModal.style.display = 'none';
                }
            });
            
            // Manual calculation
            domElements.calculateManualButton.addEventListener('click', () => {
                const category = domElements.manualCategoryDropdown.value;
                const inputType = domElements.manualInputTypeDropdown.value;
                const inputValue = domElements.manualInput.value;
                
                if (!inputValue || isNaN(inputValue) || parseFloat(inputValue) <= 0) {
                    showMessage('Please enter a valid input value', 'error');
                    return;
                }
                
                const result = calculateBill(category, inputValue, inputType);
                
                domElements.manualBill.textContent = `${result.bill} IQD`;
                domElements.manualKwh.textContent = `${result.kWh} kWh`;
                domElements.manualAmperes.textContent = `${result.avgAmperes} A`;
                domElements.manualAvgRate.textContent = `${result.avgRate} IQD/kWh`;
                
                document.documentElement.style.setProperty('--current-result-color', 'var(--manual-result-color)');
                document.documentElement.style.setProperty('--current-highlight-color', 'var(--manual-highlight-color)');
                
                domElements.manualBill.classList.add('flash-animation');
                domElements.manualKwh.classList.add('flash-animation');
                domElements.manualAmperes.classList.add('flash-animation');
                domElements.manualAvgRate.classList.add('flash-animation');
                
                setTimeout(() => {
                    domElements.manualBill.classList.remove('flash-animation');
                    domElements.manualKwh.classList.remove('flash-animation');
                    domElements.manualAmperes.classList.remove('flash-animation');
                    domElements.manualAvgRate.classList.remove('flash-animation');
                }, 1800);
            });
            
            domElements.manualReportButton.addEventListener('click', () => {
                const category = domElements.manualCategoryDropdown.value;
                const inputType = domElements.manualInputTypeDropdown.value;
                const inputValue = domElements.manualInput.value;
                const result = {
                    bill: domElements.manualBill.textContent,
                    kWh: domElements.manualKwh.textContent,
                    avgAmperes: domElements.manualAmperes.textContent,
                    avgRate: domElements.manualAvgRate.textContent
                };
                
                generateReport('Manual Calculation Report', category, inputType, inputValue, result);
            });
            
            // Meter calculation
            domElements.calculateMeterButton.addEventListener('click', () => {
                const prevReading = parseFloat(domElements.meterPrevReading.value);
                const currReading = parseFloat(domElements.meterCurrReading.value);
                const days = parseFloat(domElements.daysInput.value);
                
                if (isNaN(prevReading) || isNaN(currReading) || prevReading >= currReading) {
                    showMessage('Please enter valid meter readings', 'error');
                    return;
                }
                
                const kWh = currReading - prevReading;
                const category = domElements.manualCategoryDropdown.value;
                const result = calculateBill(category, kWh, 'kWh');
                
                const dayFactor = 30 / days;
                const adjustedBill = Math.round(result.bill * dayFactor);
                const adjustedKWh = parseFloat((result.kWh * dayFactor).toFixed(2));
                const adjustedAvgAmperes = parseFloat((result.avgAmperes * dayFactor).toFixed(2));
                
                domElements.meterBill.textContent = `${adjustedBill} IQD`;
                domElements.meterKwh.textContent = `${adjustedKWh} kWh`;
                domElements.meterAmperes.textContent = `${adjustedAvgAmperes} A`;
                domElements.meterAvgRate.textContent = `${result.avgRate} IQD/kWh`;
                
                document.documentElement.style.setProperty('--current-result-color', 'var(--meter-result-color)');
                document.documentElement.style.setProperty('--current-highlight-color', 'var(--meter-highlight-color)');
                
                domElements.meterBill.classList.add('flash-animation');
                domElements.meterKwh.classList.add('flash-animation');
                domElements.meterAmperes.classList.add('flash-animation');
                domElements.meterAvgRate.classList.add('flash-animation');
                
                setTimeout(() => {
                    domElements.meterBill.classList.remove('flash-animation');
                    domElements.meterKwh.classList.remove('flash-animation');
                    domElements.meterAmperes.classList.remove('flash-animation');
                    domElements.meterAvgRate.classList.remove('flash-animation');
                }, 1800);
            });
            
            domElements.meterReportButton.addEventListener('click', () => {
                const prevReading = parseFloat(domElements.meterPrevReading.value);
                const currReading = parseFloat(domElements.meterCurrReading.value);
                const days = parseFloat(domElements.daysInput.value);
                const category = domElements.manualCategoryDropdown.value;
                const result = {
                    bill: domElements.meterBill.textContent,
                    kWh: domElements.meterKwh.textContent,
                    avgAmperes: domElements.meterAmperes.textContent,
                    avgRate: domElements.meterAvgRate.textContent
                };
                
                const inputType = `Meter Reading (${prevReading} to ${currReading} in ${days} days)`;
                const inputValue = currReading - prevReading;
                
                generateReport('Meter Calculation Report', category, inputType, inputValue, result);
            });
            
            // Device table
            sampleDevices.forEach(device => {
                domElements.deviceTableBody.appendChild(createDeviceRow(device));
            });
            updateDeviceTotals();
            
            domElements.addRowButton.addEventListener('click', () => {
                const newRow = createDeviceRow();
                const totalsRow = domElements.deviceTableBody.querySelector('.totals-row');
                
                if (totalsRow) {
                    domElements.deviceTableBody.insertBefore(newRow, totalsRow);
                } else {
                    domElements.deviceTableBody.appendChild(newRow);
                }
                updateDeviceTotals();
            });
            
            domElements.deleteRowButton.addEventListener('click', () => {
                const selectedRows = domElements.deviceTableBody.querySelectorAll('.selected-row');
                
                if (selectedRows.length === 0) {
                    showMessage('Please select rows to delete', 'error');
                    return;
                }
                
                selectedRows.forEach(row => {
                    row.remove();
                });
                
                updateDeviceTotals();
            });
            
            domElements.saveTableButton.addEventListener('click', () => {
                const rows = domElements.deviceTableBody.querySelectorAll('tr:not(.totals-row)');
                let textContent = 'Device Consumption Data\n';
                textContent += '========================\n\n';
                
                textContent += 'Device\t\tWatt\tHours\tDay\tCount\tkWh\tIQD\tOn\tFixed\n';
                textContent += '-----------------------------------------------------------------\n';
                
                rows.forEach(row => {
                    const nameInput = row.querySelector('.device-name');
                    const name = nameInput.value || 'Unnamed';
                    const watt = row.querySelector('.device-watt').value || '0';
                    const hours = row.querySelector('.device-hours').value || '0';
                    const day = row.querySelector('.device-day').value || '30';
                    const count = row.querySelector('.device-count').value || '1';
                    const kWh = row.querySelectorAll('.output-cell')[0].textContent || '0';
                    const cost = row.querySelectorAll('.output-cell')[1].textContent || '0 IQD';
                    const on = row.querySelector('.device-on').checked ? 'Yes' : 'No';
                    const fixed = row.querySelector('.device-fixed').checked ? 'Yes' : 'No';
                    
                    const formattedName = name.padEnd(12, ' ');
                    
                    textContent += `${formattedName}\t${watt}\t${hours}\t${day}\t${count}\t${kWh}\t${cost}\t${on}\t${fixed}\n`;
                });
                
                const totalsRow = domElements.deviceTableBody.querySelector('.totals-row');
                if (totalsRow) {
                    const totalKWh = totalsRow.querySelectorAll('.output-cell')[0].textContent || '0';
                    const totalCost = totalsRow.querySelectorAll('.output-cell')[1].textContent || '0 IQD';
                    
                    textContent += '-----------------------------------------------------------------\n';
                    textContent += `Total:\t\t\t\t\t\t${totalKWh}\t${totalCost}\t\t\n`;
                }
                
                const now = new Date();
                textContent += `\nGenerated on: ${now.toLocaleString()}\n`;
                
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'device_consumption.txt';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            domElements.loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const lines = text.split('\n');
                        
                        let dataStartIndex = 0;
                        for (let i = 0; i < lines.length; i++) {
                            if (lines[i].includes('Device\t\tWatt')) {
                                dataStartIndex = i + 2;
                                break;
                            }
                        }
                        
                        const existingRows = domElements.deviceTableBody.querySelectorAll('tr:not(.totals-row)');
                        existingRows.forEach(row => row.remove());
                        
                        for (let i = dataStartIndex; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line || line.includes('Total:') || line.includes('Generated on:')) continue;
                            
                            const parts = line.split('\t');
                            if (parts.length < 9) continue;
                            
                            const name = parts[0].trim();
                            const watt = parts[1].trim();
                            const hours = parts[2].trim();
                            const day = parts[3].trim();
                            const count = parts[4].trim();
                            const on = parts[7].trim() === 'Yes';
                            const fixed = parts[8].trim() === 'Yes';
                            
                            let nameKey = name.toLowerCase().replace(/\s+/g, '');
                            for (const [key, value] of Object.entries(deviceNameMap)) {
                                if (value === name) {
                                    nameKey = key;
                                    break;
                                }
                            }
                            
                            const device = {
                                nameKey: nameKey,
                                watt: parseFloat(watt) || 0,
                                hours: parseFloat(hours) || 0,
                                day: parseFloat(day) || 30,
                                count: parseFloat(count) || 1,
                                on: on,
                                fixed: fixed
                            };
                            
                            domElements.deviceTableBody.appendChild(createDeviceRow(device));
                        }
                        
                        updateDeviceTotals();
                    } catch (error) {
                        showMessage('Error loading text file', 'error');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
                e.target.value = '';
            });
            
            domElements.clearAllButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all device data?')) {
                    const existingRows = domElements.deviceTableBody.querySelectorAll('tr:not(.totals-row)');
                    existingRows.forEach(row => row.remove());
                    updateDeviceTotals();
                }
            });
            
            domElements.deviceReportButton.addEventListener('click', () => {
                const rows = domElements.deviceTableBody.querySelectorAll('tr:not(.totals-row)');
                let totalKWh = 0, totalCost = 0;
                const devices = [];
                
                rows.forEach(row => {
                    const nameInput = row.querySelector('.device-name');
                    const name = nameInput.value;
                    const watt = parseFloat(row.querySelector('.device-watt').value) || 0;
                    const hours = parseFloat(row.querySelector('.device-hours').value) || 0;
                    const day = parseFloat(row.querySelector('.device-day').value) || 30;
                    const count = parseFloat(row.querySelector('.device-count').value) || 1;
                    const on = row.querySelector('.device-on').checked;
                    const kWh = parseFloat(row.querySelectorAll('.output-cell')[0].textContent) || 0;
                    const cost = parseFloat(row.querySelectorAll('.output-cell')[1].textContent) || 0;
                    
                    if (on) {
                        totalKWh += kWh;
                        totalCost += cost;
                    }
                    
                    devices.push({ name, watt, hours, day, count, on, kWh, cost });
                });
                
                const result = {
                    bill: `${Math.round(totalCost)} IQD`,
                    kWh: `${totalKWh.toFixed(2)} kWh`,
                    avgAmperes: `${(totalKWh * 1000 / (220 * 24 * 30)).toFixed(2)} A`,
                    avgRate: `${totalCost > 0 ? (totalCost / totalKWh).toFixed(2) : 0} IQD/kWh`
                };
                
                generateDeviceReport('Device Consumption Report', devices, result);
            });
            
            // Tariff charts
            function createTariffCharts() {
                const isNightMode = domElements.body.classList.contains('night-mode');
                
                // Define colors for different modes
                const householdColors = isNightMode ? [
                    'rgba(59, 130, 246, 0.5)',
                    'rgba(59, 130, 246, 0.6)',
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(59, 130, 246, 0.9)'
                ] : [
                    'rgba(34, 197, 94, 0.7)',   // Green for day mode
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(34, 197, 94, 0.9)',
                    'rgba(34, 139, 94, 0.7)',
                    'rgba(34, 139, 94, 0.8)'
                ];
                
                const otherCategoriesColors = isNightMode ? [
                    'rgba(139, 92, 246, 0.5)',
                    'rgba(139, 92, 246, 0.6)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(139, 92, 246, 0.9)'
                ] : [
                    'rgba(99, 102, 241, 0.7)',   // Indigo for day mode
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(99, 102, 241, 0.9)',
                    'rgba(79, 70, 229, 0.7)',
                    'rgba(79, 70, 229, 0.8)'
                ];
                
                const householdCtx = document.getElementById('householdTariffChart').getContext('2d');
                new Chart(householdCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1-400', '401-800', '801-1200', '1201-1600', '1600+'],
                        datasets: [{
                            label: 'Tariff Rate (IQD/kWh)',
                            data: [72, 108, 175, 265, 350],
                            backgroundColor: householdColors,
                            borderColor: isNightMode ? [
                                'rgba(59, 130, 246, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(59, 130, 246, 1)'
                            ] : [
                                'rgba(34, 197, 94, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(34, 139, 94, 1)',
                                'rgba(34, 139, 94, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Rate (IQD/kWh)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Consumption (kWh)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Household Electricity Tariff'
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
                
                const otherCategoriesCtx = document.getElementById('otherCategoriesTariffChart').getContext('2d');
                new Chart(otherCategoriesCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Commercial', 'Heavy industries', 'Industrials', 'State', 'Agricultural'],
                        datasets: [{
                            label: 'Tariff Rate (IQD/kWh)',
                            data: [185, 125, 160, 160, 60],
                            backgroundColor: otherCategoriesColors,
                            borderColor: isNightMode ? [
                                'rgba(139, 92, 246, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(139, 92, 246, 1)'
                            ] : [
                                'rgba(99, 102, 241, 1)',
                                'rgba(99, 102, 241, 1)',
                                'rgba(99, 102, 241, 1)',
                                'rgba(79, 70, 229, 1)',
                                'rgba(79, 70, 229, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Rate (IQD/kWh)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Other Categories Electricity Tariff'
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
            
            document.querySelector('[data-section="tariffDetailsModal"]').addEventListener('click', () => {
                setTimeout(() => {
                    document.getElementById('householdTariffChartContainer').style.display = 'block';
                    document.getElementById('otherCategoriesTariffChartContainer').style.display = 'block';
                    
                    if (!document.getElementById('householdTariffChart').chart) {
                        createTariffCharts();
                    }
                }, 100);
            });
        }

        // Initialize the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
