<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">Runaki Bill Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <!-- Chart.js Datalabels plugin CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --secondary-green: #22c55e; /* A fresh green */
            --accent-orange: #f97316; /* A warm orange */
            --accent-purple: #8b5cf6; /* A soft purple */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --highlight-yellow: #facc15; /* Yellow for highlights */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c; /* Deep dark background */
            --card-dark: #2d3748; /* Slightly lighter dark for cards */
            --text-light: #e2e8f0; /* Light gray for main text */
            --text-medium-light: #a0aec0; /* Medium light gray for labels */
            --input-dark-bg: #4a5568; /* Darker input background */
            --input-dark-border: #6b7280; /* Darker input border */
            --result-item-dark-bg: #3c4a5c; /* Darker result item background */
            --result-item-dark-border: #5a6a7c; /* Darker result item border */
            --primary-blue-darker: #2563eb; /* A slightly darker blue for accents on dark background */
            --highlight-yellow-dark: #fbbf24; /* Brighter yellow for dark background */
            
            /* Dynamic colors for result displays */
            --manual-result-color: #fef08a; /* Light yellow */
            --manual-highlight-color: #fbbf24; /* Brighter yellow */
            --meter-result-color: #bbf7d0; /* Light green */
            --meter-highlight-color: #86efac; /* Brighter green */
            --device-result-color: #a7f3d0; /* Light teal/cyan */
            --device-highlight-color: #5eead4; /* Brighter teal/cyan */
            --optimization-result-color: #bfdbfe; /* Light blue */
            --optimization-highlight-color: #93c5fd; /* Brighter blue */
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Night mode background */
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--text-light); /* Night mode text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        /* RTL specific styles */
        body.rtl {
            direction: rtl;
        }
        body.rtl h1,
        body.rtl h2,
        body.rtl .section-card,
        body.rtl footer {
            text-align: right;
        }
        body.rtl .text-left {
            text-align: right;
        }
        body.rtl .items-start {
            align-items: flex-end;
        }
        body.rtl .modal-close-button {
            right: unset;
            left: 1rem;
        }
        
        /* Language selector styling */
        .lang-btn {
            transition: background-color 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            width: 3rem;
            height: 3rem;
            font-weight: bold;
        }
        .lang-btn.active {
            border-color: var(--primary-blue);
            background-color: var(--input-dark-bg);
            color: white;
        }
        .lang-btn:not(.active) {
            background-color: var(--card-dark);
            color: var(--text-medium-light);
        }

        h1 {
            color: white; /* Changed to white as requested */
            font-weight: 800;
            margin-bottom: 1.5rem; /* Reduced margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--text-light); /* Night mode heading color */
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column; /* Always column layout */
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max-width for single column */
            background-color: var(--card-dark); /* Night mode card background */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); /* Stronger, diffused shadow for dark mode */
        }

        .section-card {
            background-color: var(--card-dark); /* Night mode card background */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light); /* Night mode label color */
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text color */
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker); /* Night mode focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Soft blue glow on focus for night mode */
            outline: none;
        }

        /* General button styling */
        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: none; /* Removed border */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Dark text for light grey button */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Light grey background */
        }

        button.btn-action {
            color: var(--highlight-yellow-dark);
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker grey on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Keep background light grey when active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); /* Adjusted min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
            max-width: 40rem; /* Max width for the grid itself */
            margin-left: auto; /* Center the grid */
            margin-right: auto; /* Center the grid */
        }

        .result-item {
            background-color: var(--result-item-dark-bg); /* Night mode result item background */
            border: 1px solid var(--result-item-dark-border); /* Night mode result item border */
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: var(--text-medium-light); /* Night mode result label color */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            /* Use dynamic CSS variables for color */
            color: var(--current-result-color); 
            font-size: 1.25rem; /* Larger font for values */
            transition: color 0.2s ease-in-out; /* Smooth transition for color flash */
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { color: var(--current-result-color); } /* Start with dynamic color */
            16.6% { color: var(--current-highlight-color); } /* Flash brighter dynamic color */
            33.3% { color: var(--current-result-color); } /* Back to dynamic color */
            50% { color: var(--current-highlight-color); } /* Flash brighter dynamic color again */
            66.6% { color: var(--current-result-color); } /* Back to dynamic color */
            83.3% { color: var(--current-highlight-color); } /* Flash brighter dynamic color one last time */
            100% { color: var(--current-result-color); } /* End with dynamic color */
        }

        .flash-animation {
            animation: flashEffect 1.8s ease-out; /* 3 flashes over 1.8 seconds */
        }

        /* Chart container styling */
        .chart-container {
            width: 100%;
            height: 300px; /* Fixed height for chart */
            margin-top: 2rem; 
            background-color: var(--card-dark); 
            border-radius: 1rem;
            padding: 1.5rem; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 500px; /* Slightly taller table */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem;
            margin-bottom: 2rem; /* Increased margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Stronger shadow for dark mode */
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too narrow on small screens */
        }

        .device-table th, .device-table td {
            padding: 1rem 0.8rem; /* More padding */
            text-align: center;
            border-bottom: 1px solid var(--input-dark-border); /* Night mode border */
            font-size: 0.95rem; /* Slightly larger font */
        }

        .device-table th {
            background-color: var(--input-dark-bg); /* Night mode header background */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light); /* Night mode header text */
        }

        .device-table tbody tr:hover {
            background-color: #3a475c; /* Darker hover effect for table rows */
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640; /* Light blue highlight on dark background */
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker); /* Blue border on selected row */
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.4rem;
            text-align: center;
            font-size: 0.9rem;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text */
        }

        .device-table input[type="checkbox"] {
            width: 1.2rem; /* Slightly larger checkbox */
            height: 1.2rem;
            cursor: pointer;
            border-radius: 0.3rem;
            accent-color: var(--primary-blue-darker); /* Night mode checkbox accent */
        }

        .device-table .output-cell {
            background-color: #2a3a4c; /* Darker blue for output values */
            font-weight: 600;
            color: var(--primary-blue-darker); /* A subtle blue for output values */
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
        }

        /* Custom Modal for Tariff Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-dark); /* Night mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: var(--text-light); /* Night mode modal text */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light); /* Night mode close button color */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: var(--primary-blue-darker); /* Night mode close button hover */
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue-darker); /* Night mode modal heading color */
            margin-bottom: 1rem;
        }

        .modal-content pre {
            background-color: #1a202c; /* Deeper dark for code/preformatted text */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a0aec0; /* Lighter text for code */
        }

        /* Footer */
        footer {
            color: var(--text-medium-light); /* Night mode footer text */
            margin-top: 8rem; /* Increased margin-top for footer */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        /* Message Box Styling */
        #appMessage {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            color: white; /* Default text color for messages */
        }

        #appMessage.show {
            opacity: 1;
            transform: translateY(0);
        }

        #appMessage.info { background-color: #3b82f6; } /* Blue for info */
        #appMessage.success { background-color: #22c55e; } /* Green for success */
        #appMessage.error { background-color: #ef4444; } /* Red for error */

        /* Report Modal Specific Styles */
        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue-darker);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-blue-darker);
            padding-bottom: 0.5rem;
        }

        .report-item-label {
            font-weight: 600;
            color: var(--text-medium-light);
            margin-right: 0.5rem;
        }

        .report-item-value {
            font-weight: 700;
            color: var(--text-light);
        }

        .report-breakdown-item {
            margin-left: 1rem;
            font-size: 0.95rem;
            color: var(--text-medium-light);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--input-dark-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .report-table th, .report-table td {
            padding: 0.75rem;
            border: 1px solid var(--input-dark-border);
            text-align: left;
            color: var(--text-light);
        }
        .report-table th {
            background-color: var(--primary-blue-darker);
            color: white;
            font-weight: 700;
        }
        .report-table tbody tr:nth-child(even) {
            background-color: #3a475c; /* Slightly different background for even rows */
        }
    </style>
</head>
<body>
    <h1 class="text-3xl lg:text-4xl" data-lang-key="mainTitle">Runaki Bill Assistant</h1>
    
    <!-- Language Selection Buttons -->
    <div id="languageSelectorTop" class="mb-6 flex justify-center gap-2">
        <button id="lang-en" class="lang-btn">EN</button>
        <button id="lang-ar" class="lang-btn">AR</button>
        <button id="lang-ku" class="lang-btn">KU</button>
    </div>

    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-8">

            <!-- 1. Manual Calculation -->
            <div class="section-card" id="manualCalculationSection">
                <h2 class="text-xl" data-lang-key="manualCalculationTitle">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Heavy Industry" data-lang-key="heavyIndustryOption">Heavy Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>
                    <label for="manualInputTypeDropdown" data-lang-key="inputLabel">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh" data-lang-key="kwhOption">kWh</option>
                        <option value="Avg Amperes" data-lang-key="avgAmperesOption">Avg Amperes</option>
                        <option value="Given Bill" data-lang-key="givenBillOption">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn btn-action w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgAmperesLabel">Avg Amperes</div>
                        <div class="result-value" id="manualAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgRateLabel">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="manualReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>

            <!-- 2. By Meter Calculation -->
            <div class="section-card" id="meterCalculationSection" style="display: none;">
                <h2 class="text-xl" data-lang-key="meterCalculationTitle">2. By Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterPrevReading" data-lang-key="prevReadingLabel">Prev Reading:</label>
                    <input type="number" id="meterPrevReading" value="31051" class="w-24">
                    <label for="meterCurrReading" data-lang-key="currReadingLabel">Curr Reading:</label>
                    <input type="number" id="meterCurrReading" value="31910" class="w-24">
                    <label for="daysInput" data-lang-key="daysLabel">Days:</label>
                    <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16">
                </div>
                <button id="calculateMeterButton" class="btn btn-action w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="dailyConsumptionLabel">Daily Consumption</div>
                        <div class="result-value" id="meterDailyKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgRateLabel">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="meterReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>

            <!-- 3. By Devices Calculation -->
            <div class="section-card" id="deviceCalculationSection" style="display: none;">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <h2 class="text-xl mb-4 md:mb-0" data-lang-key="deviceCalculationTitle">3. By Devices Calculation</h2>
                    <div class="flex flex-row space-x-2">
                        <button id="addDeviceButton" class="btn">
                            <span data-lang-key="addDeviceButton">Add Device</span>
                        </button>
                        <button id="exportDeviceButton" class="btn">
                            <span data-lang-key="exportButton">Export</span>
                        </button>
                        <button id="importDeviceButton" class="btn">
                            <span data-lang-key="importButton">Import</span>
                        </button>
                        <button id="clearDeviceButton" class="btn">
                            <span data-lang-key="clearButton">Clear</span>
                        </button>
                    </div>
                </div>
                <div class="device-table-container">
                    <table class="device-table" id="deviceTable">
                        <thead>
                            <tr>
                                <th class="w-1/12" data-lang-key="selectHeader"></th>
                                <th class="w-3/12" data-lang-key="deviceNameHeader">Device Name</th>
                                <th class="w-1/12" data-lang-key="wattageHeader">Wattage (W)</th>
                                <th class="w-2/12" data-lang-key="hoursHeader">Hours/Day</th>
                                <th class="w-1/12" data-lang-key="daysHeader">Days/Month</th>
                                <th class="w-3/12" data-lang-key="consumptionHeader">Consumption (kWh)</th>
                                <th class="w-1/12" data-lang-key="actionsHeader"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="result-grid" id="deviceResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="deviceBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="deviceKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgDailyConsumptionLabel">Avg Daily Consumption</div>
                        <div class="result-value" id="deviceDailyKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgRateLabel">Avg Rate</div>
                        <div class="result-value" id="deviceAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="deviceReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>

            <!-- Buttons to toggle calculation modes -->
            <div id="calculationToggleButtons" class="flex justify-center space-x-4 mt-6">
                <button id="showManualButton" class="btn btn-action w-1/2 md:w-auto" data-lang-key="manualButton">Manual</button>
                <button id="showMeterButton" class="btn btn-action w-1/2 md:w-auto" data-lang-key="meterButton">Meter</button>
                <button id="showDeviceButton" class="btn btn-action w-1/2 md:w-auto" data-lang-key="deviceButton">Devices</button>
            </div>
            
            <!-- Overall Consumption Pie Chart -->
            <div class="section-card">
                <div class="chart-container">
                    <canvas id="consumptionPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Modal for Tariff Details -->
    <div id="tariffDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeTariffDetailsModal">&times;</button>
            <h3 data-lang-key="tariffDetailsTitle">Tariff Details</h3>
            <div class="overflow-y-auto max-h-[70vh]">
                <div id="tariffDetailsContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Reports -->
    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeReportModal">&times;</button>
            <h3 data-lang-key="reportTitle">Report</h3>
            <div class="overflow-y-auto max-h-[70vh]">
                <div id="reportContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Message box for notifications -->
    <div id="appMessage" class="hidden"></div>
    
    <footer>
        <p data-lang-key="footerCredit">Made with ❤️ by a passionate team</p>
        <p data-lang-key="disclaimer">Disclaimer: This is an estimation tool and should not be considered an official bill.</p>
        <button id="showTariffDetailsButton" class="btn btn-action text-sm mt-2" data-lang-key="tariffDetailsButton">Show Tariff Details</button>
    </footer>

    <script>
        // --- LANGUAGE & TRANSLATION SETUP ---
        const translations = {
            'en': {
                appTitle: 'Runaki Bill Assistant',
                mainTitle: 'Runaki Bill Assistant',
                householdOption: 'Household',
                commercialOption: 'Commercial',
                agricultureOption: 'Agriculture',
                industrialOption: 'Industrial',
                heavyIndustryOption: 'Heavy Industry',
                stateOption: 'State',
                manualButton: 'Manual',
                meterButton: 'Meter',
                deviceButton: 'Devices',
                calculateBillButton: 'Calculate Bill',
                generateReportButton: 'Generate Report',
                categoryLabel: 'Category:',
                inputLabel: 'Input:',
                kwhOption: 'kWh',
                avgAmperesOption: 'Avg Amperes',
                givenBillOption: 'Given Bill (IQD)',
                billLabel: 'Bill',
                consumptionLabel: 'Consumption',
                avgAmperesLabel: 'Avg Amperes',
                avgRateLabel: 'Avg Rate',
                prevReadingLabel: 'Prev Reading:',
                currReadingLabel: 'Curr Reading:',
                daysLabel: 'Days:',
                dailyConsumptionLabel: 'Daily Consumption',
                avgDailyConsumptionLabel: 'Avg Daily Consumption',
                addDeviceButton: 'Add Device',
                exportButton: 'Export',
                importButton: 'Import',
                clearButton: 'Clear',
                selectHeader: 'Select',
                deviceNameHeader: 'Device Name',
                wattageHeader: 'Wattage (W)',
                hoursHeader: 'Hours/Day',
                daysHeader: 'Days/Month',
                consumptionHeader: 'Consumption (kWh)',
                actionsHeader: 'Actions',
                deleteButton: 'Delete',
                manualCalculationTitle: '1. Manual Calculation',
                meterCalculationTitle: '2. By Meter Calculation',
                deviceCalculationTitle: '3. By Devices Calculation',
                tariffDetailsTitle: 'Tariff Details',
                reportTitle: 'Report',
                footerCredit: 'Made with ❤️ by a passionate team',
                disclaimer: 'Disclaimer: This is an estimation tool and should not be considered an official bill.',
                tariffDetailsButton: 'Show Tariff Details',
                error_invalidInput: 'Please enter a valid number for all inputs.',
                error_invalidMeterReadings: 'Current reading must be greater than previous reading.',
                reportTitle: 'Electricity Consumption Report',
                report_category: 'Calculation Category',
                report_input: 'Input Value',
                report_kwh: 'Total kWh Consumption',
                report_bill: 'Total Bill (IQD)',
                report_avgRate: 'Average Rate (IQD/kWh)',
                report_household_title: 'Household Tariff Breakdown',
                report_step: 'Step',
                report_rate: 'Rate',
                report_kwh_range: 'kWh Range',
                report_cost: 'Cost',
                report_total: 'Total',
                report_consumption: 'Consumption',
                report_other_tariff: 'Flat Rate Tariff',
                report_device_title: 'Device Consumption Breakdown',
                report_device_table_name: 'Device Name',
                report_device_table_watts: 'Watts',
                report_device_table_hours: 'Hrs/Day',
                report_device_table_days: 'Days/Month',
                report_device_table_kwh: 'Consumption (kWh)',
                report_device_table_cost: 'Cost (IQD)',
                report_no_devices_added: 'No devices have been added yet.',
                success_exported: 'Device list exported successfully!',
                success_imported: 'Device list imported successfully!',
                error_import: 'Invalid file format. Please import a valid JSON file.',
                confirm_clear_devices: 'Are you sure you want to clear all devices?',
                tariff_household_title: 'Household Tariff (kWh)',
                tariff_commercial_title: 'Commercial Tariff (kWh)',
                tariff_agriculture_title: 'Agriculture Tariff (kWh)',
                tariff_industrial_title: 'Industrial Tariff (kWh)',
                tariff_heavy_industry_title: 'Heavy Industry Tariff (kWh)',
                tariff_state_title: 'State Tariff (kWh)',
                
            },
            'ar': {
                appTitle: 'مساعد فواتير رونكي',
                mainTitle: 'مساعد فواتير رونكي',
                householdOption: 'منزلي',
                commercialOption: 'تجاري',
                agricultureOption: 'زراعي',
                industrialOption: 'صناعي',
                heavyIndustryOption: 'صناعة ثقيلة',
                stateOption: 'حكومي',
                manualButton: 'يدوي',
                meterButton: 'بالعداد',
                deviceButton: 'بالأجهزة',
                calculateBillButton: 'حساب الفاتورة',
                generateReportButton: 'إنشاء تقرير',
                categoryLabel: 'الفئة:',
                inputLabel: 'الإدخال:',
                kwhOption: 'كيلوواط ساعة',
                avgAmperesOption: 'معدل الأمبير',
                givenBillOption: 'فاتورة معطاة (دينار)',
                billLabel: 'الفاتورة',
                consumptionLabel: 'الاستهلاك',
                avgAmperesLabel: 'معدل الأمبير',
                avgRateLabel: 'معدل السعر',
                prevReadingLabel: 'القراءة السابقة:',
                currReadingLabel: 'القراءة الحالية:',
                daysLabel: 'الأيام:',
                dailyConsumptionLabel: 'الاستهلاك اليومي',
                avgDailyConsumptionLabel: 'معدل الاستهلاك اليومي',
                addDeviceButton: 'أضف جهاز',
                exportButton: 'تصدير',
                importButton: 'استيراد',
                clearButton: 'مسح',
                selectHeader: 'تحديد',
                deviceNameHeader: 'اسم الجهاز',
                wattageHeader: 'القدرة (واط)',
                hoursHeader: 'ساعات/يوم',
                daysHeader: 'أيام/شهر',
                consumptionHeader: 'الاستهلاك (كيلوواط ساعة)',
                actionsHeader: 'إجراءات',
                deleteButton: 'حذف',
                manualCalculationTitle: '1. الحساب اليدوي',
                meterCalculationTitle: '2. الحساب بالعداد',
                deviceCalculationTitle: '3. الحساب بالأجهزة',
                tariffDetailsTitle: 'تفاصيل التعريفة',
                reportTitle: 'تقرير',
                footerCredit: 'صنع بـ ❤️ بواسطة فريق شغوف',
                disclaimer: 'تنويه: هذه أداة تقديرية ولا تعتبر فاتورة رسمية.',
                tariffDetailsButton: 'عرض تفاصيل التعريفة',
                error_invalidInput: 'الرجاء إدخال رقم صحيح لجميع المدخلات.',
                error_invalidMeterReadings: 'يجب أن تكون القراءة الحالية أكبر من السابقة.',
                reportTitle: 'تقرير استهلاك الكهرباء',
                report_category: 'فئة الحساب',
                report_input: 'قيمة الإدخال',
                report_kwh: 'إجمالي استهلاك الكيلوواط ساعة',
                report_bill: 'إجمالي الفاتورة (دينار)',
                report_avgRate: 'معدل السعر (دينار/ك.و.س)',
                report_household_title: 'تفاصيل تعريفة المنزلية',
                report_step: 'الخطوة',
                report_rate: 'السعر',
                report_kwh_range: 'نطاق الكيلوواط ساعة',
                report_cost: 'التكلفة',
                report_total: 'الإجمالي',
                report_consumption: 'الاستهلاك',
                report_other_tariff: 'تعريفة سعر ثابت',
                report_device_title: 'تفاصيل استهلاك الأجهزة',
                report_device_table_name: 'اسم الجهاز',
                report_device_table_watts: 'واط',
                report_device_table_hours: 'ساعة/يوم',
                report_device_table_days: 'يوم/شهر',
                report_device_table_kwh: 'الاستهلاك (ك.و.س)',
                report_device_table_cost: 'التكلفة (دينار)',
                report_no_devices_added: 'لم تتم إضافة أي أجهزة بعد.',
                success_exported: 'تم تصدير قائمة الأجهزة بنجاح!',
                success_imported: 'تم استيراد قائمة الأجهزة بنجاح!',
                error_import: 'تنسيق الملف غير صالح. الرجاء استيراد ملف JSON صحيح.',
                confirm_clear_devices: 'هل أنت متأكد أنك تريد مسح جميع الأجهزة؟',
                tariff_household_title: 'تعريفة المنزلية (كيلوواط ساعة)',
                tariff_commercial_title: 'تعريفة التجارية (كيلوواط ساعة)',
                tariff_agriculture_title: 'تعريفة الزراعية (كيلوواط ساعة)',
                tariff_industrial_title: 'تعريفة الصناعية (كيلوواط ساعة)',
                tariff_heavy_industry_title: 'تعريفة الصناعة الثقيلة (كيلوواط ساعة)',
                tariff_state_title: 'تعريفة الحكومية (كيلوواط ساعة)',
            },
            'ku': {
                appTitle: 'یارمەتیدەری فاتیۆرە روناکی',
                mainTitle: 'یارمەتیدەری فاتیۆرە روناکی',
                householdOption: 'ماڵ',
                commercialOption: 'بازرگانی',
                agricultureOption: 'کشتوکاڵ',
                industrialOption: 'پیشەسازی',
                heavyIndustryOption: 'پیشەسازی قورس',
                stateOption: 'حکومی',
                manualButton: 'دەستی',
                meterButton: 'بە پێوەر',
                deviceButton: 'بە ئامێرەکان',
                calculateBillButton: 'حسابکردنی فاتیۆرە',
                generateReportButton: 'دروستکردنی ڕاپۆرت',
                categoryLabel: 'جۆر:',
                inputLabel: 'داخڵکردن:',
                kwhOption: 'کیلۆوات کاتژمێر',
                avgAmperesOption: 'تێکڕای ئەمپێر',
                givenBillOption: 'فاتیۆرەی دراو (دینار)',
                billLabel: 'فاتیۆرە',
                consumptionLabel: 'بەکارهێنان',
                avgAmperesLabel: 'تێکڕای ئەمپێر',
                avgRateLabel: 'تێکڕای نرخ',
                prevReadingLabel: 'خوێندنەوەی پێشوو:',
                currReadingLabel: 'خوێندنەوەی ئێستا:',
                daysLabel: 'ڕۆژ:',
                dailyConsumptionLabel: 'بەکارهێنانی ڕۆژانە',
                avgDailyConsumptionLabel: 'تێکڕای بەکارهێنانی ڕۆژانە',
                addDeviceButton: 'زیادکردنی ئامێر',
                exportButton: 'هەناردەکردن',
                importButton: 'هاوردەکردن',
                clearButton: 'پاککردنەوە',
                selectHeader: 'هەڵبژاردن',
                deviceNameHeader: 'ناوی ئامێر',
                wattageHeader: 'توانا (وات)',
                hoursHeader: 'کاتژمێر/ڕۆژ',
                daysHeader: 'ڕۆژ/مانگ',
                consumptionHeader: 'بەکارهێنان (ک.و.ک)',
                actionsHeader: 'کردارەکان',
                deleteButton: 'سڕینەوە',
                manualCalculationTitle: '1. حسابکردنی دەستی',
                meterCalculationTitle: '2. حسابکردن بە پێوەر',
                deviceCalculationTitle: '3. حسابکردن بە ئامێرەکان',
                tariffDetailsTitle: 'وردەکارییەکانی تاریفە',
                reportTitle: 'ڕاپۆرت',
                footerCredit: 'دروستکراوە بە ❤️ لەلایەن تیمێکی دڵسۆز',
                disclaimer: 'ئاگاداری: ئەمە ئامێرێکی خەمڵاندنە و نابێت بە فاتیۆرەی فەرمی دابنرێت.',
                tariffDetailsButton: 'پیشاندانی وردەکارییەکانی تاریفە',
                error_invalidInput: 'تکایە ژمارەیەکی دروست داخڵ بکە بۆ هەموو داخڵکردنەکان.',
                error_invalidMeterReadings: 'پێویستە خوێندنەوەی ئێستا لە خوێندنەوەی پێشوو گەورەتر بێت.',
                reportTitle: 'ڕاپۆرتی بەکارهێنانی کارەبا',
                report_category: 'جۆری حسابکردن',
                report_input: 'بەهای داخڵکراو',
                report_kwh: 'کۆی بەکارهێنانی ک.و.ک',
                report_bill: 'کۆی فاتیۆرە (دینار)',
                report_avgRate: 'تێکڕای نرخ (دینار/ک.و.ک)',
                report_household_title: 'وردەکارییەکانی تاریفەی ماڵ',
                report_step: 'هەنگاو',
                report_rate: 'نرخ',
                report_kwh_range: 'مەودای ک.و.ک',
                report_cost: 'تێچوو',
                report_total: 'کۆ',
                report_consumption: 'بەکارهێنان',
                report_other_tariff: 'تاریفەی نرخی جێگیر',
                report_device_title: 'وردەکارییەکانی بەکارهێنانی ئامێر',
                report_device_table_name: 'ناوی ئامێر',
                report_device_table_watts: 'وات',
                report_device_table_hours: 'کاتژمێر/ڕۆژ',
                report_device_table_days: 'ڕۆژ/مانگ',
                report_device_table_kwh: 'بەکارهێنان (ک.و.ک)',
                report_device_table_cost: 'تێچوو (دینار)',
                report_no_devices_added: 'هیچ ئامێرێک زیاد نەکراوە.',
                success_exported: 'لیستی ئامێرەکان بە سەرکەوتوویی هەناردە کرا!',
                success_imported: 'لیستی ئامێرەکان بە سەرکەوتوویی هاوردە کرا!',
                error_import: 'شێوازی فایلەکە هەڵەیە. تکایە فایلێکی JSON دروست هاوردە بکە.',
                confirm_clear_devices: 'ئایا دڵنیایت کە دەتەوێت هەموو ئامێرەکان بسڕیتەوە؟',
                tariff_household_title: 'تاریفەی ماڵ (ک.و.ک)',
                tariff_commercial_title: 'تاریفەی بازرگانی (ک.و.ک)',
                tariff_agriculture_title: 'تاریفەی کشتوکاڵ (ک.و.ک)',
                tariff_industrial_title: 'تاریفەی پیشەسازی (ک.و.ک)',
                tariff_heavy_industry_title: 'تاریفەی پیشەسازی قورس (ک.و.ک)',
                tariff_state_title: 'تاریفەی حکومی (ک.و.ک)',
            }
        };

        const languageButtons = document.querySelectorAll('.lang-btn');
        const langEnButton = document.getElementById('lang-en');
        const langArButton = document.getElementById('lang-ar');
        const langKuButton = document.getElementById('lang-ku');
        let currentLanguage = 'en'; // Default language

        function setActiveLanguage(lang) {
            currentLanguage = lang;
            document.body.className = lang === 'ar' || lang === 'ku' ? 'rtl' : 'ltr';

            languageButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            updateTextContent();
            updateChartLabels();
            updatePlaceholderText();
        }

        function updateTextContent() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }

        function updatePlaceholderText() {
             // Placeholder for device name input, if it exists
             const deviceNameInputs = document.querySelectorAll('.device-name-input');
             deviceNameInputs.forEach(input => {
                 input.placeholder = translations[currentLanguage]['deviceNameHeader'];
             });
        }
        
        // Event listeners for language buttons
        langEnButton.addEventListener('click', () => setActiveLanguage('en'));
        langArButton.addEventListener('click', () => setActiveLanguage('ar'));
        langKuButton.addEventListener('click', () => setActiveLanguage('ku'));


        // --- TARIFF DATA ---
        // New tariff data based on user request
        const tariffs = {
            'Household': [
                { limit: 400, rate: 72 },
                { limit: 800, rate: 108 },
                { limit: 1200, rate: 175 },
                { limit: 1600, rate: 265 },
                { limit: Infinity, rate: 350 }
            ],
            'Commercial': 185,
            'Agriculture': 60,
            'Industrial': 160,
            'Heavy Industry': 125,
            'State': 160
        };

        // --- CALCULATION LOGIC ---

        /**
         * Calculates the total bill for a given kWh consumption based on the tariff category.
         * @param {number} kwhConsumption - The total kWh consumed.
         * @param {string} category - The tariff category (e.g., 'Household', 'Commercial').
         * @returns {object} An object containing the total bill and a breakdown of costs.
         */
        function calculateBill(kwhConsumption, category) {
            let totalBill = 0;
            let breakdown = [];
            let avgRate = 0;

            if (category === 'Household') {
                let remainingKwh = kwhConsumption;
                let previousLimit = 0;

                for (const tier of tariffs.Household) {
                    if (remainingKwh <= 0) break;

                    const kwhInTier = Math.min(remainingKwh, tier.limit - previousLimit);
                    const costInTier = kwhInTier * tier.rate;

                    totalBill += costInTier;
                    breakdown.push({
                        kwhRange: `${previousLimit + 1} - ${tier.limit === Infinity ? '+' : tier.limit}`,
                        kwhConsumed: kwhInTier,
                        rate: tier.rate,
                        cost: costInTier
                    });

                    remainingKwh -= kwhInTier;
                    previousLimit = tier.limit;
                }
            } else {
                const rate = tariffs[category] || 0;
                totalBill = kwhConsumption * rate;
                breakdown.push({
                    rate: rate,
                    cost: totalBill,
                    kwhConsumed: kwhConsumption
                });
            }

            if (kwhConsumption > 0) {
                avgRate = totalBill / kwhConsumption;
            }

            return { totalBill, avgRate, breakdown };
        }

        // Helper function to animate a result value with a flash effect
        function animateResult(element, value, suffix, highlightColor, defaultColor) {
            element.style.setProperty('--current-result-color', defaultColor);
            element.style.setProperty('--current-highlight-color', highlightColor);
            element.classList.add('flash-animation');
            element.textContent = `${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${suffix}`;
            
            // Remove the animation class after it completes
            element.addEventListener('animationend', () => {
                element.classList.remove('flash-animation');
            }, { once: true });
        }


        // --- MANUAL CALCULATION FUNCTIONS ---
        function performManualCalculation() {
            const inputType = document.getElementById('manualInputTypeDropdown').value;
            const inputValue = parseFloat(document.getElementById('manualInput').value);
            const category = document.getElementById('categoryDropdown').value;
            const days = 30; // Assuming a standard month for manual calc
            let kwh = 0;
            let bill = 0;
            let avgAmperes = 0;
            let breakdown = [];
            let avgRate = 0;
            const voltage = 220; // Assuming a standard voltage

            if (isNaN(inputValue) || inputValue < 0) {
                showMessage('error', translations[currentLanguage].error_invalidInput);
                return;
            }

            if (inputType === 'kWh') {
                kwh = inputValue;
                const result = calculateBill(kwh, category);
                bill = result.totalBill;
                avgRate = result.avgRate;
                breakdown = result.breakdown;
                avgAmperes = (kwh * 1000) / (voltage * 24 * days);
            } else if (inputType === 'Avg Amperes') {
                avgAmperes = inputValue;
                kwh = (avgAmperes * voltage * 24 * days) / 1000;
                const result = calculateBill(kwh, category);
                bill = result.totalBill;
                avgRate = result.avgRate;
                breakdown = result.breakdown;
            } else if (inputType === 'Given Bill') {
                bill = inputValue;
                // This is a complex reverse calculation, for simplicity let's approximate or just show the bill
                kwh = 0; // Reverse calculation from bill to kWh is non-linear for household tariff
                avgAmperes = 0;
                avgRate = 0;
                if (category !== 'Household') {
                    // For flat rate, we can calculate kWh
                    const rate = tariffs[category];
                    if (rate > 0) {
                        kwh = bill / rate;
                        avgRate = rate;
                        avgAmperes = (kwh * 1000) / (voltage * 24 * days);
                    }
                }
                breakdown = [];
            }
            
            const manualBill = document.getElementById('manualBill');
            const manualKwh = document.getElementById('manualKwh');
            const manualAmperes = document.getElementById('manualAmperes');
            const manualAvgRate = document.getElementById('manualAvgRate');

            animateResult(manualBill, bill, 'IQD', 'var(--manual-highlight-color)', 'var(--manual-result-color)');
            animateResult(manualKwh, kwh, 'kWh', 'var(--manual-highlight-color)', 'var(--manual-result-color)');
            animateResult(manualAmperes, avgAmperes, 'A', 'var(--manual-highlight-color)', 'var(--manual-result-color)');
            animateResult(manualAvgRate, avgRate, 'IQD/kWh', 'var(--manual-highlight-color)', 'var(--manual-result-color)');

            manualCalculationData = { category, inputType, inputValue, kwh, bill, avgAmperes, avgRate, breakdown, type: 'manual' };
            updateConsumptionPieChart();
        }

        // --- METER CALCULATION FUNCTIONS ---
        function performMeterCalculation() {
            const prevReading = parseFloat(document.getElementById('meterPrevReading').value);
            const currReading = parseFloat(document.getElementById('meterCurrReading').value);
            const days = parseFloat(document.getElementById('daysInput').value);
            const category = 'Household'; // Meter calculation is typically for households

            if (isNaN(prevReading) || isNaN(currReading) || isNaN(days) || prevReading < 0 || currReading < 0 || days <= 0) {
                showMessage('error', translations[currentLanguage].error_invalidInput);
                return;
            }

            if (currReading < prevReading) {
                showMessage('error', translations[currentLanguage].error_invalidMeterReadings);
                return;
            }

            const kwh = currReading - prevReading;
            const dailyKwh = kwh / days;
            const { totalBill: bill, avgRate, breakdown } = calculateBill(kwh, category);

            const meterBill = document.getElementById('meterBill');
            const meterKwh = document.getElementById('meterKwh');
            const meterDailyKwh = document.getElementById('meterDailyKwh');
            const meterAvgRate = document.getElementById('meterAvgRate');

            animateResult(meterBill, bill, 'IQD', 'var(--meter-highlight-color)', 'var(--meter-result-color)');
            animateResult(meterKwh, kwh, 'kWh', 'var(--meter-highlight-color)', 'var(--meter-result-color)');
            animateResult(meterDailyKwh, dailyKwh, 'kWh', 'var(--meter-highlight-color)', 'var(--meter-result-color)');
            animateResult(meterAvgRate, avgRate, 'IQD/kWh', 'var(--meter-highlight-color)', 'var(--meter-result-color)');

            meterCalculationData = { category, kwh, bill, avgRate, breakdown, days, type: 'meter' };
            updateConsumptionPieChart();
        }
        
        // --- DEVICE CALCULATION LOGIC ---
        let devices = JSON.parse(localStorage.getItem('devices')) || [];
        const deviceTableBody = document.querySelector('#deviceTable tbody');

        /**
         * Calculates the total consumption for all devices.
         */
        function calculateDeviceConsumption() {
            let totalKwh = 0;
            let totalDailyKwh = 0;
            let totalCost = 0;
            let avgRate = 0;
            const category = 'Household'; // Devices are typically household
            const tableRows = deviceTableBody.querySelectorAll('tr');

            // Clear old data and recalculate from current table
            devices = [];
            tableRows.forEach(row => {
                const name = row.querySelector('.device-name-input').value;
                const wattage = parseFloat(row.querySelector('.device-wattage-input').value) || 0;
                const hours = parseFloat(row.querySelector('.device-hours-input').value) || 0;
                const days = parseFloat(row.querySelector('.device-days-input').value) || 0;
                const isSelected = row.querySelector('.device-checkbox').checked;
                
                // Only consider selected devices for calculation
                if (isSelected) {
                    const consumption = (wattage * hours * days) / 1000;
                    totalKwh += consumption;
                    totalDailyKwh += (wattage * hours) / 1000;
                }
                
                // Always store the full device list, regardless of selection
                devices.push({ name, wattage, hours, days, isSelected });
            });
            
            // Recalculate bill and breakdown based on total kWh
            const { totalBill: bill, avgRate: calculatedAvgRate, breakdown } = calculateBill(totalKwh, category);
            totalCost = bill;
            avgRate = calculatedAvgRate;

            const deviceBill = document.getElementById('deviceBill');
            const deviceKwh = document.getElementById('deviceKwh');
            const deviceDailyKwh = document.getElementById('deviceDailyKwh');
            const deviceAvgRate = document.getElementById('deviceAvgRate');

            // Update the output cells in the table for each device
            // This is a bit inefficient, but necessary for real-time updates
            updateDeviceConsumptionCells(totalKwh);
            
            animateResult(deviceBill, totalCost, 'IQD', 'var(--device-highlight-color)', 'var(--device-result-color)');
            animateResult(deviceKwh, totalKwh, 'kWh', 'var(--device-highlight-color)', 'var(--device-result-color)');
            animateResult(deviceDailyKwh, totalDailyKwh, 'kWh', 'var(--device-highlight-color)', 'var(--device-result-color)');
            animateResult(deviceAvgRate, avgRate, 'IQD/kWh', 'var(--device-highlight-color)', 'var(--device-result-color)');
            
            deviceCalculationData = { category, devices, totalKwh, totalCost, avgRate, breakdown, type: 'device' };
            updateConsumptionPieChart();
            saveDevices();
        }

        /**
         * Updates the consumption and cost cells for each device in the table based on a proportional breakdown.
         * @param {number} totalKwh - The total kWh of all selected devices.
         */
        function updateDeviceConsumptionCells(totalKwh) {
            const category = 'Household';
            const tableRows = deviceTableBody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const wattage = parseFloat(row.querySelector('.device-wattage-input').value) || 0;
                const hours = parseFloat(row.querySelector('.device-hours-input').value) || 0;
                const days = parseFloat(row.querySelector('.device-days-input').value) || 0;
                const isSelected = row.querySelector('.device-checkbox').checked;

                const deviceConsumptionCell = row.querySelector('.device-consumption-output');
                const deviceCostCell = row.querySelector('.device-cost-output');
                const deleteButton = row.querySelector('.device-delete-button');

                if (isSelected) {
                    const deviceKwh = (wattage * hours * days) / 1000;
                    const { totalBill: deviceCost } = calculateBill(deviceKwh, category);
                    
                    deviceConsumptionCell.textContent = `${deviceKwh.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kWh`;
                    deviceCostCell.textContent = `${deviceCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} IQD`;
                } else {
                    // Set to 0 if not selected
                    deviceConsumptionCell.textContent = '0.00 kWh';
                    deviceCostCell.textContent = '0.00 IQD';
                }
            });
        }
        
        /**
         * Adds a new device row to the table.
         * @param {object} device - Optional device object to populate the row.
         */
        function addDeviceRow(device = {}) {
            const newRow = document.createElement('tr');
            const isSelected = device.isSelected === undefined ? true : device.isSelected;
            
            newRow.innerHTML = `
                <td class="align-middle">
                    <input type="checkbox" class="device-checkbox" ${isSelected ? 'checked' : ''}>
                </td>
                <td>
                    <input type="text" class="device-name-input" value="${device.name || ''}" placeholder="${translations[currentLanguage]['deviceNameHeader']}">
                </td>
                <td>
                    <input type="number" class="device-wattage-input" value="${device.wattage || ''}" min="0">
                </td>
                <td>
                    <input type="number" class="device-hours-input" value="${device.hours || ''}" min="0" max="24">
                </td>
                <td>
                    <input type="number" class="device-days-input" value="${device.days || ''}" min="0" max="31">
                </td>
                <td class="output-cell device-consumption-output">0.00 kWh</td>
                <td>
                    <button class="device-delete-button bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 active:bg-red-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;

            deviceTableBody.appendChild(newRow);

            // Add event listeners to the new row's inputs
            const inputs = newRow.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    calculateDeviceConsumption();
                    updateDeviceConsumptionCells();
                    // Update the highlight for the current row
                    newRow.classList.add('selected-row');
                    setTimeout(() => newRow.classList.remove('selected-row'), 1000);
                });
            });

            // Add delete button functionality
            newRow.querySelector('.device-delete-button').addEventListener('click', () => {
                newRow.remove();
                calculateDeviceConsumption();
            });

            // Add checkbox functionality
            newRow.querySelector('.device-checkbox').addEventListener('change', () => {
                calculateDeviceConsumption();
            });

            // Add selected-row class on click
            newRow.addEventListener('click', () => {
                newRow.classList.add('selected-row');
                setTimeout(() => newRow.classList.remove('selected-row'), 1000);
            });
            
            // Re-run calculation for new device
            calculateDeviceConsumption();
        }

        // Populates the device table from the devices array
        function populateDeviceTable() {
            deviceTableBody.innerHTML = '';
            devices.forEach(device => addDeviceRow(device));
            calculateDeviceConsumption();
        }

        // Save devices to local storage
        function saveDevices() {
            // Re-create the devices array from the current table state
            const currentDevices = [];
            deviceTableBody.querySelectorAll('tr').forEach(row => {
                const name = row.querySelector('.device-name-input').value;
                const wattage = parseFloat(row.querySelector('.device-wattage-input').value) || 0;
                const hours = parseFloat(row.querySelector('.device-hours-input').value) || 0;
                const days = parseFloat(row.querySelector('.device-days-input').value) || 0;
                const isSelected = row.querySelector('.device-checkbox').checked;
                currentDevices.push({ name, wattage, hours, days, isSelected });
            });
            localStorage.setItem('devices', JSON.stringify(currentDevices));
        }

        // Export device data to a JSON file
        function exportDevices() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(devices));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "runaki_devices.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showMessage('success', translations[currentLanguage].success_exported);
        }

        // Import device data from a JSON file
        function importDevices() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedDevices = JSON.parse(e.target.result);
                        if (Array.isArray(importedDevices)) {
                            devices = importedDevices;
                            populateDeviceTable();
                            showMessage('success', translations[currentLanguage].success_imported);
                        } else {
                            showMessage('error', translations[currentLanguage].error_import);
                        }
                    } catch (error) {
                        showMessage('error', translations[currentLanguage].error_import);
                    }
                };
                reader.readAsText(file);
            });
            fileInput.click();
        }

        // Clear all devices from the table and local storage
        function clearDevices() {
            // Using a custom modal-like function since alert() is not allowed.
            if (confirmClearDevices()) {
                devices = [];
                populateDeviceTable();
                saveDevices();
            }
        }
        
        // A custom confirmation dialog since `window.confirm` is not available in the sandbox.
        function confirmClearDevices() {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.display = 'flex';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4">${translations[currentLanguage].confirm_clear_devices}</h3>
                <div class="flex justify-center gap-4">
                    <button id="confirmYes" class="btn bg-red-600 text-white px-4 py-2 rounded-md">Yes</button>
                    <button id="confirmNo" class="btn bg-gray-500 text-white px-4 py-2 rounded-md">No</button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            return new Promise(resolve => {
                document.getElementById('confirmYes').addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                });
                document.getElementById('confirmNo').addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                    resolve(false);
                });
            });
        }
        
        // Initial population call for the device table
        function startupPopulateDeviceTable() {
            populateDeviceTable();
            // If the table is empty, add a default row for better UX
            if (devices.length === 0) {
                 addDeviceRow({
                    name: 'Air Conditioner',
                    wattage: 1800,
                    hours: 8,
                    days: 30,
                    isSelected: true
                });
            }
        }

        // --- GLOBAL STATE & UI CONTROLS ---
        let manualCalculationData = {};
        let meterCalculationData = {};
        let deviceCalculationData = {};

        const manualSection = document.getElementById('manualCalculationSection');
        const meterSection = document.getElementById('meterCalculationSection');
        const deviceSection = document.getElementById('deviceCalculationSection');

        const showManualButton = document.getElementById('showManualButton');
        const showMeterButton = document.getElementById('showMeterButton');
        const showDeviceButton = document.getElementById('showDeviceButton');

        function toggleCalculationMode(mode) {
            manualSection.style.display = 'none';
            meterSection.style.display = 'none';
            deviceSection.style.display = 'none';

            if (mode === 'manual') {
                manualSection.style.display = 'block';
            } else if (mode === 'meter') {
                meterSection.style.display = 'block';
            } else if (mode === 'device') {
                deviceSection.style.display = 'block';
            }
            updateCalculationToggleButtons(mode);
            updateConsumptionPieChart();
        }

        // Update button active state
        function updateCalculationToggleButtons(activeMode) {
            const buttons = [showManualButton, showMeterButton, showDeviceButton];
            buttons.forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600');
                btn.classList.add('bg-gray-200');
                if (btn.id === `show${activeMode.charAt(0).toUpperCase() + activeMode.slice(1)}Button`) {
                    btn.classList.add('active', 'bg-blue-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-800');
                }
            });
        }

        // --- CHART & REPORTING ---
        let consumptionPieChart;
        const chartColors = [
            '#facc15', // yellow for manual
            '#22c55e', // green for meter
            '#a7f3d0'  // teal for device
        ];

        function createConsumptionPieChart() {
            const ctx = document.getElementById('consumptionPieChart').getContext('2d');
            consumptionPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [], // Labels will be set dynamically
                    datasets: [{
                        data: [], // Data will be set dynamically
                        backgroundColor: chartColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'var(--text-light)' // Night mode legend text
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const label = tooltipItem.label || '';
                                    const value = tooltipItem.raw;
                                    return `${label}: ${value.toFixed(2)} kWh`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((acc, current) => acc + current, 0);
                                if (total === 0) return '';
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                return percentage;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function updateConsumptionPieChart() {
            if (!consumptionPieChart) return;
            
            const data = [
                {
                    label: translations[currentLanguage].manualButton,
                    kwh: manualCalculationData.kwh || 0
                },
                {
                    label: translations[currentLanguage].meterButton,
                    kwh: meterCalculationData.kwh || 0
                },
                {
                    label: translations[currentLanguage].deviceButton,
                    kwh: deviceCalculationData.totalKwh || 0
                }
            ];

            const labels = data.map(d => d.label);
            const kwhValues = data.map(d => d.kwh);

            consumptionPieChart.data.labels = labels;
            consumptionPieChart.data.datasets[0].data = kwhValues;
            consumptionPieChart.update();
        }

        function updateChartLabels() {
            if (consumptionPieChart) {
                const labels = consumptionPieChart.data.labels;
                labels[0] = translations[currentLanguage].manualButton;
                labels[1] = translations[currentLanguage].meterButton;
                labels[2] = translations[currentLanguage].deviceButton;
                consumptionPieChart.update();
            }
        }
        
        // --- REPORT GENERATION ---
        function generateReport(data) {
            const reportContentDiv = document.getElementById('reportContent');
            reportContentDiv.innerHTML = '';
            
            if (!data || Object.keys(data).length === 0) {
                return;
            }

            const isHousehold = data.category === 'Household';
            
            // Main report summary
            let html = `
                <div class="mb-4">
                    <p class="report-section-title">${translations[currentLanguage].report_category}: <span class="report-item-value">${data.type === 'manual' ? translations[currentLanguage].manualButton : (data.type === 'meter' ? translations[currentLanguage].meterButton : translations[currentLanguage].deviceButton)}</span></p>
                    <p><span class="report-item-label">${translations[currentLanguage].report_kwh}:</span> <span class="report-item-value">${data.kwh ? data.kwh.toFixed(2) : (data.totalKwh ? data.totalKwh.toFixed(2) : '0.00')}</span> kWh</p>
                    <p><span class="report-item-label">${translations[currentLanguage].report_bill}:</span> <span class="report-item-value">${data.bill ? data.bill.toFixed(2) : (data.totalCost ? data.totalCost.toFixed(2) : '0.00')}</span> IQD</p>
                    <p><span class="report-item-label">${translations[currentLanguage].report_avgRate}:</span> <span class="report-item-value">${data.avgRate ? data.avgRate.toFixed(2) : '0.00'}</span> IQD/kWh</p>
                </div>
            `;
            
            // Tariff Breakdown
            html += `<p class="report-section-title">${isHousehold ? translations[currentLanguage].report_household_title : translations[currentLanguage].report_other_tariff}</p>`;
            
            if (isHousehold) {
                html += `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].report_kwh_range}</th>
                                <th>${translations[currentLanguage].report_consumption}</th>
                                <th>${translations[currentLanguage].report_rate} (IQD/kWh)</th>
                                <th>${translations[currentLanguage].report_cost} (IQD)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                data.breakdown.forEach(tier => {
                    html += `
                        <tr>
                            <td>${tier.kwhRange} kWh</td>
                            <td>${tier.kwhConsumed.toFixed(2)} kWh</td>
                            <td>${tier.rate}</td>
                            <td>${tier.cost.toFixed(2)} IQD</td>
                        </tr>
                    `;
                });
                html += `
                        </tbody>
                    </table>
                `;
            } else if (data.breakdown && data.breakdown.length > 0) {
                // For flat rate tariffs
                const flatRate = data.breakdown[0].rate;
                html += `
                    <p>
                        <span class="report-item-label">${translations[currentLanguage].report_rate}:</span>
                        <span class="report-item-value">${flatRate}</span> IQD/kWh
                    </p>
                `;
            }
            
            // Device Breakdown for device calculation reports
            if (data.type === 'device' && data.devices && data.devices.length > 0) {
                html += `<p class="report-section-title">${translations[currentLanguage].report_device_title}</p>`;
                html += `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].report_device_table_name}</th>
                                <th>${translations[currentLanguage].report_device_table_watts}</th>
                                <th>${translations[currentLanguage].report_device_table_hours}</th>
                                <th>${translations[currentLanguage].report_device_table_days}</th>
                                <th>${translations[currentLanguage].report_device_table_kwh}</th>
                                <th>${translations[currentLanguage].report_device_table_cost}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                data.devices.forEach(device => {
                    if (device.isSelected) {
                        const deviceKwh = (device.wattage * device.hours * device.days) / 1000;
                        const { totalBill: deviceCost } = calculateBill(deviceKwh, 'Household');
                        
                        html += `
                            <tr>
                                <td>${device.name || translations[currentLanguage].deviceNameHeader}</td>
                                <td>${device.wattage || 0} W</td>
                                <td>${device.hours || 0}</td>
                                <td>${device.days || 0}</td>
                                <td>${deviceKwh.toFixed(2)} kWh</td>
                                <td>${deviceCost.toFixed(2)} IQD</td>
                            </tr>
                        `;
                    }
                });
                html += `
                        </tbody>
                    </table>
                `;
            } else if (data.type === 'device' && (!data.devices || data.devices.length === 0)) {
                 html += `<p class="report-section-title">${translations[currentLanguage].report_device_title}</p>`;
                 html += `<p>${translations[currentLanguage].report_no_devices_added}</p>`;
            }
            
            reportContentDiv.innerHTML = html;
        }


        function showReportModal(reportData) {
            generateReport(reportData);
            document.getElementById('reportModal').style.display = 'flex';
        }

        // --- TARIFF DETAILS MODAL ---
        function generateTariffDetailsContent() {
            const contentDiv = document.getElementById('tariffDetailsContent');
            let html = '';

            // Household
            html += `<h4 class="text-xl font-bold mt-4 mb-2 text-primary-blue-darker" data-lang-key="tariff_household_title"></h4>`;
            html += `<ul class="list-disc list-inside space-y-1">`;
            tariffs.Household.forEach(tier => {
                const range = tier.limit === Infinity ? `1600+` : `${(tier.limit - 400 > 0 ? tier.limit - 399 : 0)} - ${tier.limit}`;
                html += `<li>${range} kWh: ${tier.rate} IQD/kWh</li>`;
            });
            html += `</ul>`;

            // Other categories
            const otherTariffs = {
                'Commercial': 'tariff_commercial_title',
                'Agriculture': 'tariff_agriculture_title',
                'Industrial': 'tariff_industrial_title',
                'Heavy Industry': 'tariff_heavy_industry_title',
                'State': 'tariff_state_title'
            };

            for (const category in otherTariffs) {
                html += `<h4 class="text-xl font-bold mt-4 mb-2 text-primary-blue-darker" data-lang-key="${otherTariffs[category]}"></h4>`;
                html += `<p>${tariffs[category]} IQD/kWh</p>`;
            }

            contentDiv.innerHTML = html;
            updateTextContent();
        }

        // --- MESSAGE BOX FUNCTIONALITY ---
        function showMessage(type, message) {
            const messageBox = document.getElementById('appMessage');
            messageBox.textContent = message;
            messageBox.className = `show ${type}`;
            
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all elements and sections
            const manualCalculateButton = document.getElementById('calculateManualButton');
            const meterCalculateButton = document.getElementById('calculateMeterButton');
            const deviceAddButton = document.getElementById('addDeviceButton');
            const deviceExportButton = document.getElementById('exportDeviceButton');
            const deviceImportButton = document.getElementById('importDeviceButton');
            const deviceClearButton = document.getElementById('clearDeviceButton');

            const manualReportButton = document.getElementById('manualReportButton');
            const meterReportButton = document.getElementById('meterReportButton');
            const deviceReportButton = document.getElementById('deviceReportButton');

            const showTariffDetailsButton = document.getElementById('showTariffDetailsButton');
            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffDetailsModal = document.getElementById('closeTariffDetailsModal');
            
            const reportModal = document.getElementById('reportModal');
            const closeReportModal = document.getElementById('closeReportModal');

            // Toggle buttons
            showManualButton.addEventListener('click', () => toggleCalculationMode('manual'));
            showMeterButton.addEventListener('click', () => toggleCalculationMode('meter'));
            showDeviceButton.addEventListener('click', () => toggleCalculationMode('device'));

            // Calculation buttons
            manualCalculateButton.addEventListener('click', performManualCalculation);
            meterCalculateButton.addEventListener('click', performMeterCalculation);
            deviceAddButton.addEventListener('click', () => addDeviceRow());
            deviceExportButton.addEventListener('click', exportDevices);
            deviceImportButton.addEventListener('click', importDevices);
            deviceClearButton.addEventListener('click', clearDevices);

            // Report buttons
            manualReportButton.addEventListener('click', () => showReportModal(manualCalculationData));
            meterReportButton.addEventListener('click', () => showReportModal(meterCalculationData));
            deviceReportButton.addEventListener('click', () => showReportModal(deviceCalculationData));

            // Input event listeners for real-time calculation
            document.querySelectorAll('#manualInputTypeDropdown, #manualInput, #categoryDropdown').forEach(element => {
                element.addEventListener('input', performManualCalculation);
            });
            document.querySelectorAll('#meterPrevReading, #meterCurrReading, #daysInput').forEach(element => {
                element.addEventListener('input', performMeterCalculation);
            });

            // Modal event listeners
            showTariffDetailsButton.addEventListener('click', () => {
                generateTariffDetailsContent();
                tariffDetailsModal.style.display = 'flex';
            });

            closeTariffDetailsModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none';
            });

            tariffDetailsModal.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                }
            });

            closeReportModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });

            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
            });

            // --- INITIALIZATION CALLS ---
            createConsumptionPieChart();
            startupPopulateDeviceTable(); // Populate table on load
            calculateDeviceConsumption(); // Calculate initial device consumption
            performManualCalculation(); // Perform initial manual calculation
            performMeterCalculation(); // Perform initial meter calculation
            setActiveLanguage('en'); // Set initial language and button state
            toggleCalculationMode('manual'); // Show the manual calculation section by default
            updateConsumptionPieChart(); // Initial chart update
        });
    </script>
</body>
</html>
