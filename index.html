<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runaki Assistant App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting (kept for potential future use, but not actively used in this version) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --secondary-green: #22c55e; /* A fresh green */
            --accent-orange: #f97316; /* A warm orange */
            --accent-purple: #8b5cf6; /* A soft purple */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --highlight-yellow: #facc15; /* Yellow for highlights */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c; /* Deep dark background */
            --card-dark: #2d3748; /* Slightly lighter dark for cards */
            --text-light: #e2e8f0; /* Light gray for main text */
            --text-medium-light: #a0aec0; /* Medium light gray for labels */
            --input-dark-bg: #4a5568; /* Darker input background */
            --input-dark-border: #6b7280; /* Darker input border */
            --result-item-dark-bg: #3c4a5c; /* Darker result item background */
            --result-item-dark-border: #5a6a7c; /* Darker result item border */
            --primary-blue-darker: #2563eb; /* A slightly darker blue for accents on dark background */
            --highlight-yellow-dark: #fbbf24; /* Brighter yellow for dark background */
            --error-red-dark: #ef4444; /* Keep error red, ensure visibility */
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Night mode background */
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--text-light); /* Night mode text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        h1 {
            color: var(--primary-blue-darker); /* Night mode heading color */
            font-weight: 800;
            margin-bottom: 2.5rem; /* Increased margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--text-light); /* Night mode heading color */
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            text-align: left;
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column; /* Always column layout */
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max-width for single column */
            background-color: var(--card-dark); /* Night mode card background */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); /* Stronger, diffused shadow for dark mode */
        }

        .section-card {
            background-color: var(--card-dark); /* Night mode card background */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light); /* Night mode label color */
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text color */
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker); /* Night mode focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Soft blue glow on focus for night mode */
            outline: none;
        }

        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: 1px solid var(--neutral-gray-medium); /* Added border for definition */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Default text color for buttons */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Default light gray background */
            width: 100%; /* Make buttons wide */
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker gray on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Even darker gray on active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr)); /* Slightly larger min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
        }

        .result-item {
            background-color: var(--result-item-dark-bg); /* Night mode result item background */
            border: 1px solid var(--result-item-dark-border); /* Night mode result item border */
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: var(--text-medium-light); /* Night mode result label color */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            color: var(--error-red-dark); /* Consistent strong red for emphasis in night mode */
            font-size: 1.25rem; /* Larger font for values */
            transition: background-color 0.2s ease-in-out; /* Smooth transition for flash */
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { background-color: transparent; }
            50% { background-color: var(--highlight-yellow-dark); } /* Flash brighter yellow in night mode */
            100% { background-color: transparent; }
        }

        .flash-animation {
            animation: flashEffect 0.6s ease-out; /* Apply animation */
        }

        /* Chart container styling (Not used in this version, but kept for reference) */
        .chart-container {
            width: 100%;
            height: 500px; 
            margin-top: 2rem; 
            background-color: var(--card-dark); 
            border-radius: 1rem;
            padding: 1.5rem; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        /* Slider styling (Not used in this version, but kept for reference) */
        .range-slider {
            width: 100%;
            height: 0.75rem; 
            background-color: #d1fae5; 
            border-radius: 0.4rem;
            appearance: none;
            cursor: grab;
            margin-top: 2rem; 
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1.8rem; 
            height: 1.8rem; 
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-moz-range-thumb {
            width: 1.8rem;
            height: 1.8rem;
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-moz-range-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        .range-slider::-moz-range-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 500px; /* Slightly taller table */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem;
            margin-bottom: 2rem; /* Increased margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Stronger shadow for dark mode */
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too narrow on small screens */
        }

        .device-table th, .device-table td {
            padding: 1rem 0.8rem; /* More padding */
            text-align: center;
            border-bottom: 1px solid var(--input-dark-border); /* Night mode border */
            font-size: 0.95rem; /* Slightly larger font */
        }

        .device-table th {
            background-color: var(--input-dark-bg); /* Night mode header background */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light); /* Night mode header text */
        }

        .device-table tbody tr:hover {
            background-color: #3a475c; /* Darker hover effect for table rows */
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640; /* Light blue highlight on dark background */
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker); /* Blue border on selected row */
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.4rem;
            text-align: center;
            font-size: 0.9rem;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text */
        }

        .device-table input[type="checkbox"] {
            width: 1.2rem; /* Slightly larger checkbox */
            height: 1.2rem;
            cursor: pointer;
            border-radius: 0.3rem;
            accent-color: var(--primary-blue-darker); /* Night mode checkbox accent */
        }

        .device-table .output-cell {
            background-color: #2a3a4c; /* Darker blue for output values */
            font-weight: 600;
            color: var(--primary-blue-darker); /* A subtle blue for output values */
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
        }

        /* Custom Modal for Tariff Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-dark); /* Night mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: var(--text-light); /* Night mode modal text */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light); /* Night mode close button color */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: var(--primary-blue-darker); /* Night mode close button hover */
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue-darker); /* Night mode modal heading color */
            margin-bottom: 1rem;
        }

        .modal-content pre {
            background-color: #1a202c; /* Deeper dark for code/preformatted text */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a0aec0; /* Lighter text for code */
        }

        /* Footer */
        footer {
            color: var(--text-medium-light); /* Night mode footer text */
        }
    </style>
</head>
<body>

    <h1 class="text-3xl lg:text-4xl">Runaki Assistant App</h1>

    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-8">

            <!-- 1. Manual Calculation -->
            <div class="section-card">
                <h2 class="text-xl">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household">Household</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Large Industry">Large Industry</option>
                        <option value="State">State</option>
                    </select>
                    <label for="manualInputTypeDropdown">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh">kWh</option>
                        <option value="Avg Amperes">Avg Amperes</option>
                        <option value="Given Bill">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn w-full">Calculate Bill</button>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="manualAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="manualReportButton" class="btn w-full mt-6">Generate Report</button>
            </div>

            <!-- 2. By Meter Calculation -->
            <div class="section-card">
                <h2 class="text-xl">2. By Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterPrevReading">Prev Reading:</label>
                    <input type="number" id="meterPrevReading" value="31051" class="w-24">
                    <label for="meterCurrReading">Curr Reading:</label>
                    <input type="number" id="meterCurrReading" value="31910" class="w-24">
                    <label for="daysInput">Days:</label>
                    <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16">
                </div>
                <button id="calculateMeterButton" class="btn w-full">Calculate Bill</button>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Amperes</div>
                        <div class="result-value" id="meterAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="meterReportButton" class="btn w-full mt-6">Generate Report</button>
            </div>

            <!-- 3. Budget Optimization -->
            <div class="section-card" id="budgetOptimizationSection" style="display: none;">
                <h2 class="text-xl">3. Budget Optimization</h2>
                <div class="input-group">
                    <select id="optimizationTargetDropdown" class="p-2 border rounded-md">
                        <option value="Target Cost">Target Cost</option>
                        <option value="Target Amperes">Target Amperes</option>
                        <option value="Target kWh">Target kWh</option>
                    </select>
                    <input type="number" id="budgetLimitInput" value="100000" class="w-32">
                </div>
                <button id="optimizeBudgetButton" class="btn w-full">Optimize Target</button>
                <div class="result-grid">
                    <div class="result-item col-span-full">
                        <div class="result-label">Optimization Result</div>
                        <div class="result-value" id="budgetResultLabel">Not Optimized</div>
                    </div>
                </div>
            </div>
            
            <!-- New buttons for showing/hiding sections -->
            <div class="flex flex-wrap justify-center gap-4 mt-6 p-4 border border-gray-700 rounded-lg bg-white">
                <button id="toggleBudgetOptimizationButton" class="btn w-full">Show Budget Optimization</button>
                <button id="toggleTableButton" class="btn w-full">Show Device Table</button>
                <button id="showTariffDetailsButton" class="btn w-full">Show Tariff Details</button>
            </div>

            <!-- 5. Device Consumption Table -->
            <div class="section-card flex-grow" id="deviceTableSection" style="display: none;">
                <h2 class="text-xl">5. Device Consumption Table</h2>
                <div class="device-table-container">
                    <table id="deviceTable" class="device-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Watt</th>
                                <th>Hours</th>
                                <th>Day</th>
                                <th>Count</th>
                                <th>kWh</th>
                                <th>IQD</th>
                                <th>On</th>
                                <th>Fixed</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-6">
                    <button id="addRowButton" class="btn">Add Row</button>
                    <button id="deleteRowButton" class="btn">Delete Selected</button>
                    <button id="saveTableButton" class="btn">Save Data</button>
                    <label for="loadFileInput" class="btn cursor-pointer">Load Data<input type="file" id="loadFileInput" accept=".json" class="hidden"></label>
                    <button id="clearAllButton" class="btn">Clear All</button>
                </div>
                <button id="deviceReportButton" class="btn w-full mt-6">Generate Report</button>
            </div>

        </div>
    </div>

    <footer class="mt-8 text-center text-neutral-gray-medium text-sm">
        <p>Created by Dr. Ismael Abdulrahman</p>
    </footer>

    <!-- Custom Modal for Tariff Details -->
    <div id="tariffDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeTariffDetailsModal">&times;</button>
            <h3 id="tariffDetailsModalTitle">Tariff Details</h3>
            <pre id="tariffDetailsModalContent"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL CONSTANTS ---
            const VOLTAGE = 220;
            const HOURS_PER_DAY = 24;

            // --- UI ELEMENTS ---
            const categoryDropdown = document.getElementById('categoryDropdown');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const manualInput = document.getElementById('manualInput');
            const calculateManualButton = document.getElementById('calculateManualButton');
            const manualReportButton = document.getElementById('manualReportButton');

            const manualKwhElem = document.getElementById('manualKwh');
            const manualAmperesElem = document.getElementById('manualAmperes');
            const manualBillElem = document.getElementById('manualBill');
            const manualAvgRateElem = document.getElementById('manualAvgRate');

            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const meterPrevReading = document.getElementById('meterPrevReading');
            const meterCurrReading = document.getElementById('meterCurrReading');
            const daysInput = document.getElementById('daysInput');

            const meterKwhElem = document.getElementById('meterKwh');
            const meterAmperesElem = document.getElementById('meterAmperes');
            const meterBillElem = document.getElementById('meterBill');
            const meterAvgRateElem = document.getElementById('meterAvgRate');
            const meterReportButton = document.getElementById('meterReportButton');

            const optimizeBudgetButton = document.getElementById('optimizeBudgetButton');
            const optimizationTargetDropdown = document.getElementById('optimizationTargetDropdown');
            const budgetLimitInput = document.getElementById('budgetLimitInput');
            const budgetResultLabel = document.getElementById('budgetResultLabel');

            const deviceTableBody = document.querySelector("#deviceTable tbody");
            const addRowButton = document.getElementById('addRowButton');
            const deleteRowButton = document.getElementById('deleteRowButton');
            const saveTableButton = document.getElementById('saveTableButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const clearAllButton = document.getElementById('clearAllButton');
            const deviceReportButton = document.getElementById('deviceReportButton');
            
            // New UI element references for toggling visibility
            const toggleBudgetOptimizationButton = document.getElementById('toggleBudgetOptimizationButton'); 
            const toggleTableButton = document.getElementById('toggleTableButton');
            const showTariffDetailsButton = document.getElementById('showTariffDetailsButton'); // New button reference

            const budgetOptimizationSection = document.getElementById('budgetOptimizationSection'); 
            const deviceTableSection = document.getElementById('deviceTableSection');

            // Modal elements
            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffDetailsModal = document.getElementById('closeTariffDetailsModal');
            const tariffDetailsModalTitle = document.getElementById('tariffDetailsModalTitle');
            const tariffDetailsModalContent = document.getElementById('tariffDetailsModalContent');

            let selectedTableRow = null; 

            // --- UTILITY FUNCTIONS ---
            const formatNumber = (value, decimalPlaces = 2, isCurrency = false, removeTrailingZeroDecimal = false) => {
                try {
                    const num = parseFloat(value);
                    if (isNaN(num)) return String(value);
                    if (isCurrency) return Math.round(num).toLocaleString('en-US');
                    if (removeTrailingZeroDecimal && num === parseInt(num)) return parseInt(num).toLocaleString('en-US');
                    return num.toLocaleString('en-US', {
                        minimumFractionDigits: decimalPlaces,
                        maximumFractionDigits: decimalPlaces,
                    });
                } catch (e) {
                    console.error("Error formatting number:", e);
                    return String(value);
                }
            };

            const validateNumeric = (textInput) => {
                if (typeof textInput !== 'string') textInput = String(textInput);
                const cleanInput = textInput.replace(/,/g, '');
                if (!cleanInput.trim()) return 0.0;
                const value = parseFloat(cleanInput);
                return isNaN(value) ? 0.0 : value;
            };

            const kwhToAmperes = (kwh, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (kwh * 1000) / (VOLTAGE * hoursTotal);
            };

            const amperesToKwh = (amperes, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (amperes * VOLTAGE * hoursTotal) / 1000;
            };

            // --- TARIFF CALCULATION LOGIC (KURDISTAN RUNAKI SYSTEM) ---
            const getRonakiHouseholdTariffDetails = (kWh) => {
                const tiers = [400, 800, 1200, 1600];
                const rates = [72, 108, 175, 265, 350];
                const slabNames = ["1-400 kWh", "401-800 kWh", "801-1200 kWh", "1201-1600 kWh", "1601+ kWh"];

                let totalCost = 0;
                let remainingKwh = kWh;
                const breakdown = [];
                let previousSlabLimit = 0;

                for (let i = 0; i < rates.length; i++) {
                    if (remainingKwh <= 0) break;

                    const slabRate = rates[i];
                    const slabLimit = (i < tiers.length) ? tiers[i] : Infinity;
                    const slabName = slabNames[i];

                    let consumptionInThisSlab = 0;
                    if (i === 0) {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit);
                    } else {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit - previousSlabLimit);
                    }

                    if (consumptionInThisSlab > 0) {
                        const costInThisSlab = consumptionInThisSlab * slabRate;
                        totalCost += costInThisSlab;
                        breakdown.push(`  - Slab ${i + 1} (${slabName}): ${formatNumber(consumptionInThisSlab, 2)} kWh @ ${formatNumber(slabRate, 2)} IQD/kWh = ${formatNumber(costInThisSlab, 0, true)} IQD`);
                    }
                    remainingKwh -= consumptionInThisSlab;
                    previousSlabLimit = slabLimit;
                }
                return { totalCost, breakdown: breakdown.join("\n") };
            };

            const getRonakiFlatTariffDetails = (kWh, rate) => {
                const totalCost = kWh * rate;
                const breakdown = `  - Consumption: ${formatNumber(kWh, 2)} kWh @ ${formatNumber(rate, 2)} IQD/kWh = ${formatNumber(totalCost, 0, true)} IQD`;
                return { totalCost, breakdown };
            };

            const calculateCostForCategory = (consumption, category) => {
                if (category === 'Household') {
                    return getRonakiHouseholdTariffDetails(consumption).totalCost;
                } else if (category === 'Commercial') {
                    return getRonakiFlatTariffDetails(consumption, 185).totalCost;
                } else if (category === 'Agriculture') {
                    return getRonakiFlatTariffDetails(consumption, 60).totalCost;
                } else if (category === 'Industrial') {
                    return getRonakiFlatTariffDetails(consumption, 160).totalCost;
                } else if (category === 'Large Industry') {
                    return getRonakiFlatTariffDetails(consumption, 125).totalCost;
                } else if (category === 'State') {
                    return getRonakiFlatTariffDetails(consumption, 160).totalCost;
                } else {
                    console.error(`Unknown category for cost calculation: ${category}`);
                    return NaN;
                }
            };

            // --- UI UPDATE FUNCTIONS ---

            const updateResultDisplay = (kwh, amperes, bill, avgRate, kwhElem, amperesElem, billElem, avgRateElem) => {
                // Apply flashing animation
                [kwhElem, amperesElem, billElem, avgRateElem].forEach(elem => {
                    elem.classList.remove('flash-animation'); // Remove existing animation
                    void elem.offsetWidth; // Trigger reflow to restart animation
                    elem.classList.add('flash-animation'); // Add animation
                });

                kwhElem.textContent = `${formatNumber(kwh, 2)} kWh`;
                amperesElem.textContent = `${formatNumber(amperes, 2)} A`;
                billElem.textContent = `${formatNumber(bill, 0, true)} IQD`;
                avgRateElem.textContent = `${formatNumber(avgRate, 2)} IQD/kWh`;
            };

            // --- MAIN CALCULATION HANDLER ---
            const performManualCalculation = () => {
                let inputValue = validateNumeric(manualInput.value);
                if (isNaN(inputValue) || inputValue < 0) {
                    alert("Please enter a valid numeric value for consumption.");
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem);
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;
                let calculatedKwh = 0;
                let calculatedAmperes = 0;
                let totalBill = 0;

                if (manualInputTypeDropdown.value === 'kWh') {
                    calculatedKwh = inputValue;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Avg Amperes') {
                    calculatedAmperes = inputValue;
                    calculatedKwh = amperesToKwh(calculatedAmperes, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Given Bill') {
                    const targetBill = inputValue;
                    let lowKwh = 0;
                    let highKwh = 50000; 
                    let foundKwh = 0;
                    const tolerance = 1.0;

                    for (let i = 0; i < 100; i++) { 
                        const midKwh = (lowKwh + highKwh) / 2;
                        const calculatedBillAtMid = calculateCostForCategory(midKwh, category);

                        if (Math.abs(calculatedBillAtMid - targetBill) < tolerance) {
                            foundKwh = midKwh;
                            break;
                        } else if (calculatedBillAtMid < targetBill) {
                            lowKwh = midKwh;
                        } else {
                            highKwh = midKwh;
                        }
                    }
                    calculatedKwh = foundKwh;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = targetBill; 
                }

                const avgRate = calculatedKwh > 0 ? totalBill / calculatedKwh : 0;

                updateResultDisplay(calculatedKwh, calculatedAmperes, totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem);
            };

            const performMeterCalculation = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0) {
                    alert("Please enter valid numeric values for meter readings.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }
                if (currReading < prevReading) {
                    alert("Current reading cannot be less than previous reading.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }
                if (isNaN(daysVal) || daysVal <= 0) {
                    alert("Please enter a positive integer for days.");
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;

                updateResultDisplay(consumption, avgAmperes, totalBill, avgRate, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem);
            };

            const calculateDeviceConsumption = () => {
                let totalKwh = 0;
                const deviceDetails = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const kwhOutputCell = row.querySelector('.output-kwh');
                    const iqdOutputCell = row.querySelector('.output-iqd');

                    if (!isOn) {
                        kwhOutputCell.textContent = '0.00';
                        iqdOutputCell.textContent = '0';
                        return;
                    }

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);

                    const kwh = (watt / 1000) * hours * day * count;
                    kwhOutputCell.textContent = formatNumber(kwh, 2);
                    totalKwh += kwh;
                    deviceDetails.push({ name: deviceName, kwh: kwh, row: row }); 
                });

                const totalBill = calculateCostForCategory(totalKwh, category);
                const avgRate = totalKwh > 0 ? totalBill / totalKwh : 0;

                deviceDetails.forEach(device => {
                    const iqd = device.kwh * avgRate;
                    device.row.querySelector('.output-iqd').textContent = formatNumber(iqd, 0, true);
                    device.iqd = iqd; 
                });
            };

            const optimizeForBudget = () => {
                let targetValue = validateNumeric(budgetLimitInput.value);
                if (isNaN(targetValue) || targetValue < 0) {
                    alert("Please enter a valid, non-negative numeric value for the target.");
                    budgetResultLabel.textContent = 'Invalid Target';
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                let currentTotalKwh = 0;
                let fixedDevicesKwh = 0;
                const variableDevicesData = [];
                const category = categoryDropdown.value;

                Array.from(deviceTableBody.children).forEach((row, idx) => {
                    const isOn = row.querySelector('.device-on').checked;
                    if (!isOn) return;

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;

                    const currentKwhDevice = (watt / 1000) * hours * day * count;
                    currentTotalKwh += currentKwhDevice;

                    if (isFixed) {
                        fixedDevicesKwh += currentKwhDevice;
                    } else {
                        variableDevicesData.push({
                            index: idx,
                            name: deviceName,
                            initialKwh: currentKwhDevice,
                            watt, hours, day, count,
                            row: row 
                        });
                    }
                });

                const currentBill = calculateCostForCategory(currentTotalKwh, category);
                const currentAmperes = kwhToAmperes(currentTotalKwh, daysVal);

                let targetKwhForOptimization = 0;
                if (optimizationTargetDropdown.value === 'Target Cost') {
                    if (currentBill > 0) {
                        targetKwhForOptimization = (targetValue / currentBill) * currentTotalKwh;
                    } else {
                        targetKwhForOptimization = targetValue / 100; 
                    }
                } else if (optimizationTargetDropdown.value === 'Target Amperes') {
                    targetKwhForOptimization = amperesToKwh(targetValue, daysVal);
                } else if (optimizationTargetDropdown.value === 'Target kWh') {
                    targetKwhForOptimization = targetValue;
                }

                if ((optimizationTargetDropdown.value === 'Target Cost' && currentBill <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target Amperes' && currentAmperes <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target kWh' && currentTotalKwh <= targetValue)) {
                    budgetResultLabel.textContent = 'Result: Within Target!';
                    alert('Your current status is already within the specified target!');
                    return;
                }

                variableDevicesData.sort((a, b) => b.initialKwh - a.initialKwh);

                let optimizedConsumptionKwh = currentTotalKwh;
                let changesMade = false;
                let summaryMessage = "Summary of Changes:\n";

                for (const device of variableDevicesData) {
                    if (optimizedConsumptionKwh <= targetKwhForOptimization) break; 

                    const kwhPerHour = (device.watt / 1000) * device.day * device.count;
                    if (kwhPerHour <= 0) continue;

                    let currentDeviceHours = validateNumeric(device.row.querySelector('input[type="number"]').value);

                    while (currentDeviceHours > 0) {
                        const testHours = Math.max(0, currentDeviceHours - 1); 
                        const kwhReducedByHour = (currentDeviceHours - testHours) * kwhPerHour;
                        const potentialNewTotalConsumption = optimizedConsumptionKwh - kwhReducedByHour;

                        let potentialNewBill = calculateCostForCategory(potentialNewTotalConsumption, category);
                        let potentialNewAmperes = kwhToAmperes(potentialNewTotalConsumption, daysVal);

                        let canReduceFurther = false;
                        if ((optimizationTargetDropdown.value === 'Target Cost' && potentialNewBill <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target Amperes' && potentialNewAmperes <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target kWh' && potentialNewTotalConsumption <= targetValue)) {
                            canReduceFurther = true;
                        }

                        if (canReduceFurther || testHours === 0) { 
                            const hoursReduced = currentDeviceHours - testHours;
                            if (hoursReduced > 0) {
                                device.row.querySelector('input[type="number"]').value = formatNumber(testHours, 1, false, true); 
                                optimizedConsumptionKwh = potentialNewTotalConsumption;
                                summaryMessage += `- Reduced '${device.name}' hours by ${formatNumber(hoursReduced, 0)} to ${formatNumber(testHours, 0)}.\n`;
                                changesMade = true;
                            }
                            break; 
                        } else {
                            currentDeviceHours = testHours; 
                        }
                    }
                }

                if (changesMade) {
                    budgetResultLabel.textContent = 'Result: Optimized!';
                    calculateDeviceConsumption(); 
                    alert(`Optimization completed successfully!\n${summaryMessage}`);
                } else {
                    budgetResultLabel.textContent = 'Result: Unreachable';
                    alert('Could not reach the target by only reducing hours of variable devices.\nConsider reducing usage days, number of devices, or increasing your target.');
                }
            };

            // --- DEVICE TABLE LOGIC ---
            const addTableRow = (deviceData = {}) => {
                const row = deviceTableBody.insertRow();
                const data = {
                    name: 'New Device', watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false, ...deviceData
                };

                row.innerHTML = `
                    <td><input type="text" value="${data.name}" class="device-input"></td>
                    <td><input type="number" value="${data.watt}" class="device-input"></td>
                    <td><input type="number" value="${data.hours}" class="device-input" min="0" max="24"></td>
                    <td><input type="number" value="${data.day}" class="device-input" min="0" max="31"></td>
                    <td><input type="number" value="${data.count}" class="device-input" min="0"></td>
                    <td class="output-kwh output-cell">0.00</td>
                    <td class="output-iqd output-cell">0</td>
                    <td><input type="checkbox" class="device-on" ${data.on ? 'checked' : ''}></td>
                    <td><input type="checkbox" class="device-fixed" ${data.fixed ? 'checked' : ''}></td>
                `;

                row.querySelector('.device-on').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelector('.device-fixed').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelectorAll('.device-input').forEach(input => {
                    input.addEventListener('change', () => calculateDeviceConsumption());
                });

                row.addEventListener('click', () => handleTableRowClick(row, Array.from(deviceTableBody.children).indexOf(row)));

                if (!data.on) row.classList.add('inactive'); 
            };

            const handleTableRowClick = (row, index) => {
                if (selectedTableRow) {
                    selectedTableRow.classList.remove('selected-row');
                }
                selectedTableRow = row;
                selectedTableRow.classList.add('selected-row');
            };

            const startupPopulateDeviceTable = () => {
                const sampleDevices = [
                    { name: 'LED TV', watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false },
                    { name: 'Refrigerator', watt: '125', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { name: 'Washing Machine', watt: '2000', hours: '2', day: '4', count: '1', on: true, fixed: false },
                    { name: 'LED Lighting', watt: '12', hours: '12', day: '30', count: '20', on: true, fixed: false },
                    { name: 'Freezer', watt: '150', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { name: 'Water Pump', watt: '500', hours: '1', day: '30', count: '1', on: true, fixed: false },
                    { name: 'Split AC (1 ton)', watt: '1000', hours: '4', day: '30', count: 1, on: true, fixed: false },
                ];
                sampleDevices.forEach(addTableRow);
            };

            // --- REPORT GENERATION FUNCTIONS ---
            const generateManualReport = () => {
                const kwh = validateNumeric(manualKwhElem.textContent);
                const bill = validateNumeric(manualBillElem.textContent);
                const category = categoryDropdown.value;
                if (kwh <= 0) { alert("Please perform a calculation first."); return; }
                const { breakdown } = getRonakiHouseholdTariffDetails(kwh); 
                alert(`Detailed Report (Manual Input)\n---------------------------------\nConsumption: ${manualKwhElem.textContent}\nAverage Amperes: ${manualAmperesElem.textContent}\nTotal Bill: ${manualBillElem.textContent}\nAverage Rate: ${manualAvgRateElem.textContent}\nCategory: ${category}\n\nTariff Breakdown:\n${breakdown}`);
            };

            const generateMeterReport = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0 || currReading < prevReading || isNaN(daysVal) || daysVal <= 0) {
                    alert("Please ensure valid meter readings and days are entered before generating a report.");
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;

                let reportContent = `Detailed Report (Meter Input)\n---------------------------------\n`;
                reportContent += `Previous Reading: ${formatNumber(prevReading, 0, true)} kWh\n`;
                reportContent += `Current Reading: ${formatNumber(currReading, 0, true)} kWh\n`;
                reportContent += `Days: ${formatNumber(daysVal, 0, false, true)}\n`;
                reportContent += `Consumption: ${formatNumber(consumption, 2)} kWh\n`;
                reportContent += `Average Amperes: ${formatNumber(avgAmperes, 2)} A\n`;
                reportContent += `Total Bill: ${formatNumber(totalBill, 0, true)} IQD\n`;
                reportContent += `Average Rate: ${formatNumber(avgRate, 2)} IQD/kWh\n`;
                reportContent += `Category: ${category}\n\n`;

                if (category === 'Household') {
                    const { breakdown } = getRonakiHouseholdTariffDetails(consumption);
                    reportContent += `Tariff Breakdown:\n${breakdown}`;
                } else {
                    const { breakdown } = getRonakiFlatTariffDetails(consumption, totalBill / consumption);
                    reportContent += `Tariff Breakdown:\n${breakdown}`;
                }
                alert(reportContent);
            };

            const generateDeviceReport = () => {
                let totalKwh = 0;
                const deviceDetailsForReport = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;
                    const kwh = (watt / 1000) * hours * day * count;
                    
                    // Only sum kwh for devices that are "on"
                    if (isOn) {
                        totalKwh += kwh; 
                    }

                    deviceDetailsForReport.push({
                        name: deviceName,
                        watt: formatNumber(watt, 0, false, true),
                        hours: formatNumber(hours, 1, false, true),
                        day: formatNumber(day, 0, false, true),
                        count: formatNumber(count, 0, false, true),
                        kwh: formatNumber(kwh, 2),
                        on: isOn ? 'Yes' : 'No',
                        fixed: isFixed ? 'Yes' : 'No'
                    });
                });

                if (totalKwh <= 0 && deviceDetailsForReport.length === 0) {
                    alert("Please add and calculate device consumption before generating a report.");
                    return;
                }
                
                // Recalculate total bill and average rate based on the final totalKwh
                const finalTotalBill = calculateCostForCategory(totalKwh, category);
                const finalAvgRate = totalKwh > 0 ? finalTotalBill / totalKwh : 0;
                const finalAvgAmperes = kwhToAmperes(totalKwh, daysVal);

                let reportContent = `Detailed Report (Device Consumption)\n---------------------------------\n`;
                reportContent += `Total Consumption: ${formatNumber(totalKwh, 2)} kWh\n`;
                reportContent += `Total Bill: ${formatNumber(finalTotalBill, 0, true)} IQD\n`;
                reportContent += `Average Amperes: ${formatNumber(finalAvgAmperes, 2)} A\n`;
                reportContent += `Average Rate: ${formatNumber(finalAvgRate, 2)} IQD/kWh\n`;
                reportContent += `Category: ${category}\n\n`;
                reportContent += `Device Breakdown:\n`;

                deviceDetailsForReport.forEach(device => {
                    // Recalculate IQD for each device based on the final average rate
                    const iqd = validateNumeric(device.kwh) * finalAvgRate;
                    reportContent += `- ${device.name}: ${device.watt}W, ${device.hours}h/day, ${device.day} days, ${device.count} units -> ${device.kwh} kWh (${formatNumber(iqd, 0, true)} IQD) [On: ${device.on}, Fixed: ${device.fixed}]\n`;
                });

                alert(reportContent);
            };


            // --- EVENT LISTENERS ---
            manualInputTypeDropdown.addEventListener('change', (e) => {
                const type = e.target.value;
                if (type === 'kWh') manualInput.value = '1891';
                else if (type === 'Avg Amperes') manualInput.value = '12';
                else if (type === 'Given Bill') manualInput.value = '100000';
                performManualCalculation();
            });

            calculateManualButton.addEventListener('click', performManualCalculation);
            manualInput.addEventListener('change', performManualCalculation); 
            manualInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performManualCalculation(); });
            categoryDropdown.addEventListener('change', () => {
                performManualCalculation();
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption(); 
                }
            });

            calculateMeterButton.addEventListener('click', performMeterCalculation);
            meterPrevReading.addEventListener('change', performMeterCalculation);
            meterPrevReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            meterCurrReading.addEventListener('change', performMeterCalculation);
            meterCurrReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            daysInput.addEventListener('change', () => {
                performManualCalculation(); 
                performMeterCalculation(); 
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption(); 
                }
            });
            daysInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') {
                performManualCalculation();
                performMeterCalculation();
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption();
                }
            }});

            manualReportButton.addEventListener('click', generateManualReport);
            meterReportButton.addEventListener('click', generateMeterReport);
            deviceReportButton.addEventListener('click', generateDeviceReport); // Event listener for new button

            addRowButton.addEventListener('click', () => {
                addTableRow();
                calculateDeviceConsumption();
            });
            deleteRowButton.addEventListener('click', () => {
                if (selectedTableRow) {
                    selectedTableRow.remove();
                    selectedTableRow = null; 
                    calculateDeviceConsumption();
                } else {
                    alert('Please select a row to delete.');
                }
            });
            clearAllButton.addEventListener('click', () => {
                deviceTableBody.innerHTML = '';
                startupPopulateDeviceTable();
                calculateDeviceConsumption();
                alert("All device data has been cleared and reset to default.");
            });
            saveTableButton.addEventListener('click', () => {
                const data = [];
                Array.from(deviceTableBody.children).forEach(row => {
                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    data.push({
                        name: inputs[0].value,
                        watt: inputs[1].value,
                        hours: inputs[2].value,
                        day: inputs[3].value,
                        count: inputs[4].value,
                        on: row.querySelector('.device-on').checked,
                        fixed: row.querySelector('.device-fixed').checked,
                    });
                });
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "devices_runaki.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                alert("Device data saved successfully!");
            });

            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    try {
                        const loadedData = JSON.parse(readerEvent.target.result);
                        if (Array.isArray(loadedData) && loadedData.every(item => typeof item === 'object' && 'name' in item && 'watt' in item)) {
                            deviceTableBody.innerHTML = ''; 
                            loadedData.forEach(addTableRow);
                            calculateDeviceConsumption();
                            alert("Device data loaded successfully!");
                        } else {
                            throw new Error("Invalid data format in file.");
                        }
                    } catch (error) {
                        alert(`Error loading data: ${error.message}. Please ensure it's a valid JSON file.`);
                        console.error("Error loading data:", error);
                    }
                };
                reader.readAsText(file);
            });

            // Budget Optimization
            optimizationTargetDropdown.addEventListener('change', () => {
                const target = optimizationTargetDropdown.value;
                if (target === 'Target Cost') budgetLimitInput.value = '100000';
                else if (target === 'Target Amperes') budgetLimitInput.value = '12';
                else if (target === 'Target kWh') budgetLimitInput.value = '1891';
                budgetResultLabel.textContent = 'Result: Not Optimized';
            });
            optimizeBudgetButton.addEventListener('click', optimizeForBudget);
            budgetLimitInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') optimizeForBudget(); });


            // Toggle Budget Optimization Section
            toggleBudgetOptimizationButton.addEventListener('click', () => {
                const isVisible = budgetOptimizationSection.style.display === 'block';
                budgetOptimizationSection.style.display = isVisible ? 'none' : 'block';
                toggleBudgetOptimizationButton.textContent = isVisible ? 'Show Budget Optimization' : 'Hide Budget Optimization';
                if (!isVisible) {
                    // If showing, ensure initial calculation is run
                    optimizeForBudget();
                }
            });

            // Toggle Device Table Button
            toggleTableButton.addEventListener('click', () => {
                const isVisible = deviceTableSection.style.display === 'block';
                deviceTableSection.style.display = isVisible ? 'none' : 'block';
                toggleTableButton.textContent = isVisible ? 'Show Device Table' : 'Hide Device Table';
                if (!isVisible) {
                    calculateDeviceConsumption(); 
                }
            });

            // Show Tariff Details Button
            showTariffDetailsButton.addEventListener('click', () => {
                const currentCategory = categoryDropdown.value;
                let details = '';

                if (currentCategory === 'Household') {
                    details = `Household Tariff Rates:\n` +
                              `  - 1-400 kWh: 72 IQD/kWh\n` +
                              `  - 401-800 kWh: 108 IQD/kWh\n` +
                              `  - 801-1200 kWh: 175 IQD/kWh\n` +
                              `  - 1201-1600 kWh: 265 IQD/kWh\n` +
                              `  - 1601+ kWh: 350 IQD/kWh`;
                } else if (currentCategory === 'Commercial') {
                    details = `Commercial Tariff Rate:\n` +
                              `  - All kWh: 185 IQD/kWh`;
                } else if (currentCategory === 'Agriculture') {
                    details = `Agriculture Tariff Rate:\n` +
                              `  - All kWh: 60 IQD/kWh`;
                } else if (currentCategory === 'Industrial') {
                    details = `Industrial Tariff Rate:\n` +
                              `  - All kWh: 160 IQD/kWh`;
                } else if (currentCategory === 'Large Industry') {
                    details = `Large Industry Tariff Rate:\n` +
                              `  - All kWh: 125 IQD/kWh`;
                } else if (currentCategory === 'State') {
                    details = `State Tariff Rate:\n` +
                              `  - All kWh: 160 IQD/kWh`;
                }

                tariffDetailsModalTitle.textContent = `${currentCategory} Tariff Details`;
                tariffDetailsModalContent.textContent = details;
                tariffDetailsModal.style.display = 'flex'; // Show the modal
            });

            closeTariffDetailsModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none'; // Hide the modal
            });

            // Close modal if clicked outside content
            tariffDetailsModal.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                }
            });


            // --- INITIALIZATION CALLS ---
            startupPopulateDeviceTable(); // Populate table on load
            calculateDeviceConsumption(); // Calculate initial device consumption
            performManualCalculation(); // Perform initial manual calculation
            performMeterCalculation(); // Perform initial meter calculation
        });
    </script>
</body>
</html>
